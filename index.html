<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <title>Plumbing Bid Worksheet - Click Plumbing and Electrical</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --primary: #003366;
      --secondary: #0066CC;
      --bg: #F5F5F5;
      --text: #333333;
      --card-bg: #ffffff;
      --border: #ddd;
      --error: #c00;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      color: var(--text);
      background: var(--bg);
      padding: 1rem;
    }
    .container { max-width: 960px; margin: 0 auto; }
    .app-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    h1, h2, h3 { color: var(--primary); margin-top: 0; }
    h2 { font-size: 1.25rem; border-bottom: 2px solid var(--secondary); padding-bottom: 0.25rem; margin-bottom: 1rem; }
    .section {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .section.section-takeoff { background: #f0f0f0; }
    .section-rough-calculator { background: #fffde7; }
    .section-rough-calculator.hidden { display: none; }
    .section-rough-calculator .field.field-disabled { opacity: 0.65; color: #666; }
    .section-rough-calculator .field.field-disabled input { cursor: not-allowed; }
    .rough-calc-dimensions-row { align-items: flex-end; }
    .rough-calc-op { font-size: 1.25rem; font-weight: 600; color: var(--primary); padding: 0 0.25rem; margin-bottom: 0.5rem; }
    .section-rough-calculator .rough-calc-cost-input { width: calc((100% - 2rem - 4ch) / 3); max-width: 100%; box-sizing: border-box; }
    label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
    input[type="text"], input[type="number"], input[type="date"], select, textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 2px rgba(0,102,204,0.2);
    }
    input.error, select.error, textarea.error { border-color: var(--error); }
    .form-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .form-row .field { flex: 1; min-width: 0; }
    .fixture-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }
    .fixture-item { display: flex; flex-direction: column; }
    .fixture-item label { font-size: 0.875rem; }
    .number-input-wrap { display: flex; align-items: center; gap: 0.25rem; }
    .number-input-wrap input { width: 4rem; text-align: center; }
    .number-input-wrap button {
      width: 2rem; height: 2rem;
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
      color: var(--primary);
    }
    .number-input-wrap button:hover { background: #e0e0e0; }
    .takeoff-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
    .takeoff-row .takeoff-desc { flex: 2; min-width: 0; }
    .takeoff-row .takeoff-qty { flex: 1; min-width: 80px; }
    .takeoff-row button { flex-shrink: 0; padding: 0.5rem; cursor: pointer; border: 1px solid var(--border); background: #fff; border-radius: 6px; color: var(--error); }
    .additional-labor-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
    .additional-labor-row .additional-labor-desc { flex: 2; min-width: 0; }
    .additional-labor-row .additional-labor-hours { flex: 0 0 5rem; max-width: 6rem; }
    .additional-labor-row .additional-labor-crew { flex: 0 0 4rem; max-width: 4rem; }
    .additional-labor-row .additional-labor-rate { flex: 0 0 5.5rem; max-width: 6rem; }
    .additional-labor-row .additional-labor-remove { flex-shrink: 0; padding: 0.5rem; cursor: pointer; border: 1px solid var(--border); background: #fff; border-radius: 6px; color: var(--error); }
    .additional-labor-header { display: flex; gap: 0.5rem; margin-bottom: 0.25rem; align-items: center; font-size: 0.875rem; font-weight: 500; color: #555; }
    .additional-labor-header .additional-labor-hdr-desc { flex: 2; min-width: 0; }
    .additional-labor-header .additional-labor-hdr-hours { flex: 0 0 5rem; max-width: 6rem; text-align: center; }
    .additional-labor-header .additional-labor-hdr-crew { flex: 0 0 4rem; max-width: 4rem; text-align: center; }
    .additional-labor-header .additional-labor-hdr-rate { flex: 0 0 5.5rem; max-width: 6rem; text-align: center; }
    .additional-labor-header .additional-labor-hdr-remove { flex-shrink: 0; width: 5rem; }
    .additional-material-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
    .additional-material-row .additional-material-desc { flex: 2; min-width: 0; }
    .additional-material-row .additional-material-amount { flex: 0 0 6rem; max-width: 7rem; }
    .additional-material-row .additional-material-remove { flex-shrink: 0; padding: 0.5rem; cursor: pointer; border: 1px solid var(--border); background: #fff; border-radius: 6px; color: var(--error); }
    .additional-material-header { display: flex; gap: 0.5rem; margin-bottom: 0.25rem; align-items: center; font-size: 0.875rem; font-weight: 500; color: #555; }
    .additional-material-header .additional-material-hdr-desc { flex: 2; min-width: 0; }
    .additional-material-header .additional-material-hdr-amount { flex: 0 0 6rem; max-width: 7rem; text-align: center; }
    .additional-material-header .additional-material-hdr-remove { flex-shrink: 0; width: 5rem; }
    .actions { display: flex; flex-wrap: wrap; gap: 0.75rem; margin: 1.5rem 0; align-items: flex-start; }
    .actions .btn-push-right { margin-left: auto; }
    .internal-summary-box { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 1rem 1.25rem; text-align: center; }
    .internal-summary-box .internal-summary-title { font-size: 1rem; margin: 0 0 0.75rem 0; color: var(--primary); font-weight: 600; }
    .internal-summary-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; }
    .btn {
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.05s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #002244; }
    .btn-secondary { background: var(--secondary); color: #fff; }
    .btn-secondary:hover { background: #0052a3; }
    .btn-outline { background: #fff; color: var(--primary); border: 2px solid var(--primary); }
    .btn-outline:hover { background: var(--bg); }
    #preview {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 2rem;
      margin-top: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }
    #preview.visible { display: block; }
    .preview-header { text-align: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--primary); }
    .preview-header h1 { font-size: 1.5rem; margin: 0; }
    .preview-logo { width: 80px; height: 80px; margin: 0 auto 0.5rem; }
    .preview-logo svg { width: 100%; height: 100%; display: block; }
    .preview-meta { font-size: 0.9rem; color: #666; }
    .preview-section { margin-bottom: 1.25rem; }
    .preview-section h3 { font-size: 1rem; margin-bottom: 0.5rem; color: var(--primary); }
    .preview-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .preview-table th, .preview-table td { border: 1px solid var(--border); padding: 0.5rem 0.75rem; text-align: left; }
    .preview-table th { background: var(--bg); font-weight: 600; }
    .grand-total { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-top: 1rem; padding: 1rem; background: var(--bg); border-radius: 8px; text-align: right; }
    .fixture-header-row { display: flex; flex-wrap: wrap; align-items: flex-end; justify-content: space-between; gap: 1rem; margin-bottom: 1rem; }
    .fixture-header-row h2 { margin-bottom: 0; }
    .fixture-plan-page-wrap { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
    .fixture-plan-page-wrap label { margin-bottom: 0; margin-right: 0; }
    .fixture-plan-page-wrap input { width: auto; min-width: 140px; max-width: 200px; }
    .fixture-section-wrap { display: flex; gap: 1.5rem; align-items: flex-start; }
    .fixture-form-col { flex: 1; min-width: 0; }
    .fixture-ledger-col { flex: 0 0 280px; background: var(--bg); border-radius: 8px; padding: 1rem; border: 1px solid var(--border); }
    .fixture-ledger-col h3 { font-size: 1rem; margin-bottom: 0.75rem; }
    .fixture-ledger-list { max-height: 400px; overflow-y: auto; }
    .fixture-ledger-item { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
    .fixture-ledger-item:last-child { border-bottom: none; }
    .fixture-ledger-item-name { font-weight: 500; flex: 1 1 100%; }
    .fixture-ledger-item-meta { font-size: 0.8rem; color: #666; margin-bottom: 0.25rem; }
    .fixture-ledger-item-actions { display: flex; gap: 0.35rem; }
    .fixture-ledger-item-actions .btn { padding: 0.35rem 0.6rem; font-size: 0.85rem; }
    .fixture-ledger-empty { color: #666; font-size: 0.9rem; padding: 0.5rem 0; }
    .fixture-price-reference { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); }
    .fixture-price-details { border: 1px solid var(--border); border-radius: 8px; padding: 0 0.75rem 0 0; }
    .fixture-price-details[open] { padding-bottom: 0.75rem; }
    .fixture-price-summary { font-size: 1rem; font-weight: 600; color: var(--primary); cursor: pointer; padding: 0.5rem 0; list-style: none; user-select: none; }
    .fixture-price-summary::-webkit-details-marker { display: none; }
    .fixture-price-summary::before { content: '▸ '; display: inline-block; transition: transform 0.2s; }
    .fixture-price-details[open] .fixture-price-summary::before { transform: rotate(90deg); }
    .fixture-price-details-content { margin-top: 0.5rem; }
    .fixture-labor-details { border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; }
    .fixture-labor-summary { padding: 0; margin: 0; }
    .fixture-labor-breakdown { margin-top: 0.5rem; font-size: 0.9rem; color: #555; }
    .fixture-labor-breakdown p { margin: 0.25rem 0; }
    .fixture-cost-toggle { cursor: pointer; }
    .crew-pricing-link { background: none; border: none; padding: 0; font: inherit; color: var(--secondary); cursor: pointer; text-decoration: underline; }
    .additional-labor-title-row .crew-pricing-link { margin-left: auto; }
    .crew-pricing-link:hover { color: #004499; }
    .additional-labor-title-row { display: flex; flex-wrap: wrap; align-items: flex-start; gap: 1rem; margin-bottom: 0; }
    .additional-labor-title-row > p { flex: 1; min-width: 0; }
    .additional-labor-title-row .crew-pricing-details { flex-shrink: 0; margin: 0; }
    #crewPricingDetails .fixture-price-details-content label { display: inline-block; min-width: 4rem; text-align: center; }
    #crewPricingDetails summary { display: none; }
    .fixture-price-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .fixture-price-table th, .fixture-price-table td { border: 1px solid var(--border); padding: 0.4rem 0.6rem; text-align: left; }
    .fixture-price-table th { background: var(--bg); font-weight: 600; }
    .fixture-price-table tbody tr:nth-child(even) { background: rgba(0,0,0,0.03); }
    .fixture-price-input { width: 4.5rem; max-width: 100%; padding: 0.35rem 0.5rem; font-size: 0.9rem; border: 1px solid var(--border); border-radius: 6px; }
    .fixture-price-table .fixture-price-input { box-sizing: border-box; }
    .fixture-mode-row { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin: 0.25rem 0 0.75rem 0; font-size: 0.9rem; }
    .fixture-mode-row label { margin-bottom: 0; font-weight: 500; }
    .fixture-mode-select { min-width: 140px; }
    .fixture-mode-status { margin-left: auto; font-weight: 600; color: var(--primary); }
    .fixture-price-details.fixture-mode-trace { border-color: #e09f3e; box-shadow: 0 0 0 1px rgba(224,159,62,0.4); }
    .fixture-price-details.fixture-mode-trace .fixture-price-summary { color: #9a4a00; }
    .fixture-mode-status-trace { color: #9a4a00; }
    .external-summary-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.4);
      padding: 1rem;
    }
    .external-summary-modal.visible { display: flex; }
    .external-summary-modal-panel {
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
      max-width: 560px;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .external-summary-modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); font-size: 1.1rem; font-weight: 600; color: var(--primary); }
    .external-summary-modal-body { padding: 1.25rem; }
    .external-summary-modal-body .external-summary-notes-label { display: block; margin-bottom: 0.35rem; font-weight: 500; color: var(--primary); }
    .external-summary-modal-body #externalSummaryNotes { min-height: 80px; margin-bottom: 1rem; }
    .external-summary-modal-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; padding: 1rem 1.25rem; border-top: 1px solid var(--border); }
    .external-summary-print-notes { display: none; margin-top: 0.75rem; padding: 0.5rem 0; border-top: 1px solid var(--border); font-size: 0.9rem; white-space: pre-wrap; }
    @media print {
      body.print-external-summary .container { display: none !important; }
      body.print-external-summary .external-summary-modal { display: flex !important; background: #fff; padding: 0; }
      body.print-external-summary .external-summary-modal-panel { max-height: none; box-shadow: none; border: none; }
      body.print-external-summary .external-summary-modal-actions { display: none !important; }
      body.print-external-summary .external-summary-print-notes { display: block !important; }
      body.print-external-summary #externalSummaryNotes { display: none !important; }
    }
    @media (max-width: 768px) {
      body { padding: 0.75rem; }
      .section { padding: 1rem; }
      .btn { min-height: 44px; padding: 0.875rem 1.25rem; }
      .number-input-wrap button { min-width: 44px; min-height: 44px; }
    }
    @media (max-width: 640px) {
      .form-row { flex-direction: column; }
      .fixture-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
      .takeoff-row { flex-wrap: wrap; }
      .additional-labor-row { flex-wrap: wrap; }
      .additional-labor-header { flex-wrap: wrap; }
      .additional-material-row { flex-wrap: wrap; }
      .additional-material-header { flex-wrap: wrap; }
      .actions { flex-direction: column; }
      .actions .btn { width: 100%; }
      .fixture-section-wrap { flex-direction: column; }
      .fixture-ledger-col { flex: 1 1 100%; max-width: none; }
      .fixture-header-row { flex-direction: column; align-items: stretch; }
      .fixture-plan-page-wrap input { max-width: none; }
    }
    @media print {
      body { background: #fff; padding: 0; }
      .no-print { display: none !important; }
      #preview { display: block !important; box-shadow: none; padding: 0; }
      .section { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="app-top-bar no-print">
      <button type="button" id="shareViaUrlBtn" class="btn btn-outline">Share via URL</button>
      <button type="button" id="fillSample" class="btn btn-outline">Fill with sample</button>
    </div>
    <form id="bidForm" class="no-print">
      <div class="section">
        <h2>Job Information</h2>
        <div class="form-row">
          <div class="field">
            <label for="customerName">Customer Name *</label>
            <input type="text" id="customerName" name="customerName" required placeholder="Customer name">
          </div>
          <div class="field">
            <label for="customerAddress">Customer Address</label>
            <textarea id="customerAddress" name="customerAddress" rows="2" placeholder="Street, City, State ZIP (optional)"></textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="jobName">Job Name</label>
            <input type="text" id="jobName" name="jobName" placeholder="e.g. Kitchen remodel (optional)">
          </div>
          <div class="field">
            <label for="jobAddress">Job Address *</label>
            <textarea id="jobAddress" name="jobAddress" rows="2" required placeholder="Street, City, State ZIP"></textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="bidDate">Bid Date *</label>
            <input type="date" id="bidDate" name="bidDate" required>
          </div>
          <div class="field">
            <label for="bidNumber">Bid Number *</label>
            <input type="text" id="bidNumber" name="bidNumber" required placeholder="e.g. 2024-001">
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="planName">Plan Name</label>
            <input type="text" id="planName" name="planName" placeholder="Plan name">
          </div>
          <div class="field">
            <label for="planIssueDate">Plan Issue Date</label>
            <input type="date" id="planIssueDate" name="planIssueDate">
          </div>
          <div class="field">
            <label for="planTitle">Plan Title</label>
            <input type="text" id="planTitle" name="planTitle" placeholder="Plan title">
          </div>
        </div>
      </div>

      <div class="section" id="fixtureCountsSection">
        <div class="fixture-header-row">
          <h2>Fixture Counts</h2>
          <div class="fixture-plan-page-wrap">
            <label for="fixturePlanPageName">Plan page:</label>
            <input type="text" id="fixturePlanPageName" name="fixturePlanPageName" placeholder="e.g. A-101, Floor 2">
            <button type="button" id="saveToLedger" class="btn btn-secondary">Save to ledger</button>
          </div>
        </div>
        <div class="fixture-section-wrap">
          <div class="fixture-form-col">
        <p><strong>Total fixtures: <span id="totalFixtures">0</span></strong></p>
        <h3>Bathrooms</h3>
        <div class="fixture-grid" id="fixturesBathrooms">
          <div class="fixture-item">
            <label for="fixtureToilets">Toilets</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureToilets">−</button>
              <input type="number" id="fixtureToilets" name="fixtureToilets" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureToilets">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureBathSinks">Bathroom sinks</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureBathSinks">−</button>
              <input type="number" id="fixtureBathSinks" name="fixtureBathSinks" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureBathSinks">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureShowerTub">Shower/tub combos</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureShowerTub">−</button>
              <input type="number" id="fixtureShowerTub" name="fixtureShowerTub" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureShowerTub">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureShowerOnly">Shower only</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureShowerOnly">−</button>
              <input type="number" id="fixtureShowerOnly" name="fixtureShowerOnly" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureShowerOnly">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureTubs">Bathtubs</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureTubs">−</button>
              <input type="number" id="fixtureTubs" name="fixtureTubs" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureTubs">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureUrinals">Urinals</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureUrinals">−</button>
              <input type="number" id="fixtureUrinals" name="fixtureUrinals" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureUrinals">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWaterClosets">Water closets</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWaterClosets">−</button>
              <input type="number" id="fixtureWaterClosets" name="fixtureWaterClosets" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWaterClosets">+</button>
            </div>
          </div>
        </div>
        <h3>Kitchen</h3>
        <div class="fixture-grid">
          <div class="fixture-item">
            <label for="fixtureKitchenSinks">Kitchen sinks</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureKitchenSinks">−</button>
              <input type="number" id="fixtureKitchenSinks" name="fixtureKitchenSinks" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureKitchenSinks">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureDisposals">Garbage disposals</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureDisposals">−</button>
              <input type="number" id="fixtureDisposals" name="fixtureDisposals" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureDisposals">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureIceMakers">Ice makers</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureIceMakers">−</button>
              <input type="number" id="fixtureIceMakers" name="fixtureIceMakers" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureIceMakers">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixturePotFiller">Pot filler</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixturePotFiller">−</button>
              <input type="number" id="fixturePotFiller" name="fixturePotFiller" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixturePotFiller">+</button>
            </div>
          </div>
        </div>
        <h3>Laundry</h3>
        <div class="fixture-grid">
          <div class="fixture-item">
            <label for="fixtureLaundrySinks">Laundry sinks</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureLaundrySinks">−</button>
              <input type="number" id="fixtureLaundrySinks" name="fixtureLaundrySinks" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureLaundrySinks">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWashingMachine">Washing machine</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWashingMachine">−</button>
              <input type="number" id="fixtureWashingMachine" name="fixtureWashingMachine" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWashingMachine">+</button>
            </div>
          </div>
        </div>
        <h3>Plumbing Fixtures</h3>
        <div class="fixture-grid">
          <div class="fixture-item">
            <label for="fixtureHoseBibs">Hose bibs</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureHoseBibs">−</button>
              <input type="number" id="fixtureHoseBibs" name="fixtureHoseBibs" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureHoseBibs">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWaterFountain">Water fountain</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWaterFountain">−</button>
              <input type="number" id="fixtureWaterFountain" name="fixtureWaterFountain" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWaterFountain">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureGasDrops">Gas drops</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureGasDrops">−</button>
              <input type="number" id="fixtureGasDrops" name="fixtureGasDrops" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureGasDrops">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureFloorDrains">Floor drains</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureFloorDrains">−</button>
              <input type="number" id="fixtureFloorDrains" name="fixtureFloorDrains" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureFloorDrains">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureDogWash">Dog wash</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureDogWash">−</button>
              <input type="number" id="fixtureDogWash" name="fixtureDogWash" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureDogWash">+</button>
            </div>
          </div>
        </div>
        <h3>Appliances</h3>
        <div class="fixture-grid">
          <div class="fixture-item">
            <label for="fixtureWHGas">Water heaters (gas)</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWHGas">−</button>
              <input type="number" id="fixtureWHGas" name="fixtureWHGas" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWHGas">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWHElectric">Water heaters (electric)</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWHElectric">−</button>
              <input type="number" id="fixtureWHElectric" name="fixtureWHElectric" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWHElectric">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWHTankless">Water heaters (tankless)</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWHTankless">−</button>
              <input type="number" id="fixtureWHTankless" name="fixtureWHTankless" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWHTankless">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWaterSoftener">Water softener</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWaterSoftener">−</button>
              <input type="number" id="fixtureWaterSoftener" name="fixtureWaterSoftener" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWaterSoftener">+</button>
            </div>
          </div>
        </div>
          </div>
          <div class="fixture-ledger-col">
            <h3>Plan pages</h3>
            <div id="fixtureLedgerList" class="fixture-ledger-list"></div>
            <button type="button" id="exportCoverPage" class="btn btn-outline" style="margin-top: 0.75rem;">Export cover page</button>
          </div>
        </div>
        <p style="margin-top: 1rem; margin-bottom: 0;">
          <button type="button" id="clearFixtureCounts" class="btn btn-outline">Clear counts</button>
        </p>
        <div class="fixture-price-reference">
          <details class="fixture-price-details" id="fixturePriceDetails">
            <summary class="fixture-price-summary">Fixture Prices and Labor</summary>
            <div class="fixture-price-details-content">
          <div class="fixture-mode-row">
            <label for="fixtureModeSelect">Fixture mode:</label>
            <select id="fixtureModeSelect" class="fixture-mode-select">
              <option value="Malachi">Malachi (default)</option>
              <option value="Trace">Trace</option>
            </select>
            <span id="fixtureModeStatus" class="fixture-mode-status"></span>
          </div>
          <table class="fixture-price-table" id="fixturePriceTable" aria-label="Fixture prices and labor">
            <thead>
              <tr>
                <th>Fixture</th>
                <th>Price</th>
                <th>Rough in</th>
                <th>Top out</th>
                <th>Trim</th>
              </tr>
            </thead>
            <tbody id="fixturePriceTableBody"></tbody>
          </table>
          <button type="button" id="resetFixturePrices" class="btn btn-outline" style="margin-top: 0.75rem;">Reset to default</button>
            </div>
          </details>
        </div>
      </div>

      <div class="section section-takeoff">
        <h2>Fixture Materials (coming soon from <a href="https://pipetooling.com" target="_blank" rel="noopener noreferrer">PipeTooling.com</a>)</h2>
        <div id="takeoffRows">
          <div class="takeoff-row">
            <input type="text" placeholder="Item (e.g. Copper pipe 1/2\")" class="takeoff-desc">
            <input type="text" placeholder="Qty" class="takeoff-qty">
            <button type="button" class="takeoff-remove" aria-label="Remove row">Remove</button>
          </div>
        </div>
        <button type="button" id="addTakeoffRow" class="btn btn-outline" style="margin-top: 0.5rem;">Add row</button>
      </div>

      <div class="section">
        <h2>Labor Estimate</h2>
        <div class="fixture-labor-details" style="margin-bottom: 0.75rem;">
          <p class="fixture-labor-heading" style="margin: 0 0 0.25rem 0; font-weight: 600;">Fixture labor</p>
          <p class="fixture-labor-summary" style="margin: 0 0 0.5rem 0;"><strong><span id="fixtureLaborCount">0</span></strong><span id="fixtureLaborCountLabel"> Fixtures</span> / <strong><span id="fixtureLaborHours">0</span></strong> hours / <strong class="fixture-cost-toggle" id="fixtureLaborCostWrap" title="Click to toggle decimals">$<span id="fixtureLaborCost">0</span></strong></p>
          <div class="fixture-labor-breakdown">
            <p>Rough in: <strong><span id="fixtureLaborRoughIn">0</span></strong> hours</p>
            <p>Top out: <strong><span id="fixtureLaborTopOut">0</span></strong> hours</p>
            <p>Trim: <strong><span id="fixtureLaborTrim">0</span></strong> hours</p>
          </div>
        </div>
        <div class="additional-labor-block" style="margin-bottom: 1rem;">
          <div class="additional-labor-title-row">
            <p style="margin: 0 0 0.5rem 0; font-weight: 500;">Additional labor (work other than fixtures)</p>
            <details class="fixture-price-details crew-pricing-details" id="crewPricingDetails">
              <summary class="fixture-price-summary">Crew pricing ($/hr)</summary>
              <div class="fixture-price-details-content">
                <p style="margin: 0.5rem 0 0.25rem 0;"><label for="crewRate1">1 Tech</label><input type="number" id="crewRate1" name="crewRate1" min="0" step="0.01" value="275" style="max-width: 6rem;"> $/hr</p>
                <p style="margin: 0.25rem 0;"><label for="crewRate2">Plumber and Helper</label><input type="number" id="crewRate2" name="crewRate2" min="0" step="0.01" value="315" style="max-width: 6rem;"> $/hr</p>
                <p style="margin: 0.25rem 0 0.5rem 0;"><label for="crewRate3">3 Techs</label><input type="number" id="crewRate3" name="crewRate3" min="0" step="0.01" value="350" style="max-width: 6rem;"> $/hr</p>
              </div>
            </details>
            <button type="button" class="crew-pricing-link" id="openCrewPricing" aria-expanded="false">[Crew Pricing]</button>
          </div>
          <div class="additional-labor-header" aria-hidden="true">
            <span class="additional-labor-hdr-desc">Description</span>
            <span class="additional-labor-hdr-hours">Hours</span>
            <span class="additional-labor-hdr-crew">Crew</span>
            <span class="additional-labor-hdr-rate">Rate</span>
            <span class="additional-labor-hdr-remove"></span>
          </div>
          <div id="additionalLaborRows">
            <div class="additional-labor-row">
              <input type="text" class="additional-labor-desc" placeholder="Description (e.g. Demo, Underground, Prep)">
              <input type="number" class="additional-labor-hours" min="0" step="0.5" placeholder="Hrs" title="Hours">
              <select class="additional-labor-crew" title="Crew size">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
              <input type="number" class="additional-labor-rate" min="0" step="0.01" placeholder="Rate" title="Labor rate $/hr">
              <button type="button" class="additional-labor-remove" aria-label="Remove row">Remove</button>
            </div>
          </div>
          <button type="button" id="addAdditionalLaborRow" class="btn btn-outline" style="margin-top: 0.5rem;">Add row</button>
        </div>
        <p><strong>Labor total (Hours • Rate): $<span id="laborTotal">0.00</span></strong></p>
      </div>

      <div class="section">
        <h2>Pricing</h2>
        <p style="margin-bottom: 0.5rem; font-weight: 500;">Additional materials</p>
        <div class="additional-material-header" aria-hidden="true">
          <span class="additional-material-hdr-desc">Description</span>
          <span class="additional-material-hdr-amount">Amount</span>
          <span class="additional-material-hdr-remove"></span>
        </div>
        <div id="additionalMaterialRows">
          <div class="additional-material-row">
            <input type="text" class="additional-material-desc" placeholder="Description (e.g. Pipe, Fittings)">
            <input type="number" class="additional-material-amount" min="0" step="0.01" placeholder="Amount" title="Amount ($)">
            <button type="button" class="additional-material-remove" aria-label="Remove row">Remove</button>
          </div>
        </div>
        <button type="button" id="addAdditionalMaterialRow" class="btn btn-outline" style="margin-top: 0.5rem;">Add row</button>
        <div class="preview-section" style="margin-top: 1rem;">
          <table class="preview-table">
            <tr><th>Item</th><th>Amount</th></tr>
            <tr>
              <td>Fixture and Set Labor</td>
              <td>$<span id="calcFixtureLaborBase">0.00</span></td>
            </tr>
            <tr>
              <td>Fixture and Set Labor Markup <input type="number" id="fixtureLaborMarkupPct" name="fixtureLaborMarkupPct" min="0" step="0.5" value="0" title="Fixture and Set Labor Markup" style="width: 4rem; margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.9rem;">%</td>
              <td>$<span id="calcFixtureLaborMarkup">0.00</span></td>
            </tr>
            <tr style="font-weight: 600; border-top: 2px solid var(--border);">
              <td>Fixture and Set Labor Subtotal</td>
              <td style="text-align: right;">$<span id="calcFixtureLaborSubtotal">0.00</span></td>
            </tr>
            <tr>
              <td>Materials</td>
              <td>$<span id="calcMaterials">0.00</span></td>
            </tr>
            <tr>
              <td>Materials Markup <input type="number" id="materialsMarkupPct" name="materialsMarkupPct" min="0" step="0.5" value="0" title="Materials Markup" style="width: 4rem; margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.9rem;">%</td>
              <td>$<span id="calcMaterialsMarkup">0.00</span></td>
            </tr>
            <tr style="font-weight: 600; border-top: 2px solid var(--border);">
              <td>Materials Subtotal</td>
              <td style="text-align: right;">$<span id="calcMaterialsSubtotal">0.00</span></td>
            </tr>
            <tr>
              <td>Additional Labor</td>
              <td>$<span id="calcLabor">0.00</span></td>
            </tr>
            <tr>
              <td>Additional Labor Markup <input type="number" id="laborMarkupPct" name="laborMarkupPct" min="0" step="0.5" value="0" title="Labor Markup" style="width: 4rem; margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.9rem;">%</td>
              <td>$<span id="calcLaborMarkup">0.00</span></td>
            </tr>
            <tr style="font-weight: 600; border-top: 2px solid var(--border);">
              <td>Additional Labor Subtotal</td>
              <td style="text-align: right;">$<span id="calcLaborSubtotal">0.00</span></td>
            </tr>
          </table>
          <p class="grand-total">Grand Total: $<span id="grandTotal">0.00</span></p>
        </div>
      </div>

      <div class="section">
        <h2>Scope Notes / Exclusions</h2>
        <textarea id="scopeNotes" name="scopeNotes" rows="5" placeholder="Describe scope, exclusions, and any special notes..."></textarea>
      </div>

      <div id="roughCalculatorSection" class="section section-rough-calculator hidden" aria-hidden="true">
        <h2>Rough Calculator</h2>
        <div id="roughCalculatorContent">
          <div class="form-row rough-calc-dimensions-row">
            <div class="field">
              <label for="roughLength">Length (ft)</label>
              <input type="number" id="roughLength" name="roughLength" min="0" step="0.1" placeholder="0">
            </div>
            <span class="rough-calc-op" aria-hidden="true">*</span>
            <div class="field">
              <label for="roughWidth">Width (ft)</label>
              <input type="number" id="roughWidth" name="roughWidth" min="0" step="0.1" placeholder="0">
            </div>
            <span class="rough-calc-op" aria-hidden="true">=</span>
            <div class="field">
              <label for="roughSfFromDimensions">Square footage (L × W)</label>
              <input type="number" id="roughSfFromDimensions" name="roughSfFromDimensions" min="0" step="0.1" placeholder="Or enter SF">
            </div>
          </div>
          <div class="form-row">
            <div class="field">
              <label for="roughCostPerSqFt">Cost per SF before fixtures ($)</label>
              <input type="number" id="roughCostPerSqFt" name="roughCostPerSqFt" min="0" step="0.01" placeholder="0" class="rough-calc-cost-input">
            </div>
          </div>
          <div class="form-row">
            <div class="field">
              <label>Fixture count (from above) = <span id="roughFixtureCount">0</span></label>
              <input type="number" id="roughFixtureCountOverride" name="roughFixtureCountOverride" min="0" step="1" placeholder="Or enter custom amount">
            </div>
            <div class="field">
              <label for="roughPricePerFixture">Price per fixture ($)</label>
              <input type="number" id="roughPricePerFixture" name="roughPricePerFixture" min="0" step="0.01" placeholder="0">
            </div>
          </div>
          <p style="margin-top: 1rem; margin-bottom: 0; font-weight: 600;">Rough Bid: $<span id="roughBidResult">0.00</span></p>
          <div class="rough-calc-footer" style="display: flex; justify-content: flex-end; margin-top: 1rem;">
            <button type="button" id="clearRoughCalculatorBtn" class="btn btn-outline">[clear calculator]</button>
          </div>
        </div>
      </div>

      <div class="actions no-print">
        <div class="internal-summary-box">
          <h3 class="internal-summary-title">Internal Summary</h3>
          <div class="internal-summary-actions">
            <button type="button" id="generatePreview" class="btn btn-primary">Draft</button>
            <button type="button" id="printBtn" class="btn btn-secondary">Print</button>
          </div>
        </div>
        <button type="button" id="exportPdf" class="btn btn-outline">External Summary</button>
        <button type="button" id="clearBtn" class="btn btn-outline">Clear All</button>
        <button type="button" id="roughCalculatorBtn" class="btn btn-outline btn-push-right" aria-expanded="false">Rough Calculator</button>
      </div>
    </form>

    <div id="preview" class="preview-section" aria-live="polite"></div>

    <div id="externalSummaryModal" class="external-summary-modal" aria-modal="true" aria-labelledby="externalSummaryModalTitle" role="dialog">
      <div class="external-summary-modal-panel">
        <div class="external-summary-modal-header" id="externalSummaryModalTitle">External Summary</div>
        <div class="external-summary-modal-body">
          <div id="externalSummaryPreviewContent"></div>
          <label class="external-summary-notes-label" for="externalSummaryNotes">Notes / Exclusions</label>
          <textarea id="externalSummaryNotes" rows="4"></textarea>
          <div id="externalSummaryPrintNotes" class="external-summary-print-notes"></div>
        </div>
        <div class="external-summary-modal-actions no-print">
          <button type="button" id="externalSummaryDownloadPdf" class="btn btn-primary">Download PDF</button>
          <button type="button" id="externalSummaryPrint" class="btn btn-secondary">Print</button>
          <button type="button" id="externalSummaryClose" class="btn btn-outline">Close</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    (function() {
      const CREW_MULTIPLIERS = { 1: 1, 2: 1.8, 3: 2.5 };
      const requiredIds = ['customerName', 'jobAddress', 'bidDate', 'bidNumber'];

      function $(id) { return document.getElementById(id); }
      function qs(sel, root) { return (root || document).querySelector(sel); }
      function qsa(sel, root) { return (root || document).querySelectorAll(sel); }

      function setDefaultDate() {
        const bidDate = $('bidDate');
        if (bidDate && !bidDate.value) bidDate.value = new Date().toISOString().slice(0, 10);
      }
      setDefaultDate();

      var fixtureIds = [
        'fixtureToilets', 'fixtureBathSinks', 'fixtureShowerTub', 'fixtureShowerOnly', 'fixtureTubs',
        'fixtureUrinals', 'fixtureWaterClosets', 'fixtureKitchenSinks', 'fixtureDisposals',
        'fixtureIceMakers', 'fixturePotFiller',
        'fixtureLaundrySinks', 'fixtureWashingMachine',
        'fixtureHoseBibs', 'fixtureWaterFountain', 'fixtureGasDrops', 'fixtureFloorDrains', 'fixtureDogWash',
        'fixtureWHGas', 'fixtureWHElectric', 'fixtureWHTankless', 'fixtureWaterSoftener'
      ];

      function getNum(id) { const el = $(id); return el ? (parseFloat(el.value) || 0) : 0; }
      function getStr(id) { const el = $(id); return el ? (el.value || '').trim() : ''; }

      function formatNum(n, decimals) {
        return (parseFloat(n) || 0).toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
      }

      function numberToWords(n) {
        n = Math.floor(Number(n)) || 0;
        if (n < 0) n = 0;
        if (n > 999999) n = 999999;
        var ones = ['Zero','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
        var tens = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
        function under100(x) {
          if (x < 20) return ones[x];
          var t = Math.floor(x / 10), o = x % 10;
          return tens[t] + (o ? ' ' + ones[o] : '');
        }
        function under1000(x) {
          if (x < 100) return under100(x);
          var h = Math.floor(x / 100), r = x % 100;
          return ones[h] + ' Hundred' + (r ? ' ' + under100(r) : '');
        }
        if (n < 1000) return under1000(n);
        var th = Math.floor(n / 1000), r = n % 1000;
        return under1000(th) + ' Thousand' + (r ? ' ' + under1000(r) : '');
      }

      function formatProposalAmount(total) {
        var t = Number(total) || 0;
        var dollars = Math.floor(t);
        var cents = Math.round((t - dollars) * 100);
        if (cents >= 100) cents = 99;
        if (cents < 0) cents = 0;
        var centsStr = (cents < 10 ? '0' : '') + cents;
        return numberToWords(dollars) + ' ' + centsStr + '/100 Dollars ($' + formatNum(t, 2) + ')';
      }

      function formatFixtureCostShort(n) {
        var s = (parseFloat(n) || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        return s.replace(/\.?0+$/, '');
      }

      function totalFixtures() {
        var ledger = getFixtureLedger();
        if (ledger.length > 0) {
          var fixtureLabels = fixtureIds.map(function(id) {
            return id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
          });
          var sum = 0;
          fixtureLabels.forEach(function(label) {
            for (var j = 0; j < ledger.length; j++) {
              var f = ledger[j].fixtures || {};
              var val = f[label];
              sum += (val != null && val !== '') ? (parseInt(val, 10) || 0) : 0;
            }
          });
          return sum;
        }
        return fixtureIds.reduce(function(sum, id) { return sum + (getNum(id) || 0); }, 0);
      }

      var fixtureLabelToId = (function() {
        var m = {};
        fixtureIds.forEach(function(id) {
          var label = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
          m[label] = id;
        });
        return m;
      })();

      var DEFAULT_FIXTURE_MODE = 'Malachi';
      var currentFixtureMode = DEFAULT_FIXTURE_MODE;

      var FIXTURE_MODES = {
        Malachi: {
          fixtureToilets:      { label: 'Toilet',                       price: 650,   roughIn: 1,   topOut: 1,   trim: 1 },
          fixtureBathSinks:    { label: 'Bathroom sinks',               price: 275,   roughIn: 1,   topOut: 1,   trim: 1,   note: 'no sink included' },
          fixtureKitchenSinks: { label: 'Kitchen sink',                 price: 425,   roughIn: 1,   topOut: 1,   trim: 2,   note: 'no sink or faucet included' },
          fixtureDisposals:    { label: 'Garbage Disposal',             price: 350,   roughIn: 0,   topOut: 0,   trim: 1 },
          fixtureUrinals:      { label: 'Urinal and valve',             price: 950,   roughIn: 1,   topOut: 3,   trim: 3 },
          fixtureTubs:         { label: 'Bath tub and valve',           price: 2000,  roughIn: 1,   topOut: 2,   trim: 1 },
          fixtureShowerOnly:   { label: 'Shower only',                  price: 2450,  roughIn: 1,   topOut: 2.5, trim: 1 },
          fixtureShowerTub:    { label: 'Shower tub combo',             price: 3650,  roughIn: 1,   topOut: 3,   trim: 1,   note: 'no wall kit included' },
          fixtureLaundrySinks: { label: 'Laundry sink',                 price: 425,   roughIn: 1,   topOut: 1,   trim: 1,   note: 'no sink or faucet included' },
          fixtureHoseBibs:     { label: 'Hose bib',                     price: 500,   roughIn: 1,   topOut: 1,   trim: 0.5 },
          fixtureWaterFountain: { label: 'Water fountain',              price: 1300,  roughIn: 2,   topOut: 3,   trim: 2 },
          fixtureWHGas:        { label: 'Water heater',                 price: 1200,  roughIn: 1,   topOut: 2,   trim: 2 },
          fixtureWHElectric:   { label: 'Water heater (electric)',      price: 1200,  roughIn: 1,   topOut: 2,   trim: 2 },
          fixtureWHTankless:   { label: 'Tankless Water Heater',        price: 3650,  roughIn: 1,   topOut: 3,   trim: 2 },
          fixtureGasDrops:     { label: 'Gas drops',                    price: 1000,  roughIn: 3,   topOut: 1,   trim: 0 }
        },
        Trace: {
          fixtureToilets:      { label: 'Toilet',                       price: 3800,  roughIn: 1,   topOut: 1,   trim: 1 },
          fixtureBathSinks:    { label: 'Bathroom sinks',               price: 3800,  roughIn: 1,   topOut: 1,   trim: 1,   note: 'no sink included' },
          fixtureKitchenSinks: { label: 'Kitchen sink',                 price: 3800,  roughIn: 1,   topOut: 1,   trim: 2,   note: 'no sink or faucet included' },
          fixtureDisposals:    { label: 'Garbage Disposal',             price: 1800,  roughIn: 1.5, topOut: 0,   trim: 1 },
          fixtureUrinals:      { label: 'Urinal and valve',             price: 950,   roughIn: 1,   topOut: 3,   trim: 3 },
          fixtureTubs:         { label: 'Bath tub and valve',           price: 2000,  roughIn: 1,   topOut: 2,   trim: 1 },
          fixtureShowerOnly:   { label: 'Shower only',                  price: 3800,  roughIn: 1,   topOut: 2.5, trim: 1 },
          fixtureShowerTub:    { label: 'Shower tub combo',             price: 3650,  roughIn: 1,   topOut: 3,   trim: 1,   note: 'no wall kit included' },
          fixtureLaundrySinks: { label: 'Laundry sink',                 price: 1800,  roughIn: 1,   topOut: 1,   trim: 1,   note: 'no sink or faucet included' },
          fixtureHoseBibs:     { label: 'Hose bib',                     price: 1200,  roughIn: 1,   topOut: 1,   trim: 0.5 },
          fixtureWaterFountain: { label: 'Water fountain',              price: 3000,  roughIn: 2,   topOut: 3,   trim: 2 },
          fixtureWHGas:        { label: 'Water heater',                 price: 15000, roughIn: 1,   topOut: 2,   trim: 2 },
          fixtureWHElectric:   { label: 'Water heater (electric)',      price: 1200,  roughIn: 1,   topOut: 2,   trim: 2 },
          fixtureWHTankless:   { label: 'Tankless Water Heater',        price: 3650,  roughIn: 1,   topOut: 3,   trim: 2 },
          fixtureGasDrops:     { label: 'Gas drops',                    price: 1200,  roughIn: 3,   topOut: 1,   trim: 0 }
        }
      };

      var FIXTURE_PRICES = JSON.parse(JSON.stringify(FIXTURE_MODES[currentFixtureMode]));
      var DEFAULT_FIXTURE_PRICES = JSON.parse(JSON.stringify(FIXTURE_MODES[DEFAULT_FIXTURE_MODE]));

      var FIXTURE_LEDGER_KEY = 'bidtoolingFixtureLedger';
      function getFixtureLedger() {
        try {
          return JSON.parse(localStorage.getItem(FIXTURE_LEDGER_KEY) || '[]');
        } catch (e) {
          return [];
        }
      }
      function setFixtureLedger(entries) {
        localStorage.setItem(FIXTURE_LEDGER_KEY, JSON.stringify(entries));
      }
      function collectCurrentFixtures() {
        return fixtureIds.reduce(function(o, id) {
          var label = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
          o[label] = getNum(id);
          return o;
        }, {});
      }

      function getAdditionalLaborHours() {
        var sum = 0;
        qsa('.additional-labor-hours').forEach(function(el) {
          sum += parseFloat(el.value) || 0;
        });
        return sum;
      }

      function getFixtureLaborTotals() {
        var fixtureLabels = fixtureIds.map(function(id) {
          return id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
        });
        var totalRoughIn = 0, totalTopOut = 0, totalTrim = 0;
        var ledger = getFixtureLedger();
        if (ledger.length > 0) {
          fixtureLabels.forEach(function(label, idx) {
            var priceRow = FIXTURE_PRICES[fixtureIds[idx]];
            if (!priceRow) return;
            var totalQty = 0;
            for (var j = 0; j < ledger.length; j++) {
              var f = ledger[j].fixtures || {};
              var val = f[label];
              totalQty += (val != null && val !== '') ? (parseInt(val, 10) || 0) : 0;
            }
            totalRoughIn += totalQty * priceRow.roughIn;
            totalTopOut += totalQty * priceRow.topOut;
            totalTrim += totalQty * priceRow.trim;
          });
        } else {
          fixtureIds.forEach(function(id, idx) {
            var priceRow = FIXTURE_PRICES[id];
            if (!priceRow) return;
            var qty = getNum(id) || 0;
            totalRoughIn += qty * priceRow.roughIn;
            totalTopOut += qty * priceRow.topOut;
            totalTrim += qty * priceRow.trim;
          });
        }
        var total = totalRoughIn + totalTopOut + totalTrim;
        return { roughIn: totalRoughIn, topOut: totalTopOut, trim: totalTrim, total: total };
      }

      function getFixtureCostTotal() {
        var total = 0;
        var fixtureLabels = fixtureIds.map(function(id) {
          return id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
        });
        var ledger = getFixtureLedger();
        if (ledger.length > 0) {
          fixtureLabels.forEach(function(label, idx) {
            var priceRow = FIXTURE_PRICES[fixtureIds[idx]];
            if (!priceRow) return;
            var totalQty = 0;
            for (var j = 0; j < ledger.length; j++) {
              var f = ledger[j].fixtures || {};
              var val = f[label];
              totalQty += (val != null && val !== '') ? (parseInt(val, 10) || 0) : 0;
            }
            total += totalQty * (priceRow.price || 0);
          });
        } else {
          fixtureIds.forEach(function(id) {
            var priceRow = FIXTURE_PRICES[id];
            if (!priceRow) return;
            var qty = getNum(id) || 0;
            total += qty * (priceRow.price || 0);
          });
        }
        return total;
      }

      function updateRoughBid() {
        var roughLengthEl = $('roughLength');
        var roughWidthEl = $('roughWidth');
        var roughSfEl = $('roughSfFromDimensions');
        var roughLength = getNum('roughLength') || 0;
        var roughWidth = getNum('roughWidth') || 0;
        var roughSfEntered = roughSfEl ? (parseFloat(roughSfEl.value) || 0) : 0;
        var roughCostPerSqFt = getNum('roughCostPerSqFt') || 0;
        var roughPricePerFixture = getNum('roughPricePerFixture') || 0;
        var effectiveSf = roughSfEntered > 0 ? roughSfEntered : (roughLength * roughWidth);
        if (isNaN(effectiveSf)) effectiveSf = 0;
        var dimensionsDisabled = roughSfEntered > 0;
        if (roughLengthEl) {
          roughLengthEl.disabled = dimensionsDisabled;
          var lengthField = roughLengthEl.closest ? roughLengthEl.closest('.field') : null;
          if (lengthField) lengthField.classList.toggle('field-disabled', dimensionsDisabled);
        }
        if (roughWidthEl) {
          roughWidthEl.disabled = dimensionsDisabled;
          var widthField = roughWidthEl.closest ? roughWidthEl.closest('.field') : null;
          if (widthField) widthField.classList.toggle('field-disabled', dimensionsDisabled);
        }
        var fixtureCountFromAbove = totalFixtures();
        var roughFixtureOverride = getNum('roughFixtureCountOverride') || 0;
        var fixtureCount = roughFixtureOverride > 0 ? roughFixtureOverride : fixtureCountFromAbove;
        if (isNaN(fixtureCount)) fixtureCount = fixtureCountFromAbove;
        var buildingPart = effectiveSf * roughCostPerSqFt;
        if (isNaN(buildingPart)) buildingPart = 0;
        var fixturePart = fixtureCount * roughPricePerFixture;
        if (isNaN(fixturePart)) fixturePart = 0;
        var roughBid = buildingPart * fixturePart;
        if (isNaN(roughBid)) roughBid = 0;
        var fcEl = $('roughFixtureCount');
        if (fcEl) fcEl.textContent = formatNum(fixtureCountFromAbove, 0);
        var resultEl = $('roughBidResult');
        if (resultEl) resultEl.textContent = formatNum(roughBid, 2);
      }

      function calculateTotals() {
        var materials = 0;
        qsa('.additional-material-row').forEach(function(row) {
          materials += parseFloat((row.querySelector('.additional-material-amount') || {}).value) || 0;
        });
        var fixtureLabor = getFixtureLaborTotals();
        var fixtureCost = getFixtureCostTotal();
        var additionalLaborCost = 0;
        qsa('.additional-labor-row').forEach(function(row) {
          var hours = parseFloat((row.querySelector('.additional-labor-hours') || {}).value) || 0;
          var rowCrew = parseInt((row.querySelector('.additional-labor-crew') || {}).value, 10) || 1;
          var rowRate = parseFloat((row.querySelector('.additional-labor-rate') || {}).value) || 0;
          additionalLaborCost += hours * rowRate;
        });
        var labor = additionalLaborCost;
        var additionalHours = getAdditionalLaborHours();
        var totalHours = fixtureLabor.total + additionalHours;
        var materialsMarkupPct = getNum('materialsMarkupPct') || 0;
        var laborMarkupPct = getNum('laborMarkupPct') || 0;
        var fixtureLaborMarkupPct = getNum('fixtureLaborMarkupPct') || 0;
        var materialsMarkup = materials * (materialsMarkupPct / 100);
        var laborMarkup = labor * (laborMarkupPct / 100);
        var fixtureLaborMarkup = fixtureCost * (fixtureLaborMarkupPct / 100);
        var fixtureLaborSubtotal = fixtureCost + fixtureLaborMarkup;
        var materialsSubtotal = materials + materialsMarkup;
        var laborSubtotal = labor + laborMarkup;
        var total = fixtureLaborSubtotal + materialsSubtotal + laborSubtotal;

        var fixtureCount = totalFixtures();
        $('totalFixtures').textContent = formatNum(fixtureCount, 0);
        if ($('fixtureLaborCount')) $('fixtureLaborCount').textContent = formatNum(fixtureCount, 0);
        if ($('fixtureLaborCountLabel')) $('fixtureLaborCountLabel').textContent = fixtureCount === 1 ? ' Fixture' : ' Fixtures';
        if ($('fixtureLaborHours')) $('fixtureLaborHours').textContent = formatNum(fixtureLabor.total, 1);
        var costEl = $('fixtureLaborCost');
        if (costEl) {
          var costRaw = fixtureCost;
          costEl.setAttribute('data-raw-value', costRaw);
          costEl.setAttribute('data-format', 'short');
          costEl.textContent = formatFixtureCostShort(costRaw);
        }
        if ($('fixtureLaborRoughIn')) $('fixtureLaborRoughIn').textContent = formatNum(fixtureLabor.roughIn, 1);
        if ($('fixtureLaborTopOut')) $('fixtureLaborTopOut').textContent = formatNum(fixtureLabor.topOut, 1);
        if ($('fixtureLaborTrim')) $('fixtureLaborTrim').textContent = formatNum(fixtureLabor.trim, 1);
        $('laborTotal').textContent = formatNum(labor, 2);
        if ($('calcFixtureLaborBase')) $('calcFixtureLaborBase').textContent = formatNum(fixtureCost, 2);
        if ($('calcFixtureLaborMarkup')) $('calcFixtureLaborMarkup').textContent = formatNum(fixtureLaborMarkup, 2);
        if ($('calcFixtureLaborSubtotal')) $('calcFixtureLaborSubtotal').textContent = formatNum(fixtureLaborSubtotal, 2);
        $('calcMaterials').textContent = formatNum(materials, 2);
        $('calcLabor').textContent = formatNum(labor, 2);
        if ($('calcMaterialsMarkup')) $('calcMaterialsMarkup').textContent = formatNum(materialsMarkup, 2);
        if ($('calcLaborMarkup')) $('calcLaborMarkup').textContent = formatNum(laborMarkup, 2);
        if ($('calcMaterialsSubtotal')) $('calcMaterialsSubtotal').textContent = formatNum(materialsSubtotal, 2);
        if ($('calcLaborSubtotal')) $('calcLaborSubtotal').textContent = formatNum(laborSubtotal, 2);
        if ($('calcTotal')) $('calcTotal').textContent = formatNum(total, 2);
        $('grandTotal').textContent = formatNum(total, 2);
        updateRoughBid();
        return {
          materials: materials,
          labor: labor,
          materialsMarkup: materialsMarkup,
          laborMarkup: laborMarkup,
          total: total,
          totalHours: totalHours,
          fixtureLabor: fixtureLabor,
          fixtureCost: fixtureCost,
          fixtureLaborMarkup: fixtureLaborMarkup,
          fixtureLaborSubtotal: fixtureLaborSubtotal,
          materialsSubtotal: materialsSubtotal,
          laborSubtotal: laborSubtotal
        };
      }

      function updatePreview() {
        var data = collectFormData();
        var totals = calculateTotals();
        var html = buildPreviewHtml(data, totals);
        var preview = $('preview');
        preview.innerHTML = html;
        preview.classList.add('visible');
      }

      function collectFormData() {
        var takeoff = [];
        qsa('.takeoff-row').forEach(function(row) {
          var desc = (row.querySelector('.takeoff-desc') || {}).value;
          var qty = (row.querySelector('.takeoff-qty') || {}).value;
          if (desc || qty) takeoff.push({ desc: desc, qty: qty });
        });
        var additionalLabor = [];
        qsa('.additional-labor-row').forEach(function(row) {
          var desc = (row.querySelector('.additional-labor-desc') || {}).value;
          var hours = parseFloat((row.querySelector('.additional-labor-hours') || {}).value) || 0;
          var crewSize = (row.querySelector('.additional-labor-crew') || {}).value || '1';
          var laborRate = parseFloat((row.querySelector('.additional-labor-rate') || {}).value) || 0;
          var rowCost = hours * laborRate;
          additionalLabor.push({ desc: desc || '', hours: hours, crewSize: crewSize, laborRate: laborRate, rowCost: rowCost });
        });
        var additionalMaterials = [];
        var materialSubtotalSum = 0;
        qsa('.additional-material-row').forEach(function(row) {
          var desc = (row.querySelector('.additional-material-desc') || {}).value;
          var amount = parseFloat((row.querySelector('.additional-material-amount') || {}).value) || 0;
          additionalMaterials.push({ desc: desc || '', amount: amount });
          materialSubtotalSum += amount;
        });
        return {
          customerName: getStr('customerName'),
          customerAddress: getStr('customerAddress'),
          jobName: getStr('jobName'),
          jobAddress: getStr('jobAddress'),
          bidDate: getStr('bidDate'),
          bidNumber: getStr('bidNumber'),
          planName: getStr('planName'),
          planIssueDate: getStr('planIssueDate'),
          planTitle: getStr('planTitle'),
          fixtures: fixtureIds.reduce(function(o, id) {
            var label = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
            o[label] = getNum(id);
            return o;
          }, {}),
          takeoff: takeoff,
          additionalLabor: additionalLabor,
          laborHours: getAdditionalLaborHours(),
          crewSize: ($('crewSize') || {}).value || '1',
          daysOnSite: getNum('daysOnSite'),
          laborRate: (function() {
            var crew = parseInt(($('crewSize') || {}).value, 10) || 1;
            var el = $('crewRate' + crew);
            return (el && parseFloat(el.value)) || (getNum('laborRate') || (($('crewRate1') && parseFloat($('crewRate1').value)) || 275));
          })(),
          additionalMaterials: additionalMaterials,
          materialSubtotal: materialSubtotalSum,
          materialsMarkupPct: getNum('materialsMarkupPct'),
          laborMarkupPct: getNum('laborMarkupPct'),
          scopeNotes: getStr('scopeNotes')
        };
      }

      function buildPreviewHtml(data, totals) {
        var f = data.fixtures || {};
        var fixtureRows = Object.keys(f).map(function(k) {
          var v = f[k];
          if (v == null || v === '') return '';
          if ((parseInt(v, 10) || 0) <= 1) return '';
          return '<tr><td>' + escapeHtml(k) + '</td><td>' + v + '</td></tr>';
        }).filter(Boolean).join('');
        if (!fixtureRows) fixtureRows = '<tr><td colspan="2">—</td></tr>';

        var takeoffRows = (data.takeoff || []).map(function(t) {
          return '<tr><td>' + escapeHtml(t.desc) + '</td><td>' + escapeHtml(t.qty) + '</td></tr>';
        }).join('') || '<tr><td colspan="2">—</td></tr>';

        var additionalLaborRows = (data.additionalLabor || []).map(function(t) {
          var descLabel = (t.desc != null && String(t.desc).trim() !== '') ? escapeHtml(String(t.desc).trim()) : '—';
          var rowCost = (t.rowCost != null && !isNaN(t.rowCost)) ? formatNum(t.rowCost, 2) : '—';
          return '<tr><td>' + descLabel + '</td><td>' + (t.hours != null ? t.hours : '').toString() + '</td><td>' + (t.crewSize != null ? escapeHtml(String(t.crewSize)) : '') + '</td><td>$' + (t.laborRate != null ? formatNum(Number(t.laborRate), 2) : '0.00') + '</td><td>$' + rowCost + '</td></tr>';
        }).join('');
        var additionalLaborBlock = additionalLaborRows
          ? '<div class="preview-section"><h3>Additional Labor</h3><table class="preview-table"><thead><tr><th>Description</th><th>Hours</th><th>Crew</th><th>Team Rate / Hr</th><th>Manpower Cost</th></tr></thead><tbody>' + additionalLaborRows + '</tbody></table><p>Additional labor total: ' + formatNum(data.laborHours != null ? data.laborHours : 0, 1) + ' hours</p></div>'
          : '';

        var additionalMaterialsRows = (data.additionalMaterials || []).map(function(t) {
          var amount = (t.amount != null && !isNaN(t.amount)) ? formatNum(Number(t.amount), 2) : '0.00';
          return '<tr><td>' + escapeHtml(t.desc) + '</td><td>$' + amount + '</td></tr>';
        }).join('');
        var materialsTotal = formatNum((totals && totals.materials != null) ? totals.materials : (data.materialSubtotal != null ? Number(data.materialSubtotal) : 0), 2);
        var additionalMaterialsBlock = additionalMaterialsRows
          ? '<div class="preview-section"><h3>Additional Materials</h3><table class="preview-table"><thead><tr><th>Description</th><th>Amount ($)</th></tr></thead><tbody>' + additionalMaterialsRows + '</tbody></table><p>Materials total: $' + materialsTotal + '</p></div>'
          : '';

        return (
          '<div class="preview-header">' +
            '<div class="preview-logo" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" aria-hidden="true"><path fill="#E85D04" d="M541.4 162.6C549 155 561.7 156.9 565.5 166.9C572.3 184.6 576 203.9 576 224C576 312.4 504.4 384 416 384C398.5 384 381.6 381.2 365.8 376L178.9 562.9C150.8 591 105.2 591 77.1 562.9C49 534.8 49 489.2 77.1 461.1L264 274.2C258.8 258.4 256 241.6 256 224C256 135.6 327.6 64 416 64C436.1 64 455.4 67.7 473.1 74.5C483.1 78.3 484.9 91 477.4 98.6L388.7 187.3C385.7 190.3 384 194.4 384 198.6L384 240C384 248.8 391.2 256 400 256L441.4 256C445.6 256 449.7 254.3 452.7 251.3L541.4 162.6z"/></svg></div>' +
            '<h1>Click Plumbing and Electrical</h1>' +
            '<p class="preview-meta">Bid # ' + escapeHtml(data.bidNumber) + ' — ' + escapeHtml(data.bidDate) + '</p>' +
          '</div>' +
          '<div class="preview-section">' +
            '<h3>Customer &amp; Job</h3>' +
            '<p><strong>' + escapeHtml(data.customerName) + '</strong>' +
            (data.customerAddress ? '<br>' + escapeHtml(data.customerAddress) : '') +
            (data.jobName ? '<br>' + escapeHtml(data.jobName) : '') +
            '<br>' + escapeHtml(data.jobAddress) +
            (data.planTitle || data.planName || data.planIssueDate ? '<br>Plans: ' + [data.planTitle, data.planName, data.planIssueDate].filter(Boolean).map(escapeHtml).join(' — ') : '') + '</p>' +
          '</div>' +
          '<div class="preview-section">' +
            '<h3>Fixture Summary</h3>' +
            '<table class="preview-table"><thead><tr><th>Item</th><th>Qty</th></tr></thead><tbody>' + fixtureRows + '</tbody></table>' +
          '</div>' +
          '<div class="preview-section">' +
            '<h3>Fixture Materials</h3>' +
            '<table class="preview-table"><thead><tr><th>Item</th><th>Qty</th></tr></thead><tbody>' + takeoffRows + '</tbody></table>' +
          '</div>' +
          additionalLaborBlock +
          additionalMaterialsBlock +
          (function() {
            var fl = (totals && totals.fixtureLabor) || {};
            var flTotal = formatNum(fl.total != null ? fl.total : 0, 1);
            var flRough = formatNum(fl.roughIn != null ? fl.roughIn : 0, 1);
            var flTop = formatNum(fl.topOut != null ? fl.topOut : 0, 1);
            var flTrim = formatNum(fl.trim != null ? fl.trim : 0, 1);
            var fixtureCostVal = formatNum(totals && totals.fixtureCost != null ? totals.fixtureCost : 0, 2);
            var addlHours = formatNum(data.laborHours != null ? data.laborHours : 0, 1);
            var addlCost = formatNum(totals && totals.labor != null ? totals.labor : 0, 2);
            var addlList = (data.additionalLabor || []).map(function(t) {
              var descLabel = (t.desc != null && String(t.desc).trim() !== '') ? escapeHtml(String(t.desc).trim()) : '—';
              var rc = (t.rowCost != null && !isNaN(t.rowCost)) ? formatNum(t.rowCost, 2) : '0.00';
              var hrs = (t.hours != null && !isNaN(t.hours)) ? t.hours.toString() : '0';
              return '<li>' + descLabel + ': ' + hrs + ' hrs, $' + rc + '</li>';
            }).join('');
            var addlBlock = addlList ? '<ul style="margin: 0.5rem 0;">' + addlList + '</ul>' : '';
            return '<div class="preview-section">' +
              '<h3>Labor Summary</h3>' +
              '<h4>Fixture and Set Labor</h4>' +
              '<p>Total: ' + flTotal + ' hours (Rough in: ' + flRough + ', Top out: ' + flTop + ', Trim: ' + flTrim + '). Fixture labor cost: $' + fixtureCostVal + '</p>' +
              '<h4>Additional Labor</h4>' +
              addlBlock + '<p>' + addlHours + ' hours = $' + addlCost + '</p>' +
            '</div>';
          })() +
          '<div class="preview-section">' +
            '<h3>Pricing Breakdown</h3>' +
            '<table class="preview-table">' +
              '<tr><th>Item</th><th>Amount</th></tr>' +
              '<tr><td>Fixture and Set Labor</td><td>$' + formatNum(totals.fixtureCost || 0, 2) + '</td></tr>' +
              '<tr><td>Fixture and Set Labor Markup</td><td>$' + formatNum(totals.fixtureLaborMarkup != null ? totals.fixtureLaborMarkup : 0, 2) + '</td></tr>' +
              '<tr style="font-weight: 600; border-top: 2px solid var(--border);"><td>Fixture and Set Labor Subtotal</td><td style="text-align: right;">$' + formatNum(totals.fixtureLaborSubtotal != null ? totals.fixtureLaborSubtotal : (totals.fixtureCost || 0), 2) + '</td></tr>' +
              '<tr><td>Materials</td><td>$' + formatNum(totals.materials || 0, 2) + '</td></tr>' +
              '<tr><td>Materials Markup</td><td>$' + formatNum(totals.materialsMarkup != null ? totals.materialsMarkup : 0, 2) + '</td></tr>' +
              '<tr style="font-weight: 600; border-top: 2px solid var(--border);"><td>Materials Subtotal</td><td style="text-align: right;">$' + formatNum(totals.materialsSubtotal != null ? totals.materialsSubtotal : (totals.materials || 0) + (totals.materialsMarkup != null ? totals.materialsMarkup : 0), 2) + '</td></tr>' +
              '<tr><td>Additional Labor</td><td>$' + formatNum(totals.labor || 0, 2) + '</td></tr>' +
              '<tr><td>Additional Labor Markup</td><td>$' + formatNum(totals.laborMarkup != null ? totals.laborMarkup : 0, 2) + '</td></tr>' +
              '<tr style="font-weight: 600; border-top: 2px solid var(--border);"><td>Additional Labor Subtotal</td><td style="text-align: right;">$' + formatNum(totals.laborSubtotal != null ? totals.laborSubtotal : (totals.labor || 0) + (totals.laborMarkup != null ? totals.laborMarkup : 0), 2) + '</td></tr>' +
            '</table>' +
          '</div>' +
          '<div class="preview-section">' +
            '<p class="grand-total">Grand Total: $' + formatNum(totals.total || 0, 2) + '</p>' +
          '</div>' +
          (data.scopeNotes ? '<div class="preview-section"><h3>Notes / Exclusions</h3><p>' + escapeHtml(data.scopeNotes).replace(/\n/g, '<br>') + '</p></div>' : '')
        );
      }

      function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function validateForm() {
        var ok = true;
        requiredIds.forEach(function(id) {
          var el = $(id);
          if (!el) return;
          if (!getStr(id)) { el.classList.add('error'); ok = false; } else { el.classList.remove('error'); }
        });
        return ok;
      }

      function onGeneratePreview() {
        if (!validateForm()) {
          alert('Please fill in required fields: Customer Name, Job Address, Bid Date, Bid Number.');
          return;
        }
        updatePreview();
      }

      function onPrint() {
        if (!validateForm()) {
          alert('Please fill in required fields before printing.');
          return;
        }
        updatePreview();
        setTimeout(function() { window.print(); }, 100);
      }

      function buildExternalSummaryPreviewHtml(data, totals) {
        var fxBase = totals.fixtureCost || 0;
        var fxMarkup = totals.fixtureLaborMarkup != null ? totals.fixtureLaborMarkup : 0;
        var fxSub = totals.fixtureLaborSubtotal != null ? totals.fixtureLaborSubtotal : (fxBase + fxMarkup);
        var matSub = totals.materialsSubtotal != null ? totals.materialsSubtotal : ((totals.materials || 0) + (totals.materialsMarkup != null ? totals.materialsMarkup : 0));
        var labSub = totals.laborSubtotal != null ? totals.laborSubtotal : ((totals.labor || 0) + (totals.laborMarkup != null ? totals.laborMarkup : 0));
        var planParts = [data.planTitle, data.planName, data.planIssueDate].filter(Boolean).map(escapeHtml);
        var planLine = planParts.length ? 'Plans: ' + planParts.join(' — ') : '';
        var custAddrLines = (data.customerAddress || '').split(/\r?\n/).map(function(s) { return s.trim(); }).filter(Boolean);
        var jobAddrLines = (data.jobAddress || '').split(/\r?\n/).map(function(s) { return s.trim(); }).filter(Boolean);
        var custBlock = '<p style="margin: 0 0 0.25rem 0;"><strong>' + escapeHtml(data.customerName) + '</strong></p>' +
          custAddrLines.map(function(line) { return '<p style="margin: 0 0 0.25rem 0;">' + escapeHtml(line) + '</p>'; }).join('');
        var jobBlock = (data.jobName ? '<p style="margin: 0 0 0.25rem 0;"><strong>' + escapeHtml(data.jobName) + '</strong></p>' : '') +
          jobAddrLines.map(function(line) { return '<p style="margin: 0 0 0.25rem 0;">' + escapeHtml(line) + '</p>'; }).join('');
        var f = data.fixtures || {};
        var inclusionItems = '<li>Fixtures provided and installed by us per plan:</li>' +
          fixtureIds.map(function(id) {
            var label = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
            var qty = (parseInt(f[label], 10) || 0);
            return qty > 0 ? '<li>' + escapeHtml(label) + ' ' + qty + '</li>' : '';
          }).filter(Boolean).join('');
        return '<div class="preview-section">' +
          '<p style="font-size: 1.1rem; font-weight: 600; margin: 0 0 0.5rem 0;">Click Plumbing and Electrical</p>' +
          '<p class="preview-meta" style="margin: 0 0 0.75rem 0;">Bid # ' + escapeHtml(data.bidNumber) + ' — ' + escapeHtml(data.bidDate) + '</p>' +
          '<div style="margin-bottom: 1rem;">' + custBlock + '</div>' +
          '<div style="margin-bottom: 1rem;">' + jobBlock + '</div>' +
          '<p style="margin: 0.75rem 0;">As per plumbing plans and specifications, we propose to do the plumbing in the amount of: <strong>' + formatProposalAmount(totals.total || 0) + '</strong></p>' +
          '<p style="margin: 0.5rem 0 0.25rem 0; font-weight: 600;">Inclusions:</p>' +
          '<ul style="margin: 0 0 0; padding-left: 1.25rem;">' + inclusionItems + '</ul>' +
          '<ul style="margin: 1em 0 0.75rem 0; padding-left: 1.25rem;"><li>Permits</li></ul>' +
          (planLine ? '<p style="margin: 0.75rem 0 0 0;">' + planLine + '</p>' : '') +
          '</div>' +
          '<div class="preview-section">' +
          '<h3>Pricing Summary</h3>' +
          '<table class="preview-table">' +
          '<tr><td>Fixture and Set Labor Subtotal</td><td>$' + formatNum(fxSub, 2) + '</td></tr>' +
          '<tr><td>Materials Subtotal</td><td>$' + formatNum(matSub, 2) + '</td></tr>' +
          '<tr><td>Additional Labor Subtotal</td><td>$' + formatNum(labSub, 2) + '</td></tr>' +
          '<tr style="font-weight: 600; border-top: 2px solid var(--border);"><td>Grand Total</td><td style="text-align: right;">$' + formatNum(totals.total || 0, 2) + '</td></tr>' +
          '</table></div>';
      }

      function openExternalSummaryModal() {
        if (!validateForm()) {
          alert('Please fill in required fields before opening External Summary.');
          return;
        }
        var data = collectFormData();
        var totals = calculateTotals();
        $('externalSummaryPreviewContent').innerHTML = buildExternalSummaryPreviewHtml(data, totals);
        $('externalSummaryNotes').value = data.scopeNotes != null ? data.scopeNotes : '';
        $('externalSummaryModal').classList.add('visible');
      }

      function closeExternalSummaryModal() {
        $('externalSummaryModal').classList.remove('visible');
      }

      function exportToPDF(notesOverride) {
        if (!validateForm()) {
          alert('Please fill in required fields before exporting.');
          return;
        }
        updatePreview();
        try {
          var data = collectFormData();
          var totals = calculateTotals();
          var notesText = notesOverride !== undefined ? notesOverride : (data.scopeNotes || '');
          var JsPDF = window.jspdf.jsPDF;
          var doc = new JsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
          var margin = 40;
          var maxWidth = 520;
          var y = 40;
          var lineHeight = 14;

          doc.setFontSize(16);
          doc.text('Click Plumbing and Electrical', margin, y);
          y += 20;
          doc.setFontSize(10);
          doc.text('Bid # ' + data.bidNumber + ' — ' + data.bidDate, margin, y);
          y += lineHeight + 4;
          doc.setFont(undefined, 'bold');
          doc.text(data.customerName, margin, y);
          y += lineHeight;
          doc.setFont(undefined, 'normal');
          (data.customerAddress || '').split(/\r?\n/).forEach(function(line) {
            var t = line.trim();
            if (t) { doc.text(t, margin, y); y += lineHeight; }
          });
          y += lineHeight;
          if (data.jobName) {
            doc.setFont(undefined, 'bold');
            doc.text(data.jobName, margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
          }
          (data.jobAddress || '').split(/\r?\n/).forEach(function(line) {
            var t = line.trim();
            if (t) { doc.text(t, margin, y); y += lineHeight; }
          });
          y += lineHeight;
          doc.text('As per plumbing plans and specifications, we propose to do the plumbing in the amount of:', margin, y);
          y += lineHeight;
          var amountStr = formatProposalAmount(totals.total || 0);
          doc.setFont(undefined, 'bold');
          var amountLines = doc.splitTextToSize(amountStr, maxWidth);
          amountLines.forEach(function(line) {
            if (y > 700) { doc.addPage(); y = 40; }
            doc.text(line, margin, y);
            y += lineHeight;
          });
          doc.setFont(undefined, 'normal');
          y += lineHeight;
          doc.setFont(undefined, 'bold');
          doc.text('Inclusions:', margin, y);
          y += lineHeight;
          doc.setFont(undefined, 'normal');
          doc.text('- Fixtures provided and installed by us per plan:', margin, y);
          y += lineHeight;
          var f = data.fixtures || {};
          fixtureIds.forEach(function(id) {
            var label = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
            var qty = (parseInt(f[label], 10) || 0);
            if (qty > 0) {
              if (y > 700) { doc.addPage(); y = 40; }
              doc.text('- ' + label + ' ' + qty, margin, y);
              y += lineHeight;
            }
          });
          y += lineHeight;
          if (y > 700) { doc.addPage(); y = 40; }
          doc.text('- Permits', margin, y);
          y += lineHeight;
          if (data.planTitle) { doc.text('Plan Title: ' + data.planTitle, margin, y); y += lineHeight; }
          if (data.planName) { doc.text('Plan Name: ' + data.planName, margin, y); y += lineHeight; }
          if (data.planIssueDate) { doc.text('Plan Issue Date: ' + data.planIssueDate, margin, y); y += lineHeight; }
          y += 8;

          doc.setFontSize(11);
          doc.text('Pricing Summary', margin, y);
          y += lineHeight + 2;
          doc.setFontSize(10);
          var fxBase = totals.fixtureCost || 0;
          var fxMarkup = totals.fixtureLaborMarkup != null ? totals.fixtureLaborMarkup : 0;
          var fxSub = totals.fixtureLaborSubtotal != null ? totals.fixtureLaborSubtotal : (fxBase + fxMarkup);
          var matSub = totals.materialsSubtotal != null ? totals.materialsSubtotal : ((totals.materials || 0) + (totals.materialsMarkup != null ? totals.materialsMarkup : 0));
          var labSub = totals.laborSubtotal != null ? totals.laborSubtotal : ((totals.labor || 0) + (totals.laborMarkup != null ? totals.laborMarkup : 0));
          doc.text('Fixture and Set Labor Subtotal: $' + formatNum(fxSub, 2), margin, y);
          y += lineHeight;
          doc.text('Materials Subtotal: $' + formatNum(matSub, 2), margin, y);
          y += lineHeight;
          doc.text('Additional Labor Subtotal: $' + formatNum(labSub, 2), margin, y);
          y += lineHeight;
          doc.setFont(undefined, 'bold');
          doc.text('Grand Total: $' + formatNum(totals.total || 0, 2), margin, y);
          y += lineHeight + 6;

          if (notesText) {
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            doc.text('Notes / Exclusions', margin, y);
            y += lineHeight + 2;
            doc.setFontSize(10);
            var noteLines = doc.splitTextToSize(notesText, maxWidth);
            noteLines.forEach(function(line) {
              if (y > 700) { doc.addPage(); y = 40; }
              doc.text(line, margin, y);
              y += lineHeight;
            });
          }

          doc.save('bid-summary-' + (getStr('bidNumber') || 'export') + '.pdf');
        } catch (e) {
          console.error(e);
          alert('PDF export failed. Try printing to PDF from the Print dialog instead.');
        }
      }

      function exportCoverPage() {
        var ledger = getFixtureLedger();
        if (ledger.length === 0) {
          alert('No plan pages in the ledger. Save at least one plan page first.');
          return;
        }
        try {
          var fixtureLabels = fixtureIds.map(function(id) {
            return id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
          });
          var numCols = ledger.length;
          var useLandscape = numCols > 5;
          var JsPDF = window.jspdf.jsPDF;
          var doc = new JsPDF({
            orientation: useLandscape ? 'landscape' : 'portrait',
            unit: 'pt',
            format: 'letter'
          });
          var margin = 32;
          var pageW = doc.internal.pageSize.getWidth();
          var usableWidth = pageW - margin * 2;
          var itemColWidth = 142;
          var laborColWidth = 52;
          var totalColWidth = 36;
          var dataWidth = usableWidth - itemColWidth - laborColWidth - totalColWidth;
          var colWidth = Math.max(26, dataWidth / numCols);
          var cellPad = 1;
          var lineHeight = 14;
          var y = 40;
          var fontSize = numCols > 8 ? 9 : 10;
          doc.setFontSize(fontSize);

          doc.setFontSize(16);
          doc.text('Fixture count by plan page', margin, y);
          y += 24;
          doc.setFontSize(fontSize);

          function drawHeader() {
            doc.setFont(undefined, 'bold');
            doc.text('Total', margin + cellPad, y);
            doc.text('Labor', margin + totalColWidth + cellPad, y);
            doc.text('Item', margin + totalColWidth + laborColWidth + cellPad, y);
            var x = margin + totalColWidth + laborColWidth + itemColWidth;
            for (var i = 0; i < ledger.length; i++) {
              var name = (ledger[i].pageName || 'Unnamed');
              if (name.length > 14) name = name.slice(0, 11) + '...';
              doc.text(name, x + cellPad, y);
              x += colWidth;
            }
            y += lineHeight;
            doc.setFont(undefined, 'normal');
          }

          drawHeader();

          fixtureLabels.forEach(function(label, idx) {
            if (y > 700) {
              doc.addPage(useLandscape ? 'landscape' : 'portrait', 'letter');
              y = 40;
              doc.setFontSize(fontSize);
              drawHeader();
            }
            var rowTotal = 0;
            for (var j = 0; j < ledger.length; j++) {
              var f = ledger[j].fixtures || {};
              var val = f[label];
              rowTotal += (val != null && val !== '') ? (parseInt(val, 10) || 0) : 0;
            }
            var priceRow = FIXTURE_PRICES[fixtureIds[idx]];
            var laborStr = priceRow
              ? '[' + priceRow.roughIn + ', ' + priceRow.topOut + ', ' + priceRow.trim + ']'
              : '—';
            doc.text(String(rowTotal), margin + cellPad, y);
            doc.text(laborStr, margin + totalColWidth + cellPad, y);
            doc.text(label, margin + totalColWidth + laborColWidth + cellPad, y);
            var x = margin + totalColWidth + laborColWidth + itemColWidth;
            for (var k = 0; k < ledger.length; k++) {
              var fj = ledger[k].fixtures || {};
              var v = fj[label];
              var str = (v != null && v !== '') ? String(v) : '';
              doc.text(str, x + cellPad, y);
              x += colWidth;
            }
            y += lineHeight;
          });

          y += lineHeight;
          var totalRoughIn = 0, totalTopOut = 0, totalTrim = 0;
          fixtureLabels.forEach(function(label, idx) {
            var priceRow = FIXTURE_PRICES[fixtureIds[idx]];
            if (!priceRow) return;
            var totalQty = 0;
            for (var j = 0; j < ledger.length; j++) {
              var f = ledger[j].fixtures || {};
              var val = f[label];
              totalQty += (val != null && val !== '') ? (parseInt(val, 10) || 0) : 0;
            }
            totalRoughIn += totalQty * priceRow.roughIn;
            totalTopOut += totalQty * priceRow.topOut;
            totalTrim += totalQty * priceRow.trim;
          });
          doc.setFont(undefined, 'bold');
          doc.text('Total labor (est.): Rough in ' + formatNum(totalRoughIn, 1) + ', Top out ' + formatNum(totalTopOut, 1) + ', Trim ' + formatNum(totalTrim, 1), margin, y);
          doc.setFont(undefined, 'normal');

          doc.save('fixture-cover-page.pdf');
        } catch (e) {
          console.error(e);
          alert('Cover page PDF export failed.');
        }
      }

      function addTakeoffRow() {
        var container = $('takeoffRows');
        var row = document.createElement('div');
        row.className = 'takeoff-row';
        row.innerHTML = '<input type="text" placeholder="Item (e.g. Copper pipe 1/2\")" class="takeoff-desc"> <input type="text" placeholder="Qty" class="takeoff-qty"> <button type="button" class="takeoff-remove" aria-label="Remove row">Remove</button>';
        container.appendChild(row);
        row.querySelector('.takeoff-remove').addEventListener('click', function() {
          if (qsa('.takeoff-row').length > 1) row.remove();
        });
      }

      function addAdditionalLaborRow() {
        var container = $('additionalLaborRows');
        if (!container) return;
        var row = document.createElement('div');
        row.className = 'additional-labor-row';
        row.innerHTML = '<input type="text" class="additional-labor-desc" placeholder="Description (e.g. Demo, Underground, Prep)"> <input type="number" class="additional-labor-hours" min="0" step="0.5" placeholder="Hrs" title="Hours"> <select class="additional-labor-crew" title="Crew size"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select> <input type="number" class="additional-labor-rate" min="0" step="0.01" placeholder="Rate" title="Labor rate $/hr"> <button type="button" class="additional-labor-remove" aria-label="Remove row">Remove</button>';
        container.appendChild(row);
        qsa('input, select', row).forEach(function(el) {
          el.addEventListener('input', calculateTotals);
          el.addEventListener('change', calculateTotals);
        });
        var crew = parseInt((row.querySelector('.additional-labor-crew') || {}).value, 10) || 1;
        var rateEl = $('crewRate' + crew);
        var rate = (rateEl && parseFloat(rateEl.value)) || 0;
        var rateInput = row.querySelector('.additional-labor-rate');
        if (rateInput) rateInput.value = rate;
        calculateTotals();
      }

      function addAdditionalMaterialRow() {
        var container = $('additionalMaterialRows');
        if (!container) return;
        var row = document.createElement('div');
        row.className = 'additional-material-row';
        row.innerHTML = '<input type="text" class="additional-material-desc" placeholder="Description (e.g. Pipe, Fittings)"> <input type="number" class="additional-material-amount" min="0" step="0.01" placeholder="Amount" title="Amount ($)"> <button type="button" class="additional-material-remove" aria-label="Remove row">Remove</button>';
        container.appendChild(row);
        qsa('input', row).forEach(function(el) {
          el.addEventListener('input', calculateTotals);
          el.addEventListener('change', calculateTotals);
        });
        calculateTotals();
      }

      function buildShareState() {
        var fixtures = collectCurrentFixtures();
        var ledger = getFixtureLedger();
        var additionalLabor = [];
        qsa('.additional-labor-row').forEach(function(row) {
          var descEl = row.querySelector('.additional-labor-desc');
          var hoursEl = row.querySelector('.additional-labor-hours');
          var crewEl = row.querySelector('.additional-labor-crew');
          var rateEl = row.querySelector('.additional-labor-rate');
          additionalLabor.push({
            desc: descEl ? descEl.value : '',
            hours: hoursEl ? hoursEl.value : '',
            crew: crewEl ? crewEl.value : '1',
            rate: rateEl ? rateEl.value : ''
          });
        });
        var additionalMaterials = [];
        qsa('.additional-material-row').forEach(function(row) {
          var descEl = row.querySelector('.additional-material-desc');
          var amountEl = row.querySelector('.additional-material-amount');
          additionalMaterials.push({
            desc: descEl ? descEl.value : '',
            amount: amountEl ? amountEl.value : ''
          });
        });
        return { fixtures: fixtures, ledger: ledger, additionalLabor: additionalLabor, additionalMaterials: additionalMaterials };
      }

      function shareViaUrl() {
        var state = buildShareState();
        var payload = JSON.stringify(state);
        var encoded;
        try {
          encoded = btoa(unescape(encodeURIComponent(payload)));
        } catch (e) {
          encoded = btoa(payload);
        }
        var url = location.origin + location.pathname + (location.search || '') + '#' + encoded;
        try {
          window.history.replaceState(null, '', url);
        } catch (err) {
          window.location.hash = encoded;
        }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() {
            showShareFeedback('URL copied to clipboard');
          }).catch(function() {
            showShareFeedback('URL updated (copy from address bar)');
          });
        } else {
          showShareFeedback('URL updated (copy from address bar)');
        }
      }

      function showShareFeedback(message) {
        var btn = $('shareViaUrlBtn');
        if (!btn) return;
        var orig = btn.textContent;
        btn.textContent = message;
        btn.disabled = true;
        setTimeout(function() {
          btn.textContent = orig;
          btn.disabled = false;
        }, 2000);
      }

      function restoreFromShareHash() {
        var hash = location.hash;
        if (!hash || hash.length < 2) return;
        var encoded = hash.slice(1);
        var payload;
        try {
          var decoded = decodeURIComponent(escape(atob(encoded)));
          payload = JSON.parse(decoded);
        } catch (e) {
          return;
        }
        if (!payload || typeof payload.fixtures !== 'object') return;
        var ledger = Array.isArray(payload.ledger) ? payload.ledger : [];
        var additionalLabor = Array.isArray(payload.additionalLabor) ? payload.additionalLabor : [];
        var additionalMaterials = Array.isArray(payload.additionalMaterials) ? payload.additionalMaterials : [];

        Object.keys(payload.fixtures).forEach(function(label) {
          var id = fixtureLabelToId[label];
          var el = id ? $(id) : null;
          if (el && el.value !== undefined) {
            var val = payload.fixtures[label];
            el.value = val != null ? String(val) : '';
          }
        });

        setFixtureLedger(ledger);
        renderLedgerList();

        var laborContainer = $('additionalLaborRows');
        if (laborContainer) {
          qsa('.additional-labor-row', laborContainer).forEach(function(row) { row.remove(); });
          var items = additionalLabor.length ? additionalLabor : [{ desc: '', hours: '', crew: '1', rate: '' }];
          items.forEach(function(item) {
            var row = document.createElement('div');
            row.className = 'additional-labor-row';
            row.innerHTML = '<input type="text" class="additional-labor-desc" placeholder="Description (e.g. Demo, Underground, Prep)"> <input type="number" class="additional-labor-hours" min="0" step="0.5" placeholder="Hrs" title="Hours"> <select class="additional-labor-crew" title="Crew size"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select> <input type="number" class="additional-labor-rate" min="0" step="0.01" placeholder="Rate" title="Labor rate $/hr"> <button type="button" class="additional-labor-remove" aria-label="Remove row">Remove</button>';
            laborContainer.appendChild(row);
            var descEl = row.querySelector('.additional-labor-desc');
            var hoursEl = row.querySelector('.additional-labor-hours');
            var crewEl = row.querySelector('.additional-labor-crew');
            var rateEl = row.querySelector('.additional-labor-rate');
            if (descEl) descEl.value = item.desc != null ? String(item.desc) : '';
            if (hoursEl) hoursEl.value = item.hours != null ? String(item.hours) : '';
            if (crewEl) crewEl.value = item.crew != null ? String(item.crew) : '1';
            if (rateEl) rateEl.value = item.rate != null ? String(item.rate) : '';
            qsa('input, select', row).forEach(function(el) {
              el.addEventListener('input', calculateTotals);
              el.addEventListener('change', calculateTotals);
            });
            if (!(String((item.rate || '').trim())) && rateEl) {
              var crew = parseInt(crewEl ? crewEl.value : '1', 10) || 1;
              var rateFromCrew = $('crewRate' + crew);
              var rate = (rateFromCrew && parseFloat(rateFromCrew.value)) || 0;
              rateEl.value = rate;
            }
          });
        }

        var materialContainer = $('additionalMaterialRows');
        if (materialContainer) {
          qsa('.additional-material-row', materialContainer).forEach(function(row) { row.remove(); });
          var matItems = additionalMaterials.length ? additionalMaterials : [{ desc: '', amount: '' }];
          matItems.forEach(function(item) {
            var row = document.createElement('div');
            row.className = 'additional-material-row';
            row.innerHTML = '<input type="text" class="additional-material-desc" placeholder="Description (e.g. Pipe, Fittings)"> <input type="number" class="additional-material-amount" min="0" step="0.01" placeholder="Amount" title="Amount ($)"> <button type="button" class="additional-material-remove" aria-label="Remove row">Remove</button>';
            materialContainer.appendChild(row);
            var descEl = row.querySelector('.additional-material-desc');
            var amountEl = row.querySelector('.additional-material-amount');
            if (descEl) descEl.value = item.desc != null ? String(item.desc) : '';
            if (amountEl) amountEl.value = item.amount != null ? String(item.amount) : '';
            qsa('input', row).forEach(function(el) {
              el.addEventListener('input', calculateTotals);
              el.addEventListener('change', calculateTotals);
            });
          });
        }

        calculateTotals();
        updateRoughBid();
      }

      function setupIncrementDecrement() {
        document.body.addEventListener('click', function(e) {
          var btn = e.target;
          if (btn.tagName !== 'BUTTON' || !btn.getAttribute('data-target')) return;
          var id = btn.getAttribute('data-target');
          var input = $(id);
          if (!input || input.type !== 'number') return;
          var step = parseFloat(input.step) || 1;
          var val = parseFloat(input.value) || 0;
          if (btn.getAttribute('aria-label') === 'Increase') input.value = Math.max(0, val + step);
          else input.value = Math.max(0, val - step);
          input.dispatchEvent(new Event('input', { bubbles: true }));
        });
      }

      function clearForm() {
        document.getElementById('bidForm').reset();
        setDefaultDate();
        qsa('.takeoff-row').forEach(function(row, i) {
          if (i > 0) row.remove();
        });
        qsa('.takeoff-desc').forEach(function(el) { el.value = ''; });
        qsa('.takeoff-qty').forEach(function(el) { el.value = ''; });
        qsa('.additional-labor-row').forEach(function(row, i) {
          if (i > 0) row.remove();
        });
        qsa('.additional-labor-desc').forEach(function(el) { el.value = ''; });
        qsa('.additional-labor-hours').forEach(function(el) { el.value = ''; });
        qsa('.additional-labor-crew').forEach(function(el) { el.value = '1'; });
        qsa('.additional-labor-rate').forEach(function(el) { el.value = ''; });
        if ($('crewRate1')) $('crewRate1').value = '275';
        if ($('crewRate2')) $('crewRate2').value = '315';
        if ($('crewRate3')) $('crewRate3').value = '350';
        qsa('.additional-material-row').forEach(function(row, i) {
          if (i > 0) row.remove();
        });
        qsa('.additional-material-desc').forEach(function(el) { el.value = ''; });
        qsa('.additional-material-amount').forEach(function(el) { el.value = ''; });
        requiredIds.forEach(function(id) { var el = $(id); if (el) el.classList.remove('error'); });
        calculateTotals();
        $('preview').classList.remove('visible');
        $('preview').innerHTML = '';
      }

      function fillWithSampleData() {
        if ($('customerName')) $('customerName').value = 'Sample Customer';
        if ($('customerAddress')) $('customerAddress').value = '456 Oak Ave\nPortland, OR 97202';
        if ($('jobName')) $('jobName').value = 'Main floor bath and kitchen';
        if ($('jobAddress')) $('jobAddress').value = '123 Main St\nPortland, OR 97201';
        if ($('bidDate')) $('bidDate').value = new Date().toISOString().slice(0, 10);
        if ($('bidNumber')) $('bidNumber').value = '2025-SAMPLE-001';
        if ($('planName')) $('planName').value = 'Floor plans A';
        if ($('planIssueDate')) $('planIssueDate').value = '2024-06-15';
        if ($('planTitle')) $('planTitle').value = 'Main and upper';
        if ($('fixtureToilets')) $('fixtureToilets').value = 2;
        if ($('fixtureBathSinks')) $('fixtureBathSinks').value = 2;
        if ($('fixtureKitchenSinks')) $('fixtureKitchenSinks').value = 1;
        if ($('fixtureShowerOnly')) $('fixtureShowerOnly').value = 1;
        if ($('fixturePlanPageName')) $('fixturePlanPageName').value = 'A-101';
        var takeoffRows = qsa('.takeoff-row');
        if (takeoffRows[0]) {
          var desc = takeoffRows[0].querySelector('.takeoff-desc');
          var qty = takeoffRows[0].querySelector('.takeoff-qty');
          if (desc) desc.value = 'Copper pipe 1/2"';
          if (qty) qty.value = '150';
        }
        var laborRows = qsa('.additional-labor-row');
        if (laborRows[0]) {
          var d = laborRows[0].querySelector('.additional-labor-desc');
          var h = laborRows[0].querySelector('.additional-labor-hours');
          var c = laborRows[0].querySelector('.additional-labor-crew');
          var r = laborRows[0].querySelector('.additional-labor-rate');
          if (d) d.value = 'Demo and prep';
          if (h) h.value = 8;
          if (c) c.value = '2';
          if (r) r.value = 315;
        }
        var materialRows = qsa('.additional-material-row');
        if (materialRows[0]) {
          var md = materialRows[0].querySelector('.additional-material-desc');
          var ma = materialRows[0].querySelector('.additional-material-amount');
          if (md) md.value = 'Pipe and fittings';
          if (ma) ma.value = 2500;
        }
        if ($('materialsMarkupPct')) $('materialsMarkupPct').value = 0;
        if ($('laborMarkupPct')) $('laborMarkupPct').value = 0;
        if ($('scopeNotes')) $('scopeNotes').value = 'Sample scope: Rough-in and top-out per plans. Trim and fixture set by owner. Exclusions: owner-supplied fixtures, excavation, and final grading.';
        requiredIds.forEach(function(id) {
          var el = $(id);
          if (el) el.classList.remove('error');
        });
        calculateTotals();
      }

      function loadLedgerEntry(entry) {
        var planInput = $('fixturePlanPageName');
        if (planInput) planInput.value = entry.pageName || '';
        var f = entry.fixtures || {};
        Object.keys(f).forEach(function(label) {
          var id = fixtureLabelToId[label];
          if (id) {
            var el = $(id);
            if (el && el.type === 'number') el.value = Math.max(0, parseInt(f[label], 10) || 0);
          }
        });
        calculateTotals();
      }

      function renderLedgerList() {
        var listEl = $('fixtureLedgerList');
        if (!listEl) return;
        var ledger = getFixtureLedger();
        listEl.innerHTML = '';
        if (ledger.length === 0) {
          listEl.innerHTML = '<p class="fixture-ledger-empty">No saved plan pages. Enter a plan page name and fixture counts, then click Save to ledger.</p>';
          return;
        }
        ledger.forEach(function(entry) {
          var total = 0;
          var f = entry.fixtures || {};
          Object.keys(f).forEach(function(k) { total += (parseInt(f[k], 10) || 0); });
          var item = document.createElement('div');
          item.className = 'fixture-ledger-item';
          var nameEl = document.createElement('div');
          nameEl.className = 'fixture-ledger-item-name';
          nameEl.textContent = entry.pageName || 'Unnamed';
          var metaEl = document.createElement('div');
          metaEl.className = 'fixture-ledger-item-meta';
          metaEl.textContent = formatNum(total, 0) + ' fixture(s)';
          var actions = document.createElement('div');
          actions.className = 'fixture-ledger-item-actions';
          var loadBtn = document.createElement('button');
          loadBtn.type = 'button';
          loadBtn.className = 'btn btn-outline';
          loadBtn.textContent = 'Load';
          loadBtn.addEventListener('click', function() { loadLedgerEntry(entry); });
          var delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'btn btn-outline';
          delBtn.textContent = 'Delete';
          delBtn.style.color = 'var(--error)';
          delBtn.style.borderColor = 'var(--error)';
          delBtn.addEventListener('click', function() {
            var next = getFixtureLedger().filter(function(e) { return e.id !== entry.id; });
            setFixtureLedger(next);
            renderLedgerList();
            calculateTotals();
          });
          actions.appendChild(loadBtn);
          actions.appendChild(delBtn);
          item.appendChild(nameEl);
          item.appendChild(metaEl);
          item.appendChild(actions);
          listEl.appendChild(item);
        });
      }

      function saveToLedger() {
        var planInput = $('fixturePlanPageName');
        var pageName = (planInput && planInput.value) ? planInput.value.trim() : '';
        var ledger = getFixtureLedger();
        if (!pageName) pageName = 'Plan page ' + (ledger.length + 1);
        var fixtures = collectCurrentFixtures();
        var entry = {
          id: Date.now().toString(),
          pageName: pageName,
          fixtures: fixtures,
          savedAt: Date.now()
        };
        ledger.push(entry);
        setFixtureLedger(ledger);
        renderLedgerList();
        calculateTotals();
      }

      function clearFixtureCounts() {
        fixtureIds.forEach(function(id) {
          var el = $(id);
          if (el && el.type === 'number') el.value = 0;
        });
        calculateTotals();
      }

      function renderFixturePriceTable() {
        var tbody = $('fixturePriceTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';
        var ids = [
          'fixtureToilets', 'fixtureBathSinks', 'fixtureKitchenSinks', 'fixtureDisposals',
          'fixtureUrinals', 'fixtureTubs', 'fixtureShowerOnly', 'fixtureShowerTub',
          'fixtureLaundrySinks', 'fixtureHoseBibs', 'fixtureWaterFountain', 'fixtureWHGas', 'fixtureWHElectric',
          'fixtureWHTankless', 'fixtureGasDrops'
        ];
        ids.forEach(function(id) {
          var row = FIXTURE_PRICES[id];
          if (!row) return;
          var name = row.label;
          if (row.note) name += ' (' + row.note + ')';
          var tr = document.createElement('tr');
          var tdName = document.createElement('td');
          tdName.textContent = name;
          tr.appendChild(tdName);
          function makeInput(field, step) {
            var input = document.createElement('input');
            input.type = 'number';
            input.min = 0;
            input.step = step || 1;
            input.className = 'fixture-price-input';
            input.setAttribute('data-fixture-id', id);
            input.setAttribute('data-field', field);
            input.value = row[field];
            var td = document.createElement('td');
            td.appendChild(input);
            return td;
          }
          tr.appendChild(makeInput('price', 1));
          tr.appendChild(makeInput('roughIn', 0.5));
          tr.appendChild(makeInput('topOut', 0.5));
          tr.appendChild(makeInput('trim', 0.5));
          tbody.appendChild(tr);
        });
      }

      function syncFixturePriceInput(e) {
        var el = e.target;
        var id = el.getAttribute('data-fixture-id');
        var field = el.getAttribute('data-field');
        if (!id || !field || !FIXTURE_PRICES[id]) return;
        var val = parseFloat(el.value, 10);
        if (isNaN(val)) val = 0;
        FIXTURE_PRICES[id][field] = val;
      }

      function resetFixturePricesToDefault() {
        var modeDefaults = FIXTURE_MODES[currentFixtureMode] || {};
        Object.keys(modeDefaults).forEach(function(id) {
          var def = modeDefaults[id];
          if (!FIXTURE_PRICES[id]) FIXTURE_PRICES[id] = {};
          FIXTURE_PRICES[id].price = def.price;
          FIXTURE_PRICES[id].roughIn = def.roughIn;
          FIXTURE_PRICES[id].topOut = def.topOut;
          FIXTURE_PRICES[id].trim = def.trim;
        });
        renderFixturePriceTable();
        calculateTotals();
      }

      function hasFixturePriceChangesFromMode(modeName) {
        var base = FIXTURE_MODES[modeName];
        if (!base) return false;
        var ids = Object.keys(base);
        for (var i = 0; i < ids.length; i++) {
          var id = ids[i];
          var baseRow = base[id] || {};
          var currRow = FIXTURE_PRICES[id] || {};
          if (baseRow.price !== currRow.price ||
              baseRow.roughIn !== currRow.roughIn ||
              baseRow.topOut !== currRow.topOut ||
              baseRow.trim !== currRow.trim) {
            return true;
          }
        }
        return false;
      }

      function updateFixtureModeUi() {
        var select = $('fixtureModeSelect');
        if (select) {
          select.value = currentFixtureMode;
        }
        var status = $('fixtureModeStatus');
        var details = $('fixturePriceDetails');
        if (status) {
          if (currentFixtureMode === 'Trace') {
            status.textContent = 'TRACE MODE ACTIVE';
            status.classList.add('fixture-mode-status-trace');
          } else {
            status.textContent = 'Mode: Malachi';
            status.classList.remove('fixture-mode-status-trace');
          }
        }
        if (details) {
          if (currentFixtureMode === 'Trace') {
            details.classList.add('fixture-mode-trace');
          } else {
            details.classList.remove('fixture-mode-trace');
          }
        }
      }

      function setFixtureMode(modeName, opts) {
        opts = opts || {};
        var confirmIfChanged = opts.confirmIfChanged !== false;
        if (!FIXTURE_MODES[modeName]) return false;
        if (modeName === currentFixtureMode) {
          renderFixturePriceTable();
          calculateTotals();
          updateFixtureModeUi();
          return true;
        }
        if (confirmIfChanged && hasFixturePriceChangesFromMode(currentFixtureMode)) {
          var ok = window.confirm('You have custom fixture pricing. Switch to ' + modeName + ' mode and overwrite them with that mode\u2019s defaults?');
          if (!ok) {
            updateFixtureModeUi();
            return false;
          }
        }
        currentFixtureMode = modeName;
        var modeDefaults = FIXTURE_MODES[currentFixtureMode];
        FIXTURE_PRICES = JSON.parse(JSON.stringify(modeDefaults));
        try {
          localStorage.setItem('bidtoolingFixtureMode', currentFixtureMode);
        } catch (e) {
          // ignore
        }
        renderFixturePriceTable();
        calculateTotals();
        updateFixtureModeUi();
        return true;
      }

      $('generatePreview').addEventListener('click', onGeneratePreview);
      $('printBtn').addEventListener('click', onPrint);
      $('exportPdf').addEventListener('click', openExternalSummaryModal);
      $('externalSummaryDownloadPdf').addEventListener('click', function() {
        exportToPDF($('externalSummaryNotes').value);
      });
      $('externalSummaryPrint').addEventListener('click', function() {
        $('externalSummaryPrintNotes').textContent = $('externalSummaryNotes').value;
        document.body.classList.add('print-external-summary');
        setTimeout(function() { window.print(); document.body.classList.remove('print-external-summary'); }, 100);
      });
      $('externalSummaryClose').addEventListener('click', closeExternalSummaryModal);
      $('addTakeoffRow').addEventListener('click', addTakeoffRow);
      if ($('fillSample')) $('fillSample').addEventListener('click', fillWithSampleData);
      if ($('shareViaUrlBtn')) $('shareViaUrlBtn').addEventListener('click', shareViaUrl);
      if ($('addAdditionalLaborRow')) $('addAdditionalLaborRow').addEventListener('click', addAdditionalLaborRow);
      if ($('addAdditionalMaterialRow')) $('addAdditionalMaterialRow').addEventListener('click', addAdditionalMaterialRow);
      var additionalMaterialRowsEl = $('additionalMaterialRows');
      if (additionalMaterialRowsEl) {
        additionalMaterialRowsEl.addEventListener('click', function(e) {
          if (e.target.classList.contains('additional-material-remove') && qsa('.additional-material-row').length > 1) {
            e.target.closest('.additional-material-row').remove();
            calculateTotals();
          }
        });
      }
      if ($('openCrewPricing')) {
        $('openCrewPricing').addEventListener('click', function() {
          var details = $('crewPricingDetails');
          if (details) {
            details.open = !details.open;
            this.setAttribute('aria-expanded', details.open ? 'true' : 'false');
            if (details.open) details.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      }
      var crewPricingDetailsEl = $('crewPricingDetails');
      if (crewPricingDetailsEl) {
        crewPricingDetailsEl.addEventListener('toggle', function() {
          var btn = $('openCrewPricing');
          if (btn) btn.setAttribute('aria-expanded', this.open ? 'true' : 'false');
        });
      }
      var additionalLaborRowsEl = $('additionalLaborRows');
      if (additionalLaborRowsEl) {
        additionalLaborRowsEl.addEventListener('click', function(e) {
          if (e.target.classList.contains('additional-labor-remove') && qsa('.additional-labor-row').length > 1) {
            e.target.closest('.additional-labor-row').remove();
            calculateTotals();
          }
        });
        additionalLaborRowsEl.addEventListener('change', function(e) {
          if (e.target.classList.contains('additional-labor-crew')) {
            var row = e.target.closest('.additional-labor-row');
            if (!row) return;
            var crew = parseInt(e.target.value, 10) || 1;
            var rateEl = $('crewRate' + crew);
            var rate = (rateEl && parseFloat(rateEl.value)) || 0;
            var rateInput = row.querySelector('.additional-labor-rate');
            if (rateInput) rateInput.value = rate;
            calculateTotals();
          }
        });
        additionalLaborRowsEl.addEventListener('input', function(e) {
          if (e.target.classList.contains('additional-labor-desc') || e.target.classList.contains('additional-labor-hours')) {
            var row = e.target.closest('.additional-labor-row');
            if (!row) return;
            var rateInput = row.querySelector('.additional-labor-rate');
            if (!rateInput || String(rateInput.value || '').trim() !== '') return;
            var crew = parseInt((row.querySelector('.additional-labor-crew') || {}).value, 10) || 1;
            var rateEl = $('crewRate' + crew);
            var rate = (rateEl && parseFloat(rateEl.value)) || 0;
            rateInput.value = rate;
            calculateTotals();
          }
        });
      }
      $('clearBtn').addEventListener('click', clearForm);
      var roughCalculatorBtn = $('roughCalculatorBtn');
      var roughCalculatorSection = $('roughCalculatorSection');
      if (roughCalculatorBtn && roughCalculatorSection) {
        roughCalculatorBtn.addEventListener('click', function() {
          var isHidden = roughCalculatorSection.classList.contains('hidden');
          if (isHidden) {
            roughCalculatorSection.classList.remove('hidden');
            roughCalculatorSection.setAttribute('aria-hidden', 'false');
            roughCalculatorBtn.setAttribute('aria-expanded', 'true');
            roughCalculatorSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            updateRoughBid();
          } else {
            roughCalculatorSection.classList.add('hidden');
            roughCalculatorSection.setAttribute('aria-hidden', 'true');
            roughCalculatorBtn.setAttribute('aria-expanded', 'false');
          }
        });
      }
      if ($('fixtureLaborCostWrap')) {
        $('fixtureLaborCostWrap').addEventListener('click', function() {
          var costEl = $('fixtureLaborCost');
          if (!costEl) return;
          var raw = parseFloat(costEl.getAttribute('data-raw-value')) || 0;
          var fmt = costEl.getAttribute('data-format') || 'short';
          if (fmt === 'short') {
            costEl.setAttribute('data-format', 'long');
            costEl.textContent = raw.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          } else {
            costEl.setAttribute('data-format', 'short');
            costEl.textContent = formatFixtureCostShort(raw);
          }
        });
      }
      if ($('saveToLedger')) $('saveToLedger').addEventListener('click', saveToLedger);
      if ($('exportCoverPage')) $('exportCoverPage').addEventListener('click', exportCoverPage);
      if ($('clearFixtureCounts')) $('clearFixtureCounts').addEventListener('click', clearFixtureCounts);
      if ($('resetFixturePrices')) $('resetFixturePrices').addEventListener('click', resetFixturePricesToDefault);
      var fixturePriceTable = $('fixturePriceTable');
      if (fixturePriceTable) {
        fixturePriceTable.addEventListener('input', syncFixturePriceInput);
        fixturePriceTable.addEventListener('change', syncFixturePriceInput);
      }

      var fixtureModeSelectEl = $('fixtureModeSelect');
      if (fixtureModeSelectEl) {
        fixtureModeSelectEl.addEventListener('change', function(e) {
          var newMode = e.target.value;
          if (!FIXTURE_MODES[newMode]) {
            updateFixtureModeUi();
            return;
          }
          var ok = setFixtureMode(newMode, { confirmIfChanged: true });
          if (!ok) {
            updateFixtureModeUi();
          }
        });
      }

      qsa('input, select, textarea').forEach(function(el) {
        el.addEventListener('input', calculateTotals);
        el.addEventListener('change', calculateTotals);
      });
      var roughCalcContent = $('roughCalculatorContent');
      if (roughCalcContent) {
        qsa('input', roughCalcContent).forEach(function(el) {
          el.addEventListener('input', updateRoughBid);
          el.addEventListener('change', updateRoughBid);
        });
      }
      var clearRoughCalculatorBtn = $('clearRoughCalculatorBtn');
      if (clearRoughCalculatorBtn) {
        clearRoughCalculatorBtn.addEventListener('click', function() {
          var ids = ['roughLength', 'roughWidth', 'roughSfFromDimensions', 'roughCostPerSqFt', 'roughFixtureCountOverride', 'roughPricePerFixture'];
          ids.forEach(function(id) {
            var el = $(id);
            if (el && el.value !== undefined) el.value = '';
          });
          updateRoughBid();
        });
      }
      setupIncrementDecrement();

      function initializeFixtureMode() {
        var saved = null;
        try {
          saved = localStorage.getItem('bidtoolingFixtureMode');
        } catch (e) {
          saved = null;
        }
        var initialMode = (saved && FIXTURE_MODES[saved]) ? saved : DEFAULT_FIXTURE_MODE;
        setFixtureMode(initialMode, { confirmIfChanged: false });
      }

      document.addEventListener('DOMContentLoaded', function() {
        initializeFixtureMode();
        renderLedgerList();
        restoreFromShareHash();
      });
    })();
  </script>
</body>
</html>
