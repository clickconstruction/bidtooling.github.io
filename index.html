<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <title>Plumbing Bid Worksheet - Click Plumbing and Electrical</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --primary: #003366;
      --secondary: #0066CC;
      --bg: #F5F5F5;
      --text: #333333;
      --card-bg: #ffffff;
      --border: #ddd;
      --error: #c00;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      color: var(--text);
      background: var(--bg);
      padding: 1rem;
    }
    .container { max-width: 960px; margin: 0 auto; }
    .app-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    h1, h2, h3 { color: var(--primary); margin-top: 0; }
    h2 { font-size: 1.25rem; border-bottom: 2px solid var(--secondary); padding-bottom: 0.25rem; margin-bottom: 1rem; }
    .section {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .section.section-takeoff { background: #f0f0f0; }
    .section-takeoff button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .section-rough-calculator { background: #fffde7; }
    .section-rough-calculator.hidden { display: none; }
    .section-rough-calculator .field.field-disabled { opacity: 0.65; color: #666; }
    .section-rough-calculator .field.field-disabled input { cursor: not-allowed; }
    .rough-calc-dimensions-row { align-items: flex-end; }
    .rough-calc-op { font-size: 1.25rem; font-weight: 600; color: var(--primary); padding: 0 0.25rem; margin-bottom: 0.5rem; }
    .section-rough-calculator .rough-calc-cost-input { width: calc((100% - 2rem - 4ch) / 3); max-width: 100%; box-sizing: border-box; }
    label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
    input[type="text"], input[type="number"], input[type="date"], select, textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 2px rgba(0,102,204,0.2);
    }
    input.error, select.error, textarea.error { border-color: var(--error); }
    .form-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .form-row .field { flex: 1; min-width: 0; }
    .fixture-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }
    .fixture-item { display: flex; flex-direction: column; }
    .fixture-item label { font-size: 0.875rem; }
    .number-input-wrap { display: flex; align-items: center; gap: 0.25rem; }
    .number-input-wrap input { width: 4rem; text-align: center; }
    .number-input-wrap button {
      width: 2rem; height: 2rem;
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
      color: var(--primary);
    }
    .number-input-wrap button:hover { background: #e0e0e0; }
    .takeoff-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
    .takeoff-row .takeoff-desc { flex: 2; min-width: 0; }
    .takeoff-row .takeoff-qty { flex: 1; min-width: 80px; }
    .takeoff-row button { flex-shrink: 0; padding: 0.5rem; cursor: pointer; border: 1px solid var(--border); background: #fff; border-radius: 6px; color: var(--error); }
    .additional-labor-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
    .additional-labor-row .additional-labor-desc { flex: 2; min-width: 0; }
    .additional-labor-row .additional-labor-hours { flex: 0 0 5rem; max-width: 6rem; }
    .additional-labor-row .additional-labor-crew { flex: 0 0 4rem; max-width: 4rem; }
    .additional-labor-row .additional-labor-rate { flex: 0 0 5.5rem; max-width: 6rem; }
    .additional-labor-row .additional-labor-remove { flex-shrink: 0; padding: 0.5rem; cursor: pointer; border: 1px solid var(--border); background: #fff; border-radius: 6px; color: var(--error); }
    .additional-labor-header { display: flex; gap: 0.5rem; margin-bottom: 0.25rem; align-items: center; font-size: 0.875rem; font-weight: 500; color: #555; }
    .additional-labor-header .additional-labor-hdr-desc { flex: 2; min-width: 0; }
    .additional-labor-header .additional-labor-hdr-hours { flex: 0 0 5rem; max-width: 6rem; text-align: center; }
    .additional-labor-header .additional-labor-hdr-crew { flex: 0 0 4rem; max-width: 4rem; text-align: center; }
    .additional-labor-header .additional-labor-hdr-rate { flex: 0 0 5.5rem; max-width: 6rem; text-align: center; }
    .additional-labor-header .additional-labor-hdr-remove { flex-shrink: 0; width: 5rem; }
    .additional-material-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
    .additional-material-row .additional-material-desc { flex: 2; min-width: 0; }
    .additional-material-row .additional-material-amount { flex: 0 0 6rem; max-width: 7rem; }
    .additional-material-row .additional-material-remove { flex-shrink: 0; padding: 0.5rem; cursor: pointer; border: 1px solid var(--border); background: #fff; border-radius: 6px; color: var(--error); }
    .additional-material-header { display: flex; gap: 0.5rem; margin-bottom: 0.25rem; align-items: center; font-size: 0.875rem; font-weight: 500; color: #555; }
    .additional-material-header .additional-material-hdr-desc { flex: 2; min-width: 0; }
    .additional-material-header .additional-material-hdr-amount { flex: 0 0 6rem; max-width: 7rem; text-align: center; }
    .additional-material-header .additional-material-hdr-remove { flex-shrink: 0; width: 5rem; }
    .actions { display: flex; flex-wrap: wrap; gap: 0.75rem; margin: 1.5rem 0; align-items: flex-start; }
    .actions .btn-push-right { margin-left: auto; }
    .internal-summary-box { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 1rem 1.25rem; text-align: center; }
    .internal-summary-box .internal-summary-title { font-size: 1rem; margin: 0 0 0.75rem 0; color: var(--primary); font-weight: 600; }
    .internal-summary-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; }
    .letterhead-link { display: block; text-align: center; color: var(--primary); transition: opacity 0.2s; }
    .letterhead-link:hover { opacity: 0.85; }
    .letterhead-icon { width: 2.5rem; height: 2.5rem; display: inline-block; fill: currentColor; vertical-align: middle; }
    .share-via-url-icon, .share-via-email-icon { width: 2.5rem; height: 2.5rem; display: block; fill: currentColor; }
    .share-via-url-trigger { display: inline-block; cursor: pointer; color: var(--primary); transition: opacity 0.2s; }
    .share-url-actions { display: inline-flex; align-items: center; gap: 0.5rem; }
    .share-via-url-trigger:hover { opacity: 0.85; }
    .share-via-url-trigger:focus { outline: 2px solid var(--primary); outline-offset: 2px; }
    .letterhead-icons { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; }
    .google-doc-steps { display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; }
    .google-doc-arrow { color: #000; font-weight: bold; font-size: 1rem; }
    .google-doc-make-a-copy { height: 2rem; width: auto; vertical-align: middle; }
    .google-doc-shortcut { font-size: 0.9rem; font-family: inherit; }
    .btn {
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.05s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #002244; }
    .btn-secondary { background: var(--secondary); color: #fff; }
    .btn-secondary:hover { background: #0052a3; }
    .btn-outline { background: #fff; color: var(--primary); border: 2px solid var(--primary); }
    .btn-outline:hover { background: var(--bg); }
    .btn-primary.view-active { background: #E85D04; }
    .btn-primary.view-active:hover { background: #c95203; }
    #preview {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 2rem;
      margin-top: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }
    #preview.visible { display: block; }
    .share-url-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 9999; }
    .share-url-modal.visible { display: flex; }
    .share-url-modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.4); cursor: pointer; }
    .share-url-modal-dialog { position: relative; background: var(--card-bg); padding: 1.5rem; border-radius: 8px; max-width: 24rem; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .share-url-modal-dialog h2 { margin: 0 0 0.75rem 0; font-size: 1.125rem; }
    .share-url-modal-message { margin: 0 0 1rem 0; line-height: 1.4; }
    .share-url-modal-dialog .btn { width: 100%; }
    #externalSummaryPreview.external-summary-inline {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 2rem;
      margin-top: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }
    #externalSummaryPreview.external-summary-inline.visible { display: block; }
    .preview-header { text-align: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--primary); }
    .preview-header h1 { font-size: 1.5rem; margin: 0; }
    .preview-logo { width: 80px; height: 80px; margin: 0 auto 0.5rem; }
    .preview-logo svg { width: 100%; height: 100%; display: block; }
    .preview-meta { font-size: 0.9rem; color: #666; }
    .preview-section { margin-bottom: 1.25rem; }
    .preview-section h3 { font-size: 1rem; margin-bottom: 0.5rem; color: var(--primary); }
    .preview-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .preview-table th, .preview-table td { border: 1px solid var(--border); padding: 0.5rem 0.75rem; text-align: left; }
    .preview-table th { background: var(--bg); font-weight: 600; }
    .grand-total { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-top: 1rem; padding: 1rem; background: var(--bg); border-radius: 8px; text-align: right; }
    .fixture-header-row { display: flex; flex-wrap: wrap; align-items: flex-end; justify-content: space-between; gap: 1rem; margin-bottom: 1rem; }
    .fixture-header-row h2 { margin-bottom: 0; }
    .fixture-plan-page-wrap { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
    .fixture-plan-page-wrap label { margin-bottom: 0; margin-right: 0; }
    .fixture-plan-page-wrap input { width: auto; min-width: 140px; max-width: 200px; }
    .fixture-section-wrap { display: flex; gap: 1.5rem; align-items: flex-start; }
    .fixture-form-col { flex: 1; min-width: 0; }
    .fixture-form-col h3:not(:first-of-type) { margin-top: 1.25rem; }
    .fixture-ledger-col { flex: 0 0 280px; background: var(--bg); border-radius: 8px; padding: 1rem; border: 1px solid var(--border); }
    .fixture-ledger-col h3 { font-size: 1rem; margin-bottom: 0.75rem; }
    .fixture-ledger-list { max-height: 400px; overflow-y: auto; }
    .fixture-ledger-item { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
    .fixture-ledger-item:last-child { border-bottom: none; }
    .fixture-ledger-item-name { font-weight: 500; flex: 1 1 100%; }
    .fixture-ledger-item-meta { font-size: 0.8rem; color: #666; margin-bottom: 0.25rem; }
    .fixture-ledger-item-actions { display: flex; gap: 0.35rem; }
    .fixture-ledger-item-actions .btn { padding: 0.35rem 0.6rem; font-size: 0.85rem; }
    .fixture-ledger-empty { color: #666; font-size: 0.9rem; padding: 0.5rem 0; }
    .fixture-price-reference { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); }
    .fixture-price-details { border: 1px solid var(--border); border-radius: 8px; padding: 0 0.75rem 0 0; }
    .fixture-price-details[open] { padding-bottom: 0.75rem; }
    .fixture-price-summary { font-size: 1rem; font-weight: 600; color: var(--primary); cursor: pointer; padding: 0.5rem 0; list-style: none; user-select: none; }
    .fixture-price-summary::-webkit-details-marker { display: none; }
    .fixture-price-summary::before { content: '▸ '; display: inline-block; transition: transform 0.2s; }
    .fixture-price-details[open] .fixture-price-summary::before { transform: rotate(90deg); }
    .fixture-price-details-content { margin-top: 0.5rem; }
    .fixture-labor-details { border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; }
    .fixture-labor-summary { padding: 0; margin: 0; }
    .fixture-labor-breakdown { margin-top: 0.5rem; font-size: 0.9rem; color: #555; }
    .fixture-labor-breakdown p { margin: 0.25rem 0; }
    .fixture-cost-toggle { cursor: pointer; }
    .crew-pricing-link { background: none; border: none; padding: 0; font: inherit; color: var(--secondary); cursor: pointer; text-decoration: underline; }
    .additional-labor-title-row .crew-pricing-link { margin-left: auto; }
    .crew-pricing-link:hover { color: #004499; }
    .additional-labor-title-row { display: flex; flex-wrap: wrap; align-items: flex-start; gap: 1rem; margin-bottom: 0; }
    .additional-labor-title-row > p { flex: 1; min-width: 0; }
    .additional-labor-title-row .crew-pricing-details { flex-shrink: 0; margin: 0; }
    #crewPricingDetails .fixture-price-details-content label { display: inline-block; min-width: 4rem; text-align: center; }
    #crewPricingDetails summary { display: none; }
    .fixture-price-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .fixture-price-table th, .fixture-price-table td { border: 1px solid var(--border); padding: 0.4rem 0.6rem; text-align: left; }
    .fixture-price-table th { background: var(--bg); font-weight: 600; }
    .fixture-price-table tbody tr:nth-child(even) { background: rgba(0,0,0,0.03); }
    .fixture-price-input { width: 4.5rem; max-width: 100%; padding: 0.35rem 0.5rem; font-size: 0.9rem; border: 1px solid var(--border); border-radius: 6px; }
    .fixture-price-table .fixture-price-input { box-sizing: border-box; }
    .fixture-mode-row { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin: 0.25rem 0 0.75rem 0; font-size: 0.9rem; }
    .fixture-mode-row label { margin-bottom: 0; font-weight: 500; }
    .fixture-mode-select { min-width: 140px; }
    .fixture-mode-status { margin-left: auto; font-weight: 600; color: var(--primary); }
    .fixture-price-details.fixture-mode-trace { border-color: #e09f3e; box-shadow: 0 0 0 1px rgba(224,159,62,0.4); }
    .fixture-price-details.fixture-mode-trace .fixture-price-summary { color: #9a4a00; }
    .fixture-mode-status-trace { color: #9a4a00; }
    @media print {
      body.print-external-summary .container .app-top-bar,
      body.print-external-summary .container form,
      body.print-external-summary .container #preview { display: none !important; }
      body.print-external-summary #externalSummaryPreview { display: block !important; }
    }
    @media (max-width: 768px) {
      body { padding: 0.75rem; }
      .section { padding: 1rem; }
      .btn { min-height: 44px; padding: 0.875rem 1.25rem; }
      .number-input-wrap button { min-width: 44px; min-height: 44px; }
    }
    @media (max-width: 640px) {
      .form-row { flex-direction: column; }
      .fixture-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
      .takeoff-row { flex-wrap: wrap; }
      .additional-labor-row { flex-wrap: wrap; }
      .additional-labor-header { flex-wrap: wrap; }
      .additional-material-row { flex-wrap: wrap; }
      .additional-material-header { flex-wrap: wrap; }
      .actions { flex-direction: column; }
      .actions .btn { width: 100%; }
      .fixture-section-wrap { flex-direction: column; }
      .fixture-ledger-col { flex: 1 1 100%; max-width: none; }
      .fixture-header-row { flex-direction: column; align-items: stretch; }
      .fixture-plan-page-wrap input { max-width: none; }
    }
    @media print {
      body { background: #fff; padding: 0; }
      .no-print { display: none !important; }
      #preview { display: block !important; box-shadow: none; padding: 0; }
      .section { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="app-top-bar no-print">
      <button type="button" id="fillSample" class="btn btn-outline">Fill with sample</button>
      <button type="button" id="clearAllFieldsBtn" class="btn btn-outline" title="Viewing someone else's plan? Clear the form to start fresh.">Clear all fields</button>
    </div>
    <form id="bidForm" class="no-print">
      <div class="section">
        <h2>Job Information</h2>
        <div class="form-row">
          <div class="field">
            <label for="customerName">Customer Name *</label>
            <input type="text" id="customerName" name="customerName" required placeholder="Customer name">
          </div>
          <div class="field">
            <label for="customerAddress">Customer Address</label>
            <textarea id="customerAddress" name="customerAddress" rows="2" placeholder="Street, City, State ZIP (optional)"></textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="jobName">Job Name</label>
            <input type="text" id="jobName" name="jobName" placeholder="e.g. Kitchen remodel (optional)">
          </div>
          <div class="field">
            <label for="jobAddress">Job Address *</label>
            <textarea id="jobAddress" name="jobAddress" rows="2" required placeholder="Street, City, State ZIP"></textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="bidDate">Bid Date *</label>
            <input type="date" id="bidDate" name="bidDate" required>
          </div>
          <div class="field">
            <label for="bidNumber">Bid Number *</label>
            <input type="text" id="bidNumber" name="bidNumber" required placeholder="e.g. 2024-001">
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="planName">Plan Name</label>
            <input type="text" id="planName" name="planName" placeholder="Plan name">
          </div>
          <div class="field">
            <label for="planIssueDate">Plan Issue Date</label>
            <input type="date" id="planIssueDate" name="planIssueDate">
          </div>
          <div class="field">
            <label for="planTitle">Plan Title</label>
            <input type="text" id="planTitle" name="planTitle" placeholder="Plan title">
          </div>
        </div>
      </div>

      <div class="section" id="fixtureCountsSection">
        <div class="fixture-header-row">
          <h2>Fixture Counts</h2>
          <div class="fixture-plan-page-wrap">
            <label for="fixturePlanPageName">Plan page:</label>
            <input type="text" id="fixturePlanPageName" name="fixturePlanPageName" placeholder="e.g. A-101, Floor 2">
            <button type="button" id="saveToLedger" class="btn btn-secondary">Save to ledger</button>
          </div>
        </div>
        <div class="fixture-section-wrap">
          <div class="fixture-form-col">
        <p><strong>Total fixtures: <span id="totalFixtures">0</span></strong></p>
        <h3>Bathrooms</h3>
        <div class="fixture-grid" id="fixturesBathrooms">
          <div class="fixture-item">
            <label for="fixtureToilets">Toilets</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureToilets">−</button>
              <input type="number" id="fixtureToilets" name="fixtureToilets" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureToilets">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureBathSinks">Bathroom sinks</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureBathSinks">−</button>
              <input type="number" id="fixtureBathSinks" name="fixtureBathSinks" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureBathSinks">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureShowerTub">Shower/tub combos</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureShowerTub">−</button>
              <input type="number" id="fixtureShowerTub" name="fixtureShowerTub" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureShowerTub">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureShowerOnly">Showers no tub</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureShowerOnly">−</button>
              <input type="number" id="fixtureShowerOnly" name="fixtureShowerOnly" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureShowerOnly">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureTubs">Bathtubs</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureTubs">−</button>
              <input type="number" id="fixtureTubs" name="fixtureTubs" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureTubs">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureUrinals">Urinals</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureUrinals">−</button>
              <input type="number" id="fixtureUrinals" name="fixtureUrinals" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureUrinals">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWaterClosets">Water closets</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWaterClosets">−</button>
              <input type="number" id="fixtureWaterClosets" name="fixtureWaterClosets" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWaterClosets">+</button>
            </div>
          </div>
        </div>
        <h3>Kitchen</h3>
        <div class="fixture-grid">
          <div class="fixture-item">
            <label for="fixtureKitchenSinks">Kitchen sinks</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureKitchenSinks">−</button>
              <input type="number" id="fixtureKitchenSinks" name="fixtureKitchenSinks" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureKitchenSinks">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureDisposals">Garbage disposals</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureDisposals">−</button>
              <input type="number" id="fixtureDisposals" name="fixtureDisposals" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureDisposals">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureIceMakers">Ice makers</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureIceMakers">−</button>
              <input type="number" id="fixtureIceMakers" name="fixtureIceMakers" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureIceMakers">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixturePotFiller">Pot filler</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixturePotFiller">−</button>
              <input type="number" id="fixturePotFiller" name="fixturePotFiller" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixturePotFiller">+</button>
            </div>
          </div>
        </div>
        <h3>Laundry</h3>
        <div class="fixture-grid">
          <div class="fixture-item">
            <label for="fixtureLaundrySinks">Laundry sinks</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureLaundrySinks">−</button>
              <input type="number" id="fixtureLaundrySinks" name="fixtureLaundrySinks" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureLaundrySinks">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWashingMachine">Washing machine</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWashingMachine">−</button>
              <input type="number" id="fixtureWashingMachine" name="fixtureWashingMachine" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWashingMachine">+</button>
            </div>
          </div>
        </div>
        <h3>Plumbing Fixtures</h3>
        <div class="fixture-grid">
          <div class="fixture-item">
            <label for="fixtureHoseBibs">Hose bibs</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureHoseBibs">−</button>
              <input type="number" id="fixtureHoseBibs" name="fixtureHoseBibs" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureHoseBibs">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWaterFountain">Water fountain</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWaterFountain">−</button>
              <input type="number" id="fixtureWaterFountain" name="fixtureWaterFountain" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWaterFountain">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureGasDrops">Gas drops</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureGasDrops">−</button>
              <input type="number" id="fixtureGasDrops" name="fixtureGasDrops" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureGasDrops">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureFloorDrains">Floor drains</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureFloorDrains">−</button>
              <input type="number" id="fixtureFloorDrains" name="fixtureFloorDrains" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureFloorDrains">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureDogWash">Dog wash</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureDogWash">−</button>
              <input type="number" id="fixtureDogWash" name="fixtureDogWash" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureDogWash">+</button>
            </div>
          </div>
        </div>
        <h3>Appliances</h3>
        <div class="fixture-grid">
          <div class="fixture-item">
            <label for="fixtureWHGas">Water heaters (gas)</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWHGas">−</button>
              <input type="number" id="fixtureWHGas" name="fixtureWHGas" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWHGas">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWHElectric">Water heaters (electric)</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWHElectric">−</button>
              <input type="number" id="fixtureWHElectric" name="fixtureWHElectric" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWHElectric">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWHTankless">Water heaters (tankless)</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWHTankless">−</button>
              <input type="number" id="fixtureWHTankless" name="fixtureWHTankless" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWHTankless">+</button>
            </div>
          </div>
          <div class="fixture-item">
            <label for="fixtureWaterSoftener">Water softener</label>
            <div class="number-input-wrap">
              <button type="button" aria-label="Decrease" data-target="fixtureWaterSoftener">−</button>
              <input type="number" id="fixtureWaterSoftener" name="fixtureWaterSoftener" min="0" value="0">
              <button type="button" aria-label="Increase" data-target="fixtureWaterSoftener">+</button>
            </div>
          </div>
        </div>
          </div>
          <div class="fixture-ledger-col">
            <h3>Plan pages</h3>
            <div id="fixtureLedgerList" class="fixture-ledger-list"></div>
            <button type="button" id="exportCoverPage" class="btn btn-outline" style="margin-top: 0.75rem;">Export Labor Page</button>
          </div>
        </div>
        <p style="margin-top: 1rem; margin-bottom: 0;">
          <button type="button" id="clearFixtureCounts" class="btn btn-outline">Clear counts</button>
        </p>
        <div class="fixture-price-reference">
          <details class="fixture-price-details" id="fixturePriceDetails">
            <summary class="fixture-price-summary">Fixture Prices and Labor</summary>
            <div class="fixture-price-details-content">
          <div class="fixture-mode-row">
            <label for="fixtureModeSelect">Fixture mode:</label>
            <select id="fixtureModeSelect" class="fixture-mode-select">
              <option value="Malachi">Malachi (default)</option>
              <option value="Trace">Trace</option>
            </select>
            <span id="fixtureModeStatus" class="fixture-mode-status"></span>
          </div>
          <table class="fixture-price-table" id="fixturePriceTable" aria-label="Fixture prices and labor">
            <thead>
              <tr>
                <th>Fixture</th>
                <th>Price</th>
                <th>Rough in</th>
                <th>Top out</th>
                <th>Trim</th>
              </tr>
            </thead>
            <tbody id="fixturePriceTableBody"></tbody>
          </table>
          <button type="button" id="resetFixturePrices" class="btn btn-outline" style="margin-top: 0.75rem;">Reset to default</button>
          <button type="button" id="exportFixturePricesBtn" class="btn btn-outline" style="margin-top: 0.75rem;">Export my prices and times</button>
            </div>
          </details>
        </div>
      </div>

      <div class="section section-takeoff">
        <h2>Fixture Materials (coming soon from <a href="https://pipetooling.com" target="_blank" rel="noopener noreferrer">PipeTooling.com</a>)</h2>
        <div id="takeoffRows">
          <div class="takeoff-row">
            <input type="text" placeholder="Item (e.g. Copper pipe 1/2\")" class="takeoff-desc">
            <input type="text" placeholder="Qty" class="takeoff-qty">
            <button type="button" class="takeoff-remove" aria-label="Remove row">Remove</button>
          </div>
        </div>
        <button type="button" id="addTakeoffRow" class="btn btn-outline" style="margin-top: 0.5rem;" disabled>Add row</button>
      </div>

      <div class="section">
        <h2>Labor Estimate</h2>
        <div class="fixture-labor-details" style="margin-bottom: 0.75rem;">
          <p class="fixture-labor-heading" style="margin: 0 0 0.25rem 0; font-weight: 600;">Fixture labor</p>
          <p class="fixture-labor-summary" style="margin: 0 0 0.5rem 0;"><strong><span id="fixtureLaborCount">0</span></strong><span id="fixtureLaborCountLabel"> Fixtures</span> / <strong><span id="fixtureLaborHours">0</span></strong> hours / <strong class="fixture-cost-toggle" id="fixtureLaborCostWrap" title="Click to toggle decimals">$<span id="fixtureLaborCost">0</span></strong></p>
          <div class="fixture-labor-breakdown">
            <p>Rough in: <strong><span id="fixtureLaborRoughIn">0</span></strong> hours</p>
            <p>Top out: <strong><span id="fixtureLaborTopOut">0</span></strong> hours</p>
            <p>Trim: <strong><span id="fixtureLaborTrim">0</span></strong> hours</p>
          </div>
        </div>
        <div class="additional-labor-block" style="margin-bottom: 1rem;">
          <div class="additional-labor-title-row">
            <p style="margin: 0 0 0.5rem 0; font-weight: 500;">Additional labor (work other than fixtures)</p>
            <details class="fixture-price-details crew-pricing-details" id="crewPricingDetails">
              <summary class="fixture-price-summary">Crew pricing ($/hr)</summary>
              <div class="fixture-price-details-content">
                <p style="margin: 0.5rem 0 0.25rem 0;"><label for="crewRate1">1 Tech</label><input type="number" id="crewRate1" name="crewRate1" min="0" step="0.01" value="275" style="max-width: 6rem;"> $/hr</p>
                <p style="margin: 0.25rem 0;"><label for="crewRate2">Plumber and Helper</label><input type="number" id="crewRate2" name="crewRate2" min="0" step="0.01" value="315" style="max-width: 6rem;"> $/hr</p>
                <p style="margin: 0.25rem 0 0.5rem 0;"><label for="crewRate3">3 Techs</label><input type="number" id="crewRate3" name="crewRate3" min="0" step="0.01" value="350" style="max-width: 6rem;"> $/hr</p>
              </div>
            </details>
            <button type="button" class="crew-pricing-link" id="openCrewPricing" aria-expanded="false">[Crew Pricing]</button>
          </div>
          <div class="additional-labor-header" aria-hidden="true">
            <span class="additional-labor-hdr-desc">Description</span>
            <span class="additional-labor-hdr-hours">Hours</span>
            <span class="additional-labor-hdr-crew">Crew</span>
            <span class="additional-labor-hdr-rate">Rate</span>
            <span class="additional-labor-hdr-remove"></span>
          </div>
          <div id="additionalLaborRows">
            <div class="additional-labor-row">
              <input type="text" class="additional-labor-desc" placeholder="Description (e.g. Demo, Underground, Prep)">
              <input type="number" class="additional-labor-hours" min="0" step="0.5" placeholder="Hrs" title="Hours">
              <select class="additional-labor-crew" title="Crew size">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
              <input type="number" class="additional-labor-rate" min="0" step="0.01" placeholder="Rate" title="Labor rate $/hr">
              <button type="button" class="additional-labor-remove" aria-label="Remove row">Remove</button>
            </div>
          </div>
          <button type="button" id="addAdditionalLaborRow" class="btn btn-outline" style="margin-top: 0.5rem;">Add row</button>
        </div>
        <p><strong>Labor total (Hours • Rate): $<span id="laborTotal">0.00</span></strong></p>
      </div>

      <div class="section">
        <h2>Pricing</h2>
        <p style="margin-bottom: 0.5rem; font-weight: 500;">Additional materials</p>
        <div class="additional-material-header" aria-hidden="true">
          <span class="additional-material-hdr-desc">Description</span>
          <span class="additional-material-hdr-amount">Amount</span>
          <span class="additional-material-hdr-remove"></span>
        </div>
        <div id="additionalMaterialRows">
          <div class="additional-material-row">
            <input type="text" class="additional-material-desc" placeholder="Description (e.g. Pipe, Fittings)">
            <input type="number" class="additional-material-amount" min="0" step="0.01" placeholder="Amount" title="Amount ($)">
            <button type="button" class="additional-material-remove" aria-label="Remove row">Remove</button>
          </div>
        </div>
        <button type="button" id="addAdditionalMaterialRow" class="btn btn-outline" style="margin-top: 0.5rem;">Add row</button>
        <div class="preview-section" style="margin-top: 1rem;">
          <table class="preview-table">
            <tr><th>Item</th><th>Amount</th></tr>
            <tr>
              <td>Fixture and Set Labor</td>
              <td>$<span id="calcFixtureLaborBase">0.00</span></td>
            </tr>
            <tr>
              <td>Fixture and Set Labor Markup <input type="number" id="fixtureLaborMarkupPct" name="fixtureLaborMarkupPct" min="0" step="0.5" value="0" title="Fixture and Set Labor Markup" style="width: 4rem; margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.9rem;">%</td>
              <td>$<span id="calcFixtureLaborMarkup">0.00</span></td>
            </tr>
            <tr style="font-weight: 600; border-top: 2px solid var(--border);">
              <td>Fixture and Set Labor Subtotal</td>
              <td style="text-align: right;">$<span id="calcFixtureLaborSubtotal">0.00</span></td>
            </tr>
            <tr>
              <td>Materials</td>
              <td>$<span id="calcMaterials">0.00</span></td>
            </tr>
            <tr>
              <td>Materials Markup <input type="number" id="materialsMarkupPct" name="materialsMarkupPct" min="0" step="0.5" value="0" title="Materials Markup" style="width: 4rem; margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.9rem;">%</td>
              <td>$<span id="calcMaterialsMarkup">0.00</span></td>
            </tr>
            <tr style="font-weight: 600; border-top: 2px solid var(--border);">
              <td>Materials Subtotal</td>
              <td style="text-align: right;">$<span id="calcMaterialsSubtotal">0.00</span></td>
            </tr>
            <tr>
              <td>Additional Labor</td>
              <td>$<span id="calcLabor">0.00</span></td>
            </tr>
            <tr>
              <td>Additional Labor Markup <input type="number" id="laborMarkupPct" name="laborMarkupPct" min="0" step="0.5" value="0" title="Labor Markup" style="width: 4rem; margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.9rem;">%</td>
              <td>$<span id="calcLaborMarkup">0.00</span></td>
            </tr>
            <tr style="font-weight: 600; border-top: 2px solid var(--border);">
              <td>Additional Labor Subtotal</td>
              <td style="text-align: right;">$<span id="calcLaborSubtotal">0.00</span></td>
            </tr>
          </table>
          <p class="grand-total">Grand Total: $<span id="grandTotal">0.00</span></p>
        </div>
      </div>

      <div class="no-print" style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; margin: 0 0 1rem 0;">
        <button type="button" id="roughCalculatorBtn" class="btn btn-outline" aria-expanded="false">Rough Calculator</button>
        <button type="button" id="clearBtn" class="btn btn-outline" style="margin-left: auto;">Reset Fields</button>
      </div>

      <div id="roughCalculatorSection" class="section section-rough-calculator hidden" aria-hidden="true">
        <h2>Rough Calculator</h2>
        <div id="roughCalculatorContent">
          <div class="form-row rough-calc-dimensions-row">
            <div class="field">
              <label for="roughLength">Length (ft)</label>
              <input type="number" id="roughLength" name="roughLength" min="0" step="0.1" placeholder="0">
            </div>
            <span class="rough-calc-op" aria-hidden="true">*</span>
            <div class="field">
              <label for="roughWidth">Width (ft)</label>
              <input type="number" id="roughWidth" name="roughWidth" min="0" step="0.1" placeholder="0">
            </div>
            <span class="rough-calc-op" aria-hidden="true">=</span>
            <div class="field">
              <label for="roughSfFromDimensions">Square footage (L × W)</label>
              <input type="number" id="roughSfFromDimensions" name="roughSfFromDimensions" min="0" step="0.1" placeholder="Or enter SF">
            </div>
          </div>
          <div class="form-row">
            <div class="field">
              <label for="roughCostPerSqFt">Cost per SF before fixtures ($)</label>
              <input type="number" id="roughCostPerSqFt" name="roughCostPerSqFt" min="0" step="0.01" placeholder="0" class="rough-calc-cost-input">
            </div>
          </div>
          <div class="form-row">
            <div class="field">
              <label>Fixture count (from above) = <span id="roughFixtureCount">0</span></label>
              <input type="number" id="roughFixtureCountOverride" name="roughFixtureCountOverride" min="0" step="1" placeholder="Or enter custom amount">
            </div>
            <div class="field">
              <label for="roughPricePerFixture">Price per fixture ($)</label>
              <input type="number" id="roughPricePerFixture" name="roughPricePerFixture" min="0" step="0.01" placeholder="0">
            </div>
          </div>
          <p style="margin-top: 1rem; margin-bottom: 0; font-weight: 600;">Rough Bid: $<span id="roughBidResult">0.00</span></p>
          <div class="rough-calc-footer" style="display: flex; justify-content: flex-end; margin-top: 1rem;">
            <button type="button" id="clearRoughCalculatorBtn" class="btn btn-outline">[clear calculator]</button>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Inclusions (each line is an item)</h2>
        <textarea id="inclusions" name="inclusions" rows="5" placeholder="Describe what is included (e.g. fixtures per plan, permits)...">Permits</textarea>
      </div>

      <div class="section">
        <h2>Exclusions and Scope</h2>
        <textarea id="scopeNotes" name="scopeNotes" rows="5" placeholder="Describe scope, exclusions, and any special notes..."></textarea>
      </div>

      <div class="section">
        <h2>Terms and Warranty</h2>
        <textarea id="termsAndWarranty" name="termsAndWarranty" rows="8" placeholder="Terms and warranty..."></textarea>
      </div>

      <div class="actions no-print">
        <div class="internal-summary-box">
          <h3 class="internal-summary-title">Internal Summary</h3>
          <div class="internal-summary-actions">
            <button type="button" id="generatePreview" class="btn btn-primary">View</button>
            <button type="button" id="printBtn" class="btn btn-secondary">Print</button>
          </div>
        </div>
        <div class="internal-summary-box">
          <h3 class="internal-summary-title">External Summary</h3>
          <div class="internal-summary-actions">
            <button type="button" id="exportPdf" class="btn btn-primary">View</button>
            <button type="button" id="externalSummaryCopyBtn" class="btn btn-outline">Copy Text</button>
            <button type="button" id="externalSummaryDownloadPdf" class="btn btn-primary">Download PDF</button>
            <button type="button" id="externalSummaryPrint" class="btn btn-secondary">Print</button>
          </div>
        </div>
        <div class="internal-summary-box">
          <h3 class="internal-summary-title">Google Doc</h3>
          <div class="letterhead-icons">
            <a id="letterheadCopyLink" class="letterhead-link google-doc-steps" href="#" target="_blank" rel="noopener noreferrer" title="Copy letterhead as new document (named with bid number)">
              <img src="make-a-copy.png" alt="Make a copy" class="google-doc-make-a-copy">
              <span class="google-doc-arrow">→</span>
              <span>Click once</span>
              <span class="google-doc-arrow">→</span>
              <span class="google-doc-shortcut">⌘+V</span>
            </a>
          </div>
        </div>
        <div class="internal-summary-box">
          <h3 class="internal-summary-title">Share via URL</h3>
          <div class="internal-summary-actions">
            <div class="share-url-actions">
              <span id="shareViaUrlBtn" class="share-via-url-trigger" role="button" tabindex="0" title="Share via URL" aria-label="Share via URL">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="share-via-url-icon" aria-hidden="true"><path d="M480 400L288 400C279.2 400 272 392.8 272 384L272 128C272 119.2 279.2 112 288 112L421.5 112C425.7 112 429.8 113.7 432.8 116.7L491.3 175.2C494.3 178.2 496 182.3 496 186.5L496 384C496 392.8 488.8 400 480 400zM288 448L480 448C515.3 448 544 419.3 544 384L544 186.5C544 169.5 537.3 153.2 525.3 141.2L466.7 82.7C454.7 70.7 438.5 64 421.5 64L288 64C252.7 64 224 92.7 224 128L224 384C224 419.3 252.7 448 288 448zM160 192C124.7 192 96 220.7 96 256L96 512C96 547.3 124.7 576 160 576L352 576C387.3 576 416 547.3 416 512L416 496L368 496L368 512C368 520.8 360.8 528 352 528L160 528C151.2 528 144 520.8 144 512L144 256C144 247.2 151.2 240 160 240L176 240L176 192L160 192z"/></svg>
              </span>
              <span id="shareViaEmailBtn" class="share-via-url-trigger" role="button" tabindex="0" title="Email link" aria-label="Email link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="share-via-email-icon" aria-hidden="true"><path d="M125.4 128C91.5 128 64 155.5 64 189.4C64 190.3 64 191.1 64.1 192L64 192L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 192L575.9 192C575.9 191.1 576 190.3 576 189.4C576 155.5 548.5 128 514.6 128L125.4 128zM528 256.3L528 448C528 456.8 520.8 464 512 464L128 464C119.2 464 112 456.8 112 448L112 256.3L266.8 373.7C298.2 397.6 341.7 397.6 373.2 373.7L528 256.3zM112 189.4C112 182 118 176 125.4 176L514.6 176C522 176 528 182 528 189.4C528 193.6 526 197.6 522.7 200.1L344.2 335.5C329.9 346.3 310.1 346.3 295.8 335.5L117.3 200.1C114 197.6 112 193.6 112 189.4z"/></svg>
              </span>
            </div>
          </div>
        </div>
      </div>
    </form>

    <div id="preview" class="preview-section" aria-live="polite"></div>

    <div id="externalSummaryPreview" class="external-summary-inline" aria-live="polite"></div>

    <div id="shareUrlLongModal" class="share-url-modal" aria-hidden="true">
      <div class="share-url-modal-backdrop" aria-label="Close"></div>
      <div class="share-url-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="shareUrlLongModalTitle">
        <h2 id="shareUrlLongModalTitle" class="share-url-modal-title">Copied to clipboard.</h2>
        <p id="shareUrlLongModalMessage" class="share-url-modal-message"></p>
        <button type="button" id="shareUrlLongModalClose" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    (function() {
      const CREW_MULTIPLIERS = { 1: 1, 2: 1.8, 3: 2.5 };
      const requiredIds = ['customerName', 'jobAddress', 'bidDate', 'bidNumber'];
      var REQUIRED_FIELDS_MESSAGE = 'Please fill in required fields: Customer Name, Job Address, Bid Date, Bid Number.';
      var MAX_SHARE_URL_LENGTH = 2000;
      var userEditedBidNumber = false;

      function $(id) { return document.getElementById(id); }
      function qs(sel, root) { return (root || document).querySelector(sel); }
      function qsa(sel, root) { return (root || document).querySelectorAll(sel); }

      function setDefaultDate() {
        const bidDate = $('bidDate');
        if (bidDate && !bidDate.value) bidDate.value = new Date().toISOString().slice(0, 10);
      }
      setDefaultDate();
      updateBidNumberFromDateAndJob();

      var fixtureIds = [
        'fixtureToilets', 'fixtureBathSinks', 'fixtureShowerTub', 'fixtureShowerOnly', 'fixtureTubs',
        'fixtureUrinals', 'fixtureWaterClosets', 'fixtureKitchenSinks', 'fixtureDisposals',
        'fixtureIceMakers', 'fixturePotFiller',
        'fixtureLaundrySinks', 'fixtureWashingMachine',
        'fixtureHoseBibs', 'fixtureWaterFountain', 'fixtureGasDrops', 'fixtureFloorDrains', 'fixtureDogWash',
        'fixtureWHGas', 'fixtureWHElectric', 'fixtureWHTankless', 'fixtureWaterSoftener'
      ];

      function getNum(id) { const el = $(id); return el ? (parseFloat(el.value) || 0) : 0; }
      function getStr(id) { const el = $(id); return el ? (el.value || '').trim() : ''; }

      function getSuggestedBidNumber() {
        var dateEl = $('bidDate');
        var dateStr = dateEl && dateEl.value ? dateEl.value.trim() : '';
        if (!dateStr) dateStr = new Date().toISOString().slice(0, 10);
        var yymmdd = dateStr.length >= 10 ? (dateStr.slice(2, 4) + dateStr.slice(5, 7) + dateStr.slice(8, 10)) : '';
        var jobRaw = getStr('jobName');
        var jobPart = jobRaw.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '').replace(/-+/g, '-').replace(/^-|-$/g, '');
        return jobPart ? yymmdd + '-' + jobPart : yymmdd;
      }

      function updateBidNumberFromDateAndJob() {
        var el = $('bidNumber');
        if (!el) return;
        var val = (el.value || '').trim();
        if (val === '') userEditedBidNumber = false;
        if (userEditedBidNumber && val !== '') return;
        el.value = getSuggestedBidNumber();
      }

      function getParagraphs(str) {
        if (!str || !str.trim()) return [];
        var lines = str.trim().split(/\r?\n/).map(function(s) { return s.trim(); });
        var paragraphs = [];
        var current = [];
        for (var i = 0; i < lines.length; i++) {
          if (lines[i] === '') {
            if (current.length) {
              paragraphs.push(current);
              current = [];
            }
          } else {
            current.push(lines[i]);
          }
        }
        if (current.length) paragraphs.push(current);
        return paragraphs;
      }

      function paragraphsToText(paragraphs) {
        return paragraphs.map(function(p) { return p.join('\n'); }).join('\n\n');
      }

      function formatNum(n, decimals) {
        return (parseFloat(n) || 0).toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
      }

      function numberToWords(n) {
        n = Math.floor(Number(n)) || 0;
        if (n < 0) n = 0;
        if (n > 999999) n = 999999;
        var ones = ['Zero','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
        var tens = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
        function under100(x) {
          if (x < 20) return ones[x];
          var t = Math.floor(x / 10), o = x % 10;
          return tens[t] + (o ? ' ' + ones[o] : '');
        }
        function under1000(x) {
          if (x < 100) return under100(x);
          var h = Math.floor(x / 100), r = x % 100;
          return ones[h] + ' Hundred' + (r ? ' ' + under100(r) : '');
        }
        if (n < 1000) return under1000(n);
        var th = Math.floor(n / 1000), r = n % 1000;
        return under1000(th) + ' Thousand' + (r ? ' ' + under1000(r) : '');
      }

      function formatProposalAmount(total) {
        var t = Number(total) || 0;
        var dollars = Math.floor(t);
        var cents = Math.round((t - dollars) * 100);
        if (cents >= 100) cents = 99;
        if (cents < 0) cents = 0;
        var centsStr = (cents < 10 ? '0' : '') + cents;
        return numberToWords(dollars) + ' ' + centsStr + '/100 Dollars ($' + formatNum(t, 2) + ')';
      }

      function formatFixtureCostShort(n) {
        var s = (parseFloat(n) || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        return s.replace(/\.?0+$/, '');
      }

      function totalFixtures() {
        var ledger = getFixtureLedger();
        if (ledger.length > 0) {
          var fixtureLabels = fixtureIds.map(function(id) {
            return id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
          });
          var sum = 0;
          fixtureLabels.forEach(function(label) {
            for (var j = 0; j < ledger.length; j++) {
              var f = ledger[j].fixtures || {};
              var val = f[label];
              sum += (val != null && val !== '') ? (parseInt(val, 10) || 0) : 0;
            }
          });
          return sum;
        }
        return fixtureIds.reduce(function(sum, id) { return sum + (getNum(id) || 0); }, 0);
      }

      var fixtureLabelToId = (function() {
        var m = {};
        fixtureIds.forEach(function(id) {
          var label = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
          m[label] = id;
        });
        return m;
      })();

      var DEFAULT_FIXTURE_MODE = 'Malachi';
      var currentFixtureMode = DEFAULT_FIXTURE_MODE;

      var FIXTURE_MODES = {
        Malachi: {
          fixtureToilets:      { label: 'Toilet',                       price: 650,   roughIn: 1,   topOut: 1,   trim: 1 },
          fixtureBathSinks:    { label: 'Bathroom sinks',               price: 275,   roughIn: 1,   topOut: 1,   trim: 1,   note: 'no sink included' },
          fixtureKitchenSinks: { label: 'Kitchen sink',                 price: 425,   roughIn: 1,   topOut: 1,   trim: 2,   note: 'no sink or faucet included' },
          fixtureDisposals:    { label: 'Garbage Disposal',             price: 350,   roughIn: 0,   topOut: 0,   trim: 1 },
          fixtureUrinals:      { label: 'Urinal and valve',             price: 950,   roughIn: 1,   topOut: 3,   trim: 3 },
          fixtureTubs:         { label: 'Bath tub and valve',           price: 2000,  roughIn: 1,   topOut: 2,   trim: 1 },
          fixtureShowerOnly:   { label: 'Showers no tub',               price: 2450,  roughIn: 1,   topOut: 2.5, trim: 1 },
          fixtureShowerTub:    { label: 'Shower tub combo',             price: 3650,  roughIn: 1,   topOut: 3,   trim: 1,   note: 'no wall kit included' },
          fixtureLaundrySinks: { label: 'Laundry sink',                 price: 425,   roughIn: 1,   topOut: 1,   trim: 1,   note: 'no sink or faucet included' },
          fixtureHoseBibs:     { label: 'Hose bib',                     price: 500,   roughIn: 1,   topOut: 1,   trim: 0.5 },
          fixtureWaterFountain: { label: 'Water fountain',              price: 1300,  roughIn: 2,   topOut: 3,   trim: 2 },
          fixtureWHGas:        { label: 'Water heater',                 price: 1200,  roughIn: 1,   topOut: 2,   trim: 2 },
          fixtureWHElectric:   { label: 'Water heater (electric)',      price: 1200,  roughIn: 1,   topOut: 2,   trim: 2 },
          fixtureWHTankless:   { label: 'Tankless Water Heater',        price: 3650,  roughIn: 1,   topOut: 3,   trim: 2 },
          fixtureGasDrops:     { label: 'Gas drops',                    price: 1000,  roughIn: 3,   topOut: 1,   trim: 0 }
        },
        Trace: {
          fixtureToilets:      { label: 'Toilet',                       price: 3800,  roughIn: 1,   topOut: 1,   trim: 1 },
          fixtureBathSinks:    { label: 'Bathroom sinks',               price: 3800,  roughIn: 1,   topOut: 1,   trim: 1,   note: 'no sink included' },
          fixtureKitchenSinks: { label: 'Kitchen sink',                 price: 3800,  roughIn: 1,   topOut: 1,   trim: 2,   note: 'no sink or faucet included' },
          fixtureDisposals:    { label: 'Garbage Disposal',             price: 1800,  roughIn: 1.5, topOut: 0,   trim: 1 },
          fixtureUrinals:      { label: 'Urinal and valve',             price: 950,   roughIn: 1,   topOut: 3,   trim: 3 },
          fixtureTubs:         { label: 'Bath tub and valve',           price: 2000,  roughIn: 1,   topOut: 2,   trim: 1 },
          fixtureShowerOnly:   { label: 'Showers no tub',               price: 3800,  roughIn: 1,   topOut: 2.5, trim: 1 },
          fixtureShowerTub:    { label: 'Shower tub combo',             price: 3650,  roughIn: 1,   topOut: 3,   trim: 1,   note: 'no wall kit included' },
          fixtureLaundrySinks: { label: 'Laundry sink',                 price: 1800,  roughIn: 1,   topOut: 1,   trim: 1,   note: 'no sink or faucet included' },
          fixtureHoseBibs:     { label: 'Hose bib',                     price: 1200,  roughIn: 1,   topOut: 1,   trim: 0.5 },
          fixtureWaterFountain: { label: 'Water fountain',              price: 3000,  roughIn: 2,   topOut: 3,   trim: 2 },
          fixtureWHGas:        { label: 'Water heater',                 price: 15000, roughIn: 1,   topOut: 2,   trim: 2 },
          fixtureWHElectric:   { label: 'Water heater (electric)',      price: 1200,  roughIn: 1,   topOut: 2,   trim: 2 },
          fixtureWHTankless:   { label: 'Tankless Water Heater',        price: 3650,  roughIn: 1,   topOut: 3,   trim: 2 },
          fixtureGasDrops:     { label: 'Gas drops',                    price: 1200,  roughIn: 3,   topOut: 1,   trim: 0 }
        }
      };

      var FIXTURE_PRICES = JSON.parse(JSON.stringify(FIXTURE_MODES[currentFixtureMode]));
      var DEFAULT_FIXTURE_PRICES = JSON.parse(JSON.stringify(FIXTURE_MODES[DEFAULT_FIXTURE_MODE]));

      var FIXTURE_LEDGER_KEY = 'bidtoolingFixtureLedger';
      function getFixtureLedger() {
        try {
          return JSON.parse(localStorage.getItem(FIXTURE_LEDGER_KEY) || '[]');
        } catch (e) {
          return [];
        }
      }
      function setFixtureLedger(entries) {
        localStorage.setItem(FIXTURE_LEDGER_KEY, JSON.stringify(entries));
      }
      function collectCurrentFixtures() {
        return fixtureIds.reduce(function(o, id) {
          var label = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
          o[label] = getNum(id);
          return o;
        }, {});
      }

      function getAdditionalLaborHours() {
        var sum = 0;
        qsa('.additional-labor-hours').forEach(function(el) {
          sum += parseFloat(el.value) || 0;
        });
        return sum;
      }

      function getFixtureLaborTotals() {
        var fixtureLabels = fixtureIds.map(function(id) {
          return id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
        });
        var totalRoughIn = 0, totalTopOut = 0, totalTrim = 0;
        var ledger = getFixtureLedger();
        if (ledger.length > 0) {
          fixtureLabels.forEach(function(label, idx) {
            var priceRow = FIXTURE_PRICES[fixtureIds[idx]];
            if (!priceRow) return;
            var totalQty = 0;
            for (var j = 0; j < ledger.length; j++) {
              var f = ledger[j].fixtures || {};
              var val = f[label];
              totalQty += (val != null && val !== '') ? (parseInt(val, 10) || 0) : 0;
            }
            totalRoughIn += totalQty * priceRow.roughIn;
            totalTopOut += totalQty * priceRow.topOut;
            totalTrim += totalQty * priceRow.trim;
          });
        } else {
          fixtureIds.forEach(function(id, idx) {
            var priceRow = FIXTURE_PRICES[id];
            if (!priceRow) return;
            var qty = getNum(id) || 0;
            totalRoughIn += qty * priceRow.roughIn;
            totalTopOut += qty * priceRow.topOut;
            totalTrim += qty * priceRow.trim;
          });
        }
        var total = totalRoughIn + totalTopOut + totalTrim;
        return { roughIn: totalRoughIn, topOut: totalTopOut, trim: totalTrim, total: total };
      }

      function getFixtureCostTotal() {
        var total = 0;
        var fixtureLabels = fixtureIds.map(function(id) {
          return id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
        });
        var ledger = getFixtureLedger();
        if (ledger.length > 0) {
          fixtureLabels.forEach(function(label, idx) {
            var priceRow = FIXTURE_PRICES[fixtureIds[idx]];
            if (!priceRow) return;
            var totalQty = 0;
            for (var j = 0; j < ledger.length; j++) {
              var f = ledger[j].fixtures || {};
              var val = f[label];
              totalQty += (val != null && val !== '') ? (parseInt(val, 10) || 0) : 0;
            }
            total += totalQty * (priceRow.price || 0);
          });
        } else {
          fixtureIds.forEach(function(id) {
            var priceRow = FIXTURE_PRICES[id];
            if (!priceRow) return;
            var qty = getNum(id) || 0;
            total += qty * (priceRow.price || 0);
          });
        }
        return total;
      }

      function updateRoughBid() {
        var roughLengthEl = $('roughLength');
        var roughWidthEl = $('roughWidth');
        var roughSfEl = $('roughSfFromDimensions');
        var roughLength = getNum('roughLength') || 0;
        var roughWidth = getNum('roughWidth') || 0;
        var roughSfEntered = roughSfEl ? (parseFloat(roughSfEl.value) || 0) : 0;
        var roughCostPerSqFt = getNum('roughCostPerSqFt') || 0;
        var roughPricePerFixture = getNum('roughPricePerFixture') || 0;
        var effectiveSf = roughSfEntered > 0 ? roughSfEntered : (roughLength * roughWidth);
        if (isNaN(effectiveSf)) effectiveSf = 0;
        var dimensionsDisabled = roughSfEntered > 0;
        if (roughLengthEl) {
          roughLengthEl.disabled = dimensionsDisabled;
          var lengthField = roughLengthEl.closest ? roughLengthEl.closest('.field') : null;
          if (lengthField) lengthField.classList.toggle('field-disabled', dimensionsDisabled);
        }
        if (roughWidthEl) {
          roughWidthEl.disabled = dimensionsDisabled;
          var widthField = roughWidthEl.closest ? roughWidthEl.closest('.field') : null;
          if (widthField) widthField.classList.toggle('field-disabled', dimensionsDisabled);
        }
        var fixtureCountFromAbove = totalFixtures();
        var roughFixtureOverride = getNum('roughFixtureCountOverride') || 0;
        var fixtureCount = roughFixtureOverride > 0 ? roughFixtureOverride : fixtureCountFromAbove;
        if (isNaN(fixtureCount)) fixtureCount = fixtureCountFromAbove;
        var buildingPart = effectiveSf * roughCostPerSqFt;
        if (isNaN(buildingPart)) buildingPart = 0;
        var fixturePart = fixtureCount * roughPricePerFixture;
        if (isNaN(fixturePart)) fixturePart = 0;
        var roughBid = buildingPart * fixturePart;
        if (isNaN(roughBid)) roughBid = 0;
        var fcEl = $('roughFixtureCount');
        if (fcEl) fcEl.textContent = formatNum(fixtureCountFromAbove, 0);
        var resultEl = $('roughBidResult');
        if (resultEl) resultEl.textContent = formatNum(roughBid, 2);
      }

      function calculateTotals() {
        var materials = 0;
        qsa('.additional-material-row').forEach(function(row) {
          materials += parseFloat((row.querySelector('.additional-material-amount') || {}).value) || 0;
        });
        var fixtureLabor = getFixtureLaborTotals();
        var fixtureCost = getFixtureCostTotal();
        var additionalLaborCost = 0;
        qsa('.additional-labor-row').forEach(function(row) {
          var hours = parseFloat((row.querySelector('.additional-labor-hours') || {}).value) || 0;
          var rowCrew = parseInt((row.querySelector('.additional-labor-crew') || {}).value, 10) || 1;
          var rowRate = parseFloat((row.querySelector('.additional-labor-rate') || {}).value) || 0;
          additionalLaborCost += hours * rowRate;
        });
        var labor = additionalLaborCost;
        var additionalHours = getAdditionalLaborHours();
        var totalHours = fixtureLabor.total + additionalHours;
        var materialsMarkupPct = getNum('materialsMarkupPct') || 0;
        var laborMarkupPct = getNum('laborMarkupPct') || 0;
        var fixtureLaborMarkupPct = getNum('fixtureLaborMarkupPct') || 0;
        var materialsMarkup = materials * (materialsMarkupPct / 100);
        var laborMarkup = labor * (laborMarkupPct / 100);
        var fixtureLaborMarkup = fixtureCost * (fixtureLaborMarkupPct / 100);
        var fixtureLaborSubtotal = fixtureCost + fixtureLaborMarkup;
        var materialsSubtotal = materials + materialsMarkup;
        var laborSubtotal = labor + laborMarkup;
        var total = fixtureLaborSubtotal + materialsSubtotal + laborSubtotal;

        var fixtureCount = totalFixtures();
        $('totalFixtures').textContent = formatNum(fixtureCount, 0);
        if ($('fixtureLaborCount')) $('fixtureLaborCount').textContent = formatNum(fixtureCount, 0);
        if ($('fixtureLaborCountLabel')) $('fixtureLaborCountLabel').textContent = fixtureCount === 1 ? ' Fixture' : ' Fixtures';
        if ($('fixtureLaborHours')) $('fixtureLaborHours').textContent = formatNum(fixtureLabor.total, 1);
        var costEl = $('fixtureLaborCost');
        if (costEl) {
          var costRaw = fixtureCost;
          costEl.setAttribute('data-raw-value', costRaw);
          costEl.setAttribute('data-format', 'short');
          costEl.textContent = formatFixtureCostShort(costRaw);
        }
        if ($('fixtureLaborRoughIn')) $('fixtureLaborRoughIn').textContent = formatNum(fixtureLabor.roughIn, 1);
        if ($('fixtureLaborTopOut')) $('fixtureLaborTopOut').textContent = formatNum(fixtureLabor.topOut, 1);
        if ($('fixtureLaborTrim')) $('fixtureLaborTrim').textContent = formatNum(fixtureLabor.trim, 1);
        $('laborTotal').textContent = formatNum(labor, 2);
        if ($('calcFixtureLaborBase')) $('calcFixtureLaborBase').textContent = formatNum(fixtureCost, 2);
        if ($('calcFixtureLaborMarkup')) $('calcFixtureLaborMarkup').textContent = formatNum(fixtureLaborMarkup, 2);
        if ($('calcFixtureLaborSubtotal')) $('calcFixtureLaborSubtotal').textContent = formatNum(fixtureLaborSubtotal, 2);
        $('calcMaterials').textContent = formatNum(materials, 2);
        $('calcLabor').textContent = formatNum(labor, 2);
        if ($('calcMaterialsMarkup')) $('calcMaterialsMarkup').textContent = formatNum(materialsMarkup, 2);
        if ($('calcLaborMarkup')) $('calcLaborMarkup').textContent = formatNum(laborMarkup, 2);
        if ($('calcMaterialsSubtotal')) $('calcMaterialsSubtotal').textContent = formatNum(materialsSubtotal, 2);
        if ($('calcLaborSubtotal')) $('calcLaborSubtotal').textContent = formatNum(laborSubtotal, 2);
        if ($('calcTotal')) $('calcTotal').textContent = formatNum(total, 2);
        $('grandTotal').textContent = formatNum(total, 2);
        updateRoughBid();
        return {
          materials: materials,
          labor: labor,
          materialsMarkup: materialsMarkup,
          laborMarkup: laborMarkup,
          total: total,
          totalHours: totalHours,
          fixtureLabor: fixtureLabor,
          fixtureCost: fixtureCost,
          fixtureLaborMarkup: fixtureLaborMarkup,
          fixtureLaborSubtotal: fixtureLaborSubtotal,
          materialsSubtotal: materialsSubtotal,
          laborSubtotal: laborSubtotal
        };
      }

      function updatePreview() {
        var data = collectFormData();
        var totals = calculateTotals();
        var html = buildPreviewHtml(data, totals);
        var preview = $('preview');
        preview.innerHTML = html;
        preview.classList.add('visible');
      }

      function collectFormData() {
        var takeoff = [];
        qsa('.takeoff-row').forEach(function(row) {
          var desc = (row.querySelector('.takeoff-desc') || {}).value;
          var qty = (row.querySelector('.takeoff-qty') || {}).value;
          if (desc || qty) takeoff.push({ desc: desc, qty: qty });
        });
        var additionalLabor = [];
        qsa('.additional-labor-row').forEach(function(row) {
          var desc = (row.querySelector('.additional-labor-desc') || {}).value;
          var hours = parseFloat((row.querySelector('.additional-labor-hours') || {}).value) || 0;
          var crewSize = (row.querySelector('.additional-labor-crew') || {}).value || '1';
          var laborRate = parseFloat((row.querySelector('.additional-labor-rate') || {}).value) || 0;
          var rowCost = hours * laborRate;
          additionalLabor.push({ desc: desc || '', hours: hours, crewSize: crewSize, laborRate: laborRate, rowCost: rowCost });
        });
        var additionalMaterials = [];
        var materialSubtotalSum = 0;
        qsa('.additional-material-row').forEach(function(row) {
          var desc = (row.querySelector('.additional-material-desc') || {}).value;
          var amount = parseFloat((row.querySelector('.additional-material-amount') || {}).value) || 0;
          additionalMaterials.push({ desc: desc || '', amount: amount });
          materialSubtotalSum += amount;
        });
        return {
          customerName: getStr('customerName'),
          customerAddress: getStr('customerAddress'),
          jobName: getStr('jobName'),
          jobAddress: getStr('jobAddress'),
          bidDate: getStr('bidDate'),
          bidNumber: getStr('bidNumber'),
          planName: getStr('planName'),
          planIssueDate: getStr('planIssueDate'),
          planTitle: getStr('planTitle'),
          fixtures: fixtureIds.reduce(function(o, id) {
            var label = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
            o[label] = getNum(id);
            return o;
          }, {}),
          takeoff: takeoff,
          additionalLabor: additionalLabor,
          laborHours: getAdditionalLaborHours(),
          crewSize: ($('crewSize') || {}).value || '1',
          daysOnSite: getNum('daysOnSite'),
          laborRate: (function() {
            var crew = parseInt(($('crewSize') || {}).value, 10) || 1;
            var el = $('crewRate' + crew);
            return (el && parseFloat(el.value)) || (getNum('laborRate') || (($('crewRate1') && parseFloat($('crewRate1').value)) || 275));
          })(),
          additionalMaterials: additionalMaterials,
          materialSubtotal: materialSubtotalSum,
          materialsMarkupPct: getNum('materialsMarkupPct'),
          laborMarkupPct: getNum('laborMarkupPct'),
          inclusions: getStr('inclusions'),
          scopeNotes: getStr('scopeNotes'),
          termsAndWarranty: getStr('termsAndWarranty')
        };
      }

      function buildPreviewHtml(data, totals) {
        var f = data.fixtures || {};
        var fixtureRows = Object.keys(f).map(function(k) {
          var v = f[k];
          if (v == null || v === '') return '';
          if ((parseInt(v, 10) || 0) <= 1) return '';
          return '<tr><td>' + escapeHtml(k) + '</td><td>' + v + '</td></tr>';
        }).filter(Boolean).join('');
        if (!fixtureRows) fixtureRows = '<tr><td colspan="2">—</td></tr>';

        var takeoffRows = (data.takeoff || []).map(function(t) {
          return '<tr><td>' + escapeHtml(t.desc) + '</td><td>' + escapeHtml(t.qty) + '</td></tr>';
        }).join('') || '<tr><td colspan="2">—</td></tr>';

        var additionalLaborRows = (data.additionalLabor || []).map(function(t) {
          var descLabel = (t.desc != null && String(t.desc).trim() !== '') ? escapeHtml(String(t.desc).trim()) : '—';
          var rowCost = (t.rowCost != null && !isNaN(t.rowCost)) ? formatNum(t.rowCost, 2) : '—';
          return '<tr><td>' + descLabel + '</td><td>' + (t.hours != null ? t.hours : '').toString() + '</td><td>' + (t.crewSize != null ? escapeHtml(String(t.crewSize)) : '') + '</td><td>$' + (t.laborRate != null ? formatNum(Number(t.laborRate), 2) : '0.00') + '</td><td>$' + rowCost + '</td></tr>';
        }).join('');
        var additionalLaborBlock = additionalLaborRows
          ? '<div class="preview-section"><h3>Additional Labor</h3><table class="preview-table"><thead><tr><th>Description</th><th>Hours</th><th>Crew</th><th>Team Rate / Hr</th><th>Manpower Cost</th></tr></thead><tbody>' + additionalLaborRows + '</tbody></table><p>Additional labor total: ' + formatNum(data.laborHours != null ? data.laborHours : 0, 1) + ' hours</p></div>'
          : '';

        var additionalMaterialsRows = (data.additionalMaterials || []).map(function(t) {
          var amount = (t.amount != null && !isNaN(t.amount)) ? formatNum(Number(t.amount), 2) : '0.00';
          return '<tr><td>' + escapeHtml(t.desc) + '</td><td>$' + amount + '</td></tr>';
        }).join('');
        var materialsTotal = formatNum((totals && totals.materials != null) ? totals.materials : (data.materialSubtotal != null ? Number(data.materialSubtotal) : 0), 2);
        var additionalMaterialsBlock = additionalMaterialsRows
          ? '<div class="preview-section"><h3>Additional Materials</h3><table class="preview-table"><thead><tr><th>Description</th><th>Amount ($)</th></tr></thead><tbody>' + additionalMaterialsRows + '</tbody></table><p>Materials total: $' + materialsTotal + '</p></div>'
          : '';

        return (
          '<div class="preview-header">' +
            '<div class="preview-logo" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" aria-hidden="true"><path fill="#E85D04" d="M541.4 162.6C549 155 561.7 156.9 565.5 166.9C572.3 184.6 576 203.9 576 224C576 312.4 504.4 384 416 384C398.5 384 381.6 381.2 365.8 376L178.9 562.9C150.8 591 105.2 591 77.1 562.9C49 534.8 49 489.2 77.1 461.1L264 274.2C258.8 258.4 256 241.6 256 224C256 135.6 327.6 64 416 64C436.1 64 455.4 67.7 473.1 74.5C483.1 78.3 484.9 91 477.4 98.6L388.7 187.3C385.7 190.3 384 194.4 384 198.6L384 240C384 248.8 391.2 256 400 256L441.4 256C445.6 256 449.7 254.3 452.7 251.3L541.4 162.6z"/></svg></div>' +
            '<h1>Click Plumbing and Electrical</h1>' +
            '<p class="preview-meta">Bid # ' + escapeHtml(data.bidNumber) + ' \u2022 ' + escapeHtml(data.bidDate) + '</p>' +
          '</div>' +
          '<div class="preview-section">' +
            '<h3>Customer &amp; Job</h3>' +
            '<p><strong>' + escapeHtml(data.customerName) + '</strong>' +
            (data.customerAddress ? '<br>' + escapeHtml(data.customerAddress) : '') +
            (data.jobName ? '<br>' + escapeHtml(data.jobName) : '') +
            '<br>' + escapeHtml(data.jobAddress) +
            (data.planTitle || data.planName || data.planIssueDate ? '<br>Plans: ' + [data.planTitle, data.planName, data.planIssueDate].filter(Boolean).map(escapeHtml).join(' — ') : '') + '</p>' +
          '</div>' +
          '<div class="preview-section">' +
            '<h3>Fixture Summary</h3>' +
            '<table class="preview-table"><thead><tr><th>Item</th><th>Qty</th></tr></thead><tbody>' + fixtureRows + '</tbody></table>' +
          '</div>' +
          '<div class="preview-section">' +
            '<h3>Fixture Materials</h3>' +
            '<table class="preview-table"><thead><tr><th>Item</th><th>Qty</th></tr></thead><tbody>' + takeoffRows + '</tbody></table>' +
          '</div>' +
          additionalLaborBlock +
          additionalMaterialsBlock +
          (function() {
            var fl = (totals && totals.fixtureLabor) || {};
            var flTotal = formatNum(fl.total != null ? fl.total : 0, 1);
            var flRough = formatNum(fl.roughIn != null ? fl.roughIn : 0, 1);
            var flTop = formatNum(fl.topOut != null ? fl.topOut : 0, 1);
            var flTrim = formatNum(fl.trim != null ? fl.trim : 0, 1);
            var fixtureCostVal = formatNum(totals && totals.fixtureCost != null ? totals.fixtureCost : 0, 2);
            var addlHours = formatNum(data.laborHours != null ? data.laborHours : 0, 1);
            var addlCost = formatNum(totals && totals.labor != null ? totals.labor : 0, 2);
            var addlList = (data.additionalLabor || []).map(function(t) {
              var descLabel = (t.desc != null && String(t.desc).trim() !== '') ? escapeHtml(String(t.desc).trim()) : '—';
              var rc = (t.rowCost != null && !isNaN(t.rowCost)) ? formatNum(t.rowCost, 2) : '0.00';
              var hrs = (t.hours != null && !isNaN(t.hours)) ? t.hours.toString() : '0';
              return '<li>' + descLabel + ': ' + hrs + ' hrs, $' + rc + '</li>';
            }).join('');
            var addlBlock = addlList ? '<ul style="margin: 0.5rem 0;">' + addlList + '</ul>' : '';
            return '<div class="preview-section">' +
              '<h3>Labor Summary</h3>' +
              '<h4>Fixture and Set Labor</h4>' +
              '<p>Total: ' + flTotal + ' hours (Rough in: ' + flRough + ', Top out: ' + flTop + ', Trim: ' + flTrim + '). Fixture labor cost: $' + fixtureCostVal + '</p>' +
              '<h4>Additional Labor</h4>' +
              addlBlock + '<p>' + addlHours + ' hours = $' + addlCost + '</p>' +
            '</div>';
          })() +
          '<div class="preview-section">' +
            '<h3>Pricing Breakdown</h3>' +
            '<table class="preview-table">' +
              '<tr><th>Item</th><th>Amount</th></tr>' +
              '<tr><td>Fixture and Set Labor</td><td>$' + formatNum(totals.fixtureCost || 0, 2) + '</td></tr>' +
              '<tr><td>Fixture and Set Labor Markup</td><td>$' + formatNum(totals.fixtureLaborMarkup != null ? totals.fixtureLaborMarkup : 0, 2) + '</td></tr>' +
              '<tr style="font-weight: 600; border-top: 2px solid var(--border);"><td>Fixture and Set Labor Subtotal</td><td style="text-align: right;">$' + formatNum(totals.fixtureLaborSubtotal != null ? totals.fixtureLaborSubtotal : (totals.fixtureCost || 0), 2) + '</td></tr>' +
              '<tr><td>Materials</td><td>$' + formatNum(totals.materials || 0, 2) + '</td></tr>' +
              '<tr><td>Materials Markup</td><td>$' + formatNum(totals.materialsMarkup != null ? totals.materialsMarkup : 0, 2) + '</td></tr>' +
              '<tr style="font-weight: 600; border-top: 2px solid var(--border);"><td>Materials Subtotal</td><td style="text-align: right;">$' + formatNum(totals.materialsSubtotal != null ? totals.materialsSubtotal : (totals.materials || 0) + (totals.materialsMarkup != null ? totals.materialsMarkup : 0), 2) + '</td></tr>' +
              '<tr><td>Additional Labor</td><td>$' + formatNum(totals.labor || 0, 2) + '</td></tr>' +
              '<tr><td>Additional Labor Markup</td><td>$' + formatNum(totals.laborMarkup != null ? totals.laborMarkup : 0, 2) + '</td></tr>' +
              '<tr style="font-weight: 600; border-top: 2px solid var(--border);"><td>Additional Labor Subtotal</td><td style="text-align: right;">$' + formatNum(totals.laborSubtotal != null ? totals.laborSubtotal : (totals.labor || 0) + (totals.laborMarkup != null ? totals.laborMarkup : 0), 2) + '</td></tr>' +
            '</table>' +
          '</div>' +
          '<div class="preview-section">' +
            '<p class="grand-total">Grand Total: $' + formatNum(totals.total || 0, 2) + '</p>' +
          '</div>' +
          (data.scopeNotes ? '<div class="preview-section"><h3>Exclusions and Scope</h3><p>' + escapeHtml(data.scopeNotes).replace(/\n/g, '<br>') + '</p></div>' : '')
        );
      }

      function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function buildExternalSummaryHtml(plainText) {
        if (!plainText || !plainText.trim()) return '';
        var paragraphs = plainText.split(/\n\n+/);
        return paragraphs.map(function(para, paraIndex) {
          var lines = para.replace(/\s+$/, '').split('\n').map(function(line, lineIndex) {
            line = line.replace(/^ +/, function(m) { return Array(m.length + 1).join('\u00a0'); });
            var amountPrefix = 'in the amount of: ';
            var amountIdx = line.indexOf(amountPrefix);
            if (amountIdx !== -1) {
              var prefix = line.substring(0, amountIdx + amountPrefix.length);
              var amount = line.substring(amountIdx + amountPrefix.length);
              return escapeHtml(prefix) + '<strong>' + escapeHtml(amount) + '</strong>';
            }
            var escaped = escapeHtml(line);
            var trimmed = line.trim();
            var isBold = (paraIndex === 1 && lineIndex === 0) || (paraIndex === 2 && lineIndex === 0) || trimmed === 'Inclusions:' || trimmed === 'Exclusions and Scope:' || trimmed === 'Terms and Warranty:';
            return isBold ? '<strong>' + escaped + '</strong>' : escaped;
          });
          return '<p>' + lines.join('<br>') + '</p>';
        }).join('');
      }

      function validateForm() {
        var ok = true;
        requiredIds.forEach(function(id) {
          var el = $(id);
          if (!el) return;
          if (!getStr(id)) { el.classList.add('error'); ok = false; } else { el.classList.remove('error'); }
        });
        return ok;
      }

      function onGeneratePreview() {
        var preview = $('preview');
        var genBtn = $('generatePreview');
        if (preview && preview.classList.contains('visible')) {
          preview.classList.remove('visible');
          preview.innerHTML = '';
          if (genBtn) genBtn.classList.remove('view-active');
          return;
        }
        if (!validateForm()) {
          alert(REQUIRED_FIELDS_MESSAGE);
          return;
        }
        updatePreview();
        if (genBtn) genBtn.classList.add('view-active');
      }

      function onPrint() {
        if (!validateForm()) {
          alert(REQUIRED_FIELDS_MESSAGE);
          return;
        }
        updatePreview();
        setTimeout(function() { window.print(); }, 100);
      }

      function buildExternalSummaryPreviewHtml(data, totals) {
        var fxBase = totals.fixtureCost || 0;
        var fxMarkup = totals.fixtureLaborMarkup != null ? totals.fixtureLaborMarkup : 0;
        var fxSub = totals.fixtureLaborSubtotal != null ? totals.fixtureLaborSubtotal : (fxBase + fxMarkup);
        var matSub = totals.materialsSubtotal != null ? totals.materialsSubtotal : ((totals.materials || 0) + (totals.materialsMarkup != null ? totals.materialsMarkup : 0));
        var labSub = totals.laborSubtotal != null ? totals.laborSubtotal : ((totals.labor || 0) + (totals.laborMarkup != null ? totals.laborMarkup : 0));
        var planParts = [data.planTitle, data.planName, data.planIssueDate].filter(Boolean).map(escapeHtml);
        var planLine = planParts.length ? 'Plans: ' + planParts.join(' — ') : '';
        var custAddrLines = (data.customerAddress || '').split(/\r?\n/).map(function(s) { return s.trim(); }).filter(Boolean);
        var jobAddrLines = (data.jobAddress || '').split(/\r?\n/).map(function(s) { return s.trim(); }).filter(Boolean);
        var custBlock = '<p style="margin: 0 0 0.25rem 0;"><strong>' + escapeHtml(data.customerName) + '</strong></p>' +
          custAddrLines.map(function(line) { return '<p style="margin: 0 0 0.25rem 0;">' + escapeHtml(line) + '</p>'; }).join('');
        var jobBlock = (data.jobName ? '<p style="margin: 0 0 0.25rem 0;"><strong>' + escapeHtml(data.jobName) + '</strong></p>' : '') +
          jobAddrLines.map(function(line) { return '<p style="margin: 0 0 0.25rem 0;">' + escapeHtml(line) + '</p>'; }).join('');
        var f = data.fixtures || {};
        var inclusionHeader = '<li>Fixtures provided and installed by us per plan:</li>';
        var inclusionSubItems = fixtureIds.map(function(id) {
          var derivedLabel = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
          var label = (FIXTURE_PRICES[id] && FIXTURE_PRICES[id].label) || derivedLabel;
          var qty = (parseInt(f[derivedLabel], 10) || 0);
          return qty > 0 ? '<li>[' + qty + '] ' + escapeHtml(label) + '</li>' : '';
        }).filter(Boolean).join('');
        var inclusionBlock = '<ul style="margin: 0 0 0; padding-left: 1.25rem;">' + inclusionHeader + '</ul>' +
          '<div style="padding-left: 1.5rem; margin-top: 0.25rem;">' +
          '<ul style="margin: 0 0 0.5rem 0; padding-left: 1.25rem;">' + inclusionSubItems + '</ul>' +
          '</div>' +
          (function() {
            var incLines = (data.inclusions || '').trim().split(/\r?\n/).map(function(s) { return s.trim(); }).filter(Boolean);
            return incLines.length === 0 ? '' : '<ul style="margin: 0.5rem 0 0 0; padding-left: 1.25rem;">' + incLines.map(function(l) { return '<li>' + escapeHtml(l) + '</li>'; }).join('') + '</ul>';
          })();
        return '<div class="preview-section">' +
          '<div style="margin-bottom: 1rem;">' + custBlock + '</div>' +
          '<div style="margin-bottom: 1rem;">' + jobBlock + '</div>' +
          '<p style="font-size: 1.1rem; font-weight: 600; margin: 0 0 0.5rem 0;">Click Plumbing and Electrical</p>' +
          '<p class="preview-meta" style="margin: 0 0 0.75rem 0;">Bid # ' + escapeHtml(data.bidNumber) + ' \u2022 ' + escapeHtml(data.bidDate) + '</p>' +
          '<p style="margin: 0.75rem 0;">As per plumbing plans and specifications, we propose to do the plumbing in the amount of: <strong>' + formatProposalAmount(totals.total || 0) + '</strong></p>' +
          '<p style="margin: 0.5rem 0 0.25rem 0; font-weight: 600;">Inclusions:</p>' +
          inclusionBlock +
          (data.scopeNotes && data.scopeNotes.trim() ? (function() {
            var scopeLines = data.scopeNotes.trim().split(/\r?\n/).map(function(s) { return s.trim(); }).filter(Boolean);
            var scopeList = scopeLines.length ? '<ul style="margin: 0.5rem 0 0 0; padding-left: 1.25rem;">' + scopeLines.map(function(l) { return '<li>' + escapeHtml(l) + '</li>'; }).join('') + '</ul>' : '';
            return '<p style="margin: 0.5rem 0 0.25rem 0; font-weight: 600;">Exclusions and Scope:</p>' + scopeList;
          })() : '') +
          '<p style="margin: 0.5rem 0 0.25rem 0; font-weight: 600;">Terms and Warranty:</p><p style="margin: 0 0 0;">' + (data.termsAndWarranty && data.termsAndWarranty.trim() ? escapeHtml(data.termsAndWarranty.trim()).replace(/\n/g, '<br>') : '—') + '</p>' +
          (planLine ? '<p style="margin: 0.75rem 0 0 0;">' + planLine + '</p>' : '') +
          '</div>' +
          '<div class="preview-section">' +
          '<p style="margin: 0.75rem 0 0.25rem 0;">No work shall commence until Click Plumbing has received acceptance of the estimate.</p>' +
          '<p style="margin: 0.5rem 0 0.25rem 0;">Respectfully submitted by Click Plumbing</p>' +
          '<p style="margin: 0.75rem 0 0.25rem 0;">&nbsp;</p>' +
          '<p style="margin: 0.5rem 0 0.25rem 0; padding-left: 1.5rem;">_______________________________</p>' +
          '<p style="margin: 0.75rem 0 0.25rem 0;">The above prices, specifications, and conditions are satisfactory and are hereby accepted. You are authorized to perform the work as specified.</p>' +
          '<p style="margin: 0.5rem 0 0.25rem 0; font-weight: 600;">Acceptance of estimate</p>' +
          '<p style="margin: 0.5rem 0 0.25rem 0;">General Contractor / Builder Signature:</p>' +
          '<p style="margin: 0.25rem 0 0.25rem 0;">____________________________________</p>' +
          '<p style="margin: 0.5rem 0 0.25rem 0;">&nbsp;</p>' +
          '<p style="margin: 0.5rem 0 0.25rem 0; text-align: right;">Date: ____________________________________</p>' +
          '</div>';
      }

      function buildExternalSummaryPlainText(data, totals) {
        var planParts = [data.planTitle, data.planName, data.planIssueDate].filter(Boolean);
        var planLine = planParts.length ? 'Plans: ' + planParts.join(' \u2022 ') : '';
        var pad40 = Array(41).join(' ');
        var headerLines = [
          pad40 + 'Bid # ' + (data.bidNumber || '') + ' \u2022 ' + (data.bidDate || '')
        ];
        if (planLine) headerLines.push(pad40 + planLine);
        var headerBlock = headerLines.join('\n');
        var custAddrLines = (data.customerAddress || '').trim().split(/\r?\n/).map(function(s) { return s.trim(); }).filter(Boolean);
        var custAddrText = custAddrLines.join('\n');
        var customerBlock = [(data.customerName || '').trim()].concat(custAddrLines).filter(Boolean).join('\n');
        var jobAddrText = paragraphsToText(getParagraphs(data.jobAddress || ''));
        var f = data.fixtures || {};
        var inclusionLines = ['• Fixtures provided and installed by us per plan:'];
        fixtureIds.forEach(function(id) {
          var derivedLabel = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
          var label = (FIXTURE_PRICES[id] && FIXTURE_PRICES[id].label) || derivedLabel;
          var qty = (parseInt(f[derivedLabel], 10) || 0);
          if (qty > 0) inclusionLines.push('     • [' + qty + '] ' + label);
        });
        var inclusionParagraphs = getParagraphs(data.inclusions || '');
        var userInclusionText = inclusionParagraphs.map(function(p) {
          return p.map(function(l) { return '• ' + l; }).join('\n');
        }).join('\n\n');
        var inclusionSection = inclusionLines.join('\n') + (userInclusionText ? '\n\n' + userInclusionText : '');
        var parts = [
          headerBlock,
          '',
          customerBlock,
          '',
          (data.jobName || '') + (jobAddrText ? (data.jobName ? '\n' : '') + jobAddrText : ''),
          '',
          'As per plumbing plans and specifications, we propose to do the plumbing in the amount of: ' + formatProposalAmount(totals.total || 0),
          '',
          'Inclusions:',
          inclusionSection,
          ''
        ];
        if (data.scopeNotes && data.scopeNotes.trim()) {
          var scopeParagraphs = getParagraphs(data.scopeNotes);
          var scopeText = scopeParagraphs.map(function(p) {
            return p.map(function(l) { return '• ' + l; }).join('\n');
          }).join('\n\n');
          parts.push('Exclusions and Scope:');
          parts.push(scopeText);
          parts.push('');
        }
        parts.push('Terms and Warranty:');
        parts.push(data.termsAndWarranty && data.termsAndWarranty.trim() ? paragraphsToText(getParagraphs(data.termsAndWarranty)) : '—');
        parts.push('');
        parts.push('No work shall commence until Click Plumbing has received acceptance of the estimate.');
        parts.push('');
        parts.push('Respectfully submitted by Click Plumbing');
        parts.push('');
        parts.push('');
        parts.push('_______________________________');
        parts.push('');
        parts.push('The above prices, specifications, and conditions are satisfactory and are hereby accepted. You are authorized to perform the work as specified.');
        parts.push('');
        parts.push('');
        parts.push('Acceptance of estimate');
        parts.push('');
        parts.push('General Contractor / Builder Signature:');
        parts.push('');
        parts.push('____________________________________');
        parts.push('');
        parts.push('');
        parts.push('Date: ____________________________________');
        return parts.join('\n');
      }

      function showExternalSummaryBelow() {
        if (!validateForm()) {
          alert(REQUIRED_FIELDS_MESSAGE);
          return false;
        }
        var data = collectFormData();
        var totals = calculateTotals();
        var el = $('externalSummaryPreview');
        if (el) {
          el.innerHTML = buildExternalSummaryPreviewHtml(data, totals);
          el.classList.add('visible');
        }
        return true;
      }

      function openExternalSummaryView() {
        var extEl = $('externalSummaryPreview');
        var exportBtn = $('exportPdf');
        if (extEl && extEl.classList.contains('visible')) {
          extEl.classList.remove('visible');
          extEl.innerHTML = '';
          if (exportBtn) exportBtn.classList.remove('view-active');
          return;
        }
        if (showExternalSummaryBelow()) {
          if (extEl) extEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          if (exportBtn) exportBtn.classList.add('view-active');
        }
      }

      function exportToPDF() {
        if (!validateForm()) {
          alert(REQUIRED_FIELDS_MESSAGE);
          return;
        }
        updatePreview();
        try {
          var data = collectFormData();
          var totals = calculateTotals();
          var JsPDF = window.jspdf.jsPDF;
          var doc = new JsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
          var margin = 40;
          var maxWidth = 520;
          var y = 40;
          var lineHeight = 14;
          doc.setFontSize(10);
          var pad120 = Array(121).join(' ');
          doc.text(pad120 + 'Click Plumbing and Electrical', margin, y);
          y += lineHeight;
          doc.text(pad120 + 'Bid # ' + data.bidNumber + ' \u2022 ' + data.bidDate, margin, y);
          y += lineHeight;
          if (data.planTitle) { doc.text(pad120 + 'Plan Title: ' + data.planTitle, margin, y); y += lineHeight; }
          if (data.planName) { doc.text(pad120 + 'Plan Name: ' + data.planName, margin, y); y += lineHeight; }
          if (data.planIssueDate) { doc.text(pad120 + 'Plan Issue Date: ' + data.planIssueDate, margin, y); y += lineHeight; }

          doc.setFont(undefined, 'bold');
          doc.text(data.customerName, margin, y);
          y += lineHeight;
          doc.setFont(undefined, 'normal');
          (data.customerAddress || '').split(/\r?\n/).forEach(function(line) {
            var t = line.trim();
            if (t) {
              if (y > 700) { doc.addPage(); y = 40; }
              doc.text(t, margin, y);
              y += lineHeight;
            }
          });
          y += lineHeight;
          if (data.jobName) {
            doc.setFont(undefined, 'bold');
            doc.text(data.jobName, margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
          }
          (data.jobAddress || '').split(/\r?\n/).forEach(function(line) {
            var t = line.trim();
            if (t) {
              if (y > 700) { doc.addPage(); y = 40; }
              doc.text(t, margin, y);
              y += lineHeight;
            }
          });
          y += lineHeight;
          doc.text('As per plumbing plans and specifications, we propose to do the plumbing in the amount of:', margin, y);
          y += lineHeight;
          var amountStr = formatProposalAmount(totals.total || 0);
          doc.setFont(undefined, 'bold');
          var amountLines = doc.splitTextToSize(amountStr, maxWidth);
          amountLines.forEach(function(line) {
            if (y > 700) { doc.addPage(); y = 40; }
            doc.text(line, margin, y);
            y += lineHeight;
          });
          doc.setFont(undefined, 'normal');
          y += lineHeight;
          doc.setFont(undefined, 'bold');
          doc.text('Inclusions:', margin, y);
          y += lineHeight;
          doc.setFont(undefined, 'normal');
          doc.text('• Fixtures provided and installed by us per plan:', margin, y);
          y += lineHeight;
          var indentMargin = margin + 25;
          var f = data.fixtures || {};
          fixtureIds.forEach(function(id) {
            var label = id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
            var qty = (parseInt(f[label], 10) || 0);
            if (qty > 0) {
              if (y > 700) { doc.addPage(); y = 40; }
              doc.text('\u2022 [' + qty + '] ' + label, indentMargin, y);
              y += lineHeight;
            }
          });
          y += lineHeight;
          if (data.inclusions && data.inclusions.trim()) {
            var inclusionsLines = data.inclusions.trim().split(/\r?\n/).map(function(s) { return s.trim(); }).filter(Boolean);
            inclusionsLines.forEach(function(line) {
              var bulletLine = '\u2022 ' + line;
              var wrapped = doc.splitTextToSize(bulletLine, maxWidth);
              wrapped.forEach(function(w) {
                if (y > 700) { doc.addPage(); y = 40; }
                doc.text(w, margin, y);
                y += lineHeight;
              });
            });
          }
          if (data.scopeNotes && data.scopeNotes.trim()) {
            y += lineHeight;
            doc.setFont(undefined, 'bold');
            doc.text('Exclusions and Scope:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            var scopeUserLines = data.scopeNotes.trim().split(/\r?\n/).map(function(s) { return s.trim(); }).filter(Boolean);
            scopeUserLines.forEach(function(line) {
              var bulletLine = '• ' + line;
              var wrapped = doc.splitTextToSize(bulletLine, maxWidth);
              wrapped.forEach(function(w) {
                if (y > 700) { doc.addPage(); y = 40; }
                doc.text(w, margin, y);
                y += lineHeight;
              });
            });
          }
          y += lineHeight;
          doc.setFont(undefined, 'bold');
          doc.text('Terms and Warranty:', margin, y);
          y += lineHeight;
          doc.setFont(undefined, 'normal');
          var termsText = data.termsAndWarranty && data.termsAndWarranty.trim() ? data.termsAndWarranty.trim() : '—';
          var termsLines = doc.splitTextToSize(termsText, maxWidth);
          termsLines.forEach(function(line) {
            if (y > 700) { doc.addPage(); y = 40; }
            doc.text(line, margin, y);
            y += lineHeight;
          });
          y += lineHeight;

          if (y > 700) { doc.addPage(); y = 40; }
          doc.text('No work shall commence until Click Plumbing has received acceptance of the estimate.', margin, y);
          y += lineHeight;
          if (y > 700) { doc.addPage(); y = 40; }
          doc.text('Respectfully submitted by Click Plumbing', margin, y);
          y += lineHeight;
          y += lineHeight;
          if (y > 700) { doc.addPage(); y = 40; }
          doc.text('        _______________________________', margin, y);
          y += lineHeight;
          y += lineHeight;
          var acceptPara = 'The above prices, specifications, and conditions are satisfactory and are hereby accepted. You are authorized to perform the work as specified.';
          var acceptLines = doc.splitTextToSize(acceptPara, maxWidth);
          acceptLines.forEach(function(line) {
            if (y > 700) { doc.addPage(); y = 40; }
            doc.text(line, margin, y);
            y += lineHeight;
          });
          y += lineHeight;
          var footerLines = [
            'Click Plumbing and Electrical, 5501 Balcones Dr, Austin, TX 78731',
            'Malachi Whites RMP M-41130 | Phone: 512 360 0599',
            'Regulated by the Texas State Board of Plumbing Examiners',
            '929 E 41st St, Austin, TX 78751 | (512) 936-5200 | https://tsbpe.texas.gov'
          ];
          footerLines.forEach(function(line) {
            if (y > 700) { doc.addPage(); y = 40; }
            doc.text(line, margin, y);
            y += lineHeight;
          });
          y += lineHeight;
          if (y > 700) { doc.addPage(); y = 40; }
          doc.setFont(undefined, 'bold');
          doc.text('Acceptance of estimate', margin, y);
          y += lineHeight;
          doc.setFont(undefined, 'normal');
          doc.text('General Contractor / Builder Signature:', margin, y);
          y += lineHeight;
          y += lineHeight;
          if (y > 700) { doc.addPage(); y = 40; }
          doc.text('____________________________________', margin, y);
          y += lineHeight;
          y += lineHeight;
          if (y > 700) { doc.addPage(); y = 40; }
          doc.text('Date: ____________________________________', margin, y);

          doc.save('bid-summary-' + (getStr('bidNumber') || 'export') + '.pdf');
        } catch (e) {
          console.error(e);
          alert('PDF export failed. Try printing to PDF from the Print dialog instead.');
        }
      }

      function exportCoverPage() {
        var ledger = getFixtureLedger();
        if (ledger.length === 0) {
          alert('No plan pages in the ledger. Save at least one plan page first.');
          return;
        }
        try {
          var fixtureLabels = fixtureIds.map(function(id) {
            return id.replace('fixture', '').replace(/([A-Z])/g, ' $1').trim();
          });
          var numCols = ledger.length;
          var useLandscape = numCols > 5;
          var JsPDF = window.jspdf.jsPDF;
          var doc = new JsPDF({
            orientation: useLandscape ? 'landscape' : 'portrait',
            unit: 'pt',
            format: 'letter'
          });
          var margin = 32;
          var pageW = doc.internal.pageSize.getWidth();
          var usableWidth = pageW - margin * 2;
          var itemColWidth = 142;
          var laborColWidth = 52;
          var totalColWidth = 36;
          var dataWidth = usableWidth - itemColWidth - laborColWidth - totalColWidth;
          var colWidth = Math.max(26, dataWidth / numCols);
          var cellPad = 1;
          var lineHeight = 14;
          var y = 40;
          var fontSize = numCols > 8 ? 9 : 10;
          doc.setFontSize(fontSize);

          doc.setFontSize(16);
          doc.text('Fixture count by plan page', margin, y);
          y += 24;
          doc.setFontSize(fontSize);

          function drawHeader() {
            doc.setFont(undefined, 'bold');
            doc.text('Total', margin + cellPad, y);
            doc.text('Labor', margin + totalColWidth + cellPad, y);
            doc.text('Item', margin + totalColWidth + laborColWidth + cellPad, y);
            var x = margin + totalColWidth + laborColWidth + itemColWidth;
            for (var i = 0; i < ledger.length; i++) {
              var name = (ledger[i].pageName || 'Unnamed');
              if (name.length > 14) name = name.slice(0, 11) + '...';
              doc.text(name, x + cellPad, y);
              x += colWidth;
            }
            y += lineHeight;
            doc.setFont(undefined, 'normal');
          }

          drawHeader();

          fixtureLabels.forEach(function(label, idx) {
            if (y > 700) {
              doc.addPage(useLandscape ? 'landscape' : 'portrait', 'letter');
              y = 40;
              doc.setFontSize(fontSize);
              drawHeader();
            }
            var rowTotal = 0;
            for (var j = 0; j < ledger.length; j++) {
              var f = ledger[j].fixtures || {};
              var val = f[label];
              rowTotal += (val != null && val !== '') ? (parseInt(val, 10) || 0) : 0;
            }
            var priceRow = FIXTURE_PRICES[fixtureIds[idx]];
            var laborStr = priceRow
              ? '[' + priceRow.roughIn + ', ' + priceRow.topOut + ', ' + priceRow.trim + ']'
              : '—';
            doc.text(String(rowTotal), margin + cellPad, y);
            doc.text(laborStr, margin + totalColWidth + cellPad, y);
            doc.text(label, margin + totalColWidth + laborColWidth + cellPad, y);
            var x = margin + totalColWidth + laborColWidth + itemColWidth;
            for (var k = 0; k < ledger.length; k++) {
              var fj = ledger[k].fixtures || {};
              var v = fj[label];
              var str = (v != null && v !== '') ? String(v) : '';
              doc.text(str, x + cellPad, y);
              x += colWidth;
            }
            y += lineHeight;
          });

          y += lineHeight;
          var totalRoughIn = 0, totalTopOut = 0, totalTrim = 0;
          fixtureLabels.forEach(function(label, idx) {
            var priceRow = FIXTURE_PRICES[fixtureIds[idx]];
            if (!priceRow) return;
            var totalQty = 0;
            for (var j = 0; j < ledger.length; j++) {
              var f = ledger[j].fixtures || {};
              var val = f[label];
              totalQty += (val != null && val !== '') ? (parseInt(val, 10) || 0) : 0;
            }
            totalRoughIn += totalQty * priceRow.roughIn;
            totalTopOut += totalQty * priceRow.topOut;
            totalTrim += totalQty * priceRow.trim;
          });
          doc.setFont(undefined, 'bold');
          doc.text('Total labor (est.): Rough in ' + formatNum(totalRoughIn, 1) + ', Top out ' + formatNum(totalTopOut, 1) + ', Trim ' + formatNum(totalTrim, 1), margin, y);
          doc.setFont(undefined, 'normal');

          doc.save('fixture-cover-page.pdf');
        } catch (e) {
          console.error(e);
          alert('Cover page PDF export failed.');
        }
      }

      function addTakeoffRow() {
        var container = $('takeoffRows');
        var row = document.createElement('div');
        row.className = 'takeoff-row';
        row.innerHTML = '<input type="text" placeholder="Item (e.g. Copper pipe 1/2\")" class="takeoff-desc"> <input type="text" placeholder="Qty" class="takeoff-qty"> <button type="button" class="takeoff-remove" aria-label="Remove row">Remove</button>';
        container.appendChild(row);
      }

      function addAdditionalLaborRow() {
        var container = $('additionalLaborRows');
        if (!container) return;
        var row = document.createElement('div');
        row.className = 'additional-labor-row';
        row.innerHTML = '<input type="text" class="additional-labor-desc" placeholder="Description (e.g. Demo, Underground, Prep)"> <input type="number" class="additional-labor-hours" min="0" step="0.5" placeholder="Hrs" title="Hours"> <select class="additional-labor-crew" title="Crew size"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select> <input type="number" class="additional-labor-rate" min="0" step="0.01" placeholder="Rate" title="Labor rate $/hr"> <button type="button" class="additional-labor-remove" aria-label="Remove row">Remove</button>';
        container.appendChild(row);
        qsa('input, select', row).forEach(function(el) {
          el.addEventListener('input', calculateTotals);
          el.addEventListener('change', calculateTotals);
        });
        var crew = parseInt((row.querySelector('.additional-labor-crew') || {}).value, 10) || 1;
        var rateEl = $('crewRate' + crew);
        var rate = (rateEl && parseFloat(rateEl.value)) || 0;
        var rateInput = row.querySelector('.additional-labor-rate');
        if (rateInput) rateInput.value = rate;
        calculateTotals();
      }

      function addAdditionalMaterialRow() {
        var container = $('additionalMaterialRows');
        if (!container) return;
        var row = document.createElement('div');
        row.className = 'additional-material-row';
        row.innerHTML = '<input type="text" class="additional-material-desc" placeholder="Description (e.g. Pipe, Fittings)"> <input type="number" class="additional-material-amount" min="0" step="0.01" placeholder="Amount" title="Amount ($)"> <button type="button" class="additional-material-remove" aria-label="Remove row">Remove</button>';
        container.appendChild(row);
        qsa('input', row).forEach(function(el) {
          el.addEventListener('input', calculateTotals);
          el.addEventListener('change', calculateTotals);
        });
        calculateTotals();
      }

      function buildShareState() {
        var fixtures = collectCurrentFixtures();
        var ledger = getFixtureLedger();
        var additionalLabor = [];
        qsa('.additional-labor-row').forEach(function(row) {
          var descEl = row.querySelector('.additional-labor-desc');
          var hoursEl = row.querySelector('.additional-labor-hours');
          var crewEl = row.querySelector('.additional-labor-crew');
          var rateEl = row.querySelector('.additional-labor-rate');
          additionalLabor.push({
            desc: descEl ? descEl.value : '',
            hours: hoursEl ? hoursEl.value : '',
            crew: crewEl ? crewEl.value : '1',
            rate: rateEl ? rateEl.value : ''
          });
        });
        var additionalMaterials = [];
        qsa('.additional-material-row').forEach(function(row) {
          var descEl = row.querySelector('.additional-material-desc');
          var amountEl = row.querySelector('.additional-material-amount');
          additionalMaterials.push({
            desc: descEl ? descEl.value : '',
            amount: amountEl ? amountEl.value : ''
          });
        });
        var takeoff = [];
        qsa('.takeoff-row').forEach(function(row) {
          var descEl = row.querySelector('.takeoff-desc');
          var qtyEl = row.querySelector('.takeoff-qty');
          takeoff.push({
            desc: descEl ? descEl.value : '',
            qty: qtyEl ? qtyEl.value : ''
          });
        });
        var inclusionsVal = getStr('inclusions');
        var scopeVal = getStr('scopeNotes');
        var state = {
          fixtures: fixtures,
          ledger: ledger,
          additionalLabor: additionalLabor,
          additionalMaterials: additionalMaterials,
          customerName: getStr('customerName'),
          customerAddress: getStr('customerAddress'),
          jobName: getStr('jobName'),
          jobAddress: getStr('jobAddress'),
          bidDate: getStr('bidDate'),
          bidNumber: getStr('bidNumber'),
          planTitle: getStr('planTitle'),
          planName: getStr('planName'),
          planIssueDate: getStr('planIssueDate'),
          crewRate1: getNum('crewRate1'),
          crewRate2: getNum('crewRate2'),
          crewRate3: getNum('crewRate3'),
          materialsMarkupPct: getNum('materialsMarkupPct'),
          fixtureLaborMarkupPct: getNum('fixtureLaborMarkupPct'),
          takeoff: takeoff,
          inclusions: inclusionsVal === INCLUSIONS_DEFAULT ? 'default' : inclusionsVal,
          scopeNotes: scopeVal === EXCLUSIONS_AND_SCOPE_DEFAULT ? 'default' : scopeVal
        };
        return state;
      }

      function getShareUrl() {
        var state = buildShareState();
        var payload = JSON.stringify(state);
        var encoded;
        try {
          encoded = btoa(unescape(encodeURIComponent(payload)));
        } catch (e) {
          encoded = btoa(payload);
        }
        return location.origin + location.pathname + (location.search || '') + '#' + encoded;
      }

      function shareViaUrl() {
        var url = getShareUrl();
        try {
          window.history.replaceState(null, '', url);
        } catch (err) {
          window.location.hash = url.split('#')[1] || '';
        }
        var feedbackMsg = url.length > MAX_SHARE_URL_LENGTH
          ? 'URL is long, make sure to only send in apps that can handle long text strings. Copied to clipboard.'
          : 'URL copied to clipboard';
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() {
            if (url.length > MAX_SHARE_URL_LENGTH) showShareUrlLongModal(feedbackMsg); else showShareFeedback(feedbackMsg);
          }).catch(function() {
            if (url.length > MAX_SHARE_URL_LENGTH) showShareUrlLongModal(feedbackMsg); else showShareFeedback('URL updated (copy from address bar)');
          });
        } else {
          if (url.length > MAX_SHARE_URL_LENGTH) showShareUrlLongModal('URL is long, make sure to only send in apps that can handle long text strings. Copy the URL from your address bar.'); else showShareFeedback('URL updated (copy from address bar)');
        }
      }

      function shareViaEmail() {
        var url = getShareUrl();
        try {
          window.history.replaceState(null, '', url);
        } catch (err) {
          window.location.hash = url.split('#')[1] || '';
        }
        var subject = (getStr('bidNumber') || 'Bid').replace(/\s+/g, ' ');
        var mailto = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(url);
        window.location.href = mailto;
      }

      function showShareUrlLongModal(message) {
        var modal = $('shareUrlLongModal');
        var msgEl = $('shareUrlLongModalMessage');
        if (modal && msgEl) {
          var text = (message || '').replace(/\s*Copied to clipboard\.?\s*$/, '').trim();
          msgEl.textContent = text;
          modal.classList.add('visible');
          modal.setAttribute('aria-hidden', 'false');
        }
      }

      function closeShareUrlLongModal() {
        var modal = $('shareUrlLongModal');
        if (modal) {
          var returnFocus = $('shareViaUrlBtn') || $('shareViaEmailBtn');
          if (returnFocus && document.activeElement && modal.contains(document.activeElement)) {
            returnFocus.focus();
          }
          modal.classList.remove('visible');
          modal.setAttribute('aria-hidden', 'true');
        }
      }

      function showShareFeedback(message) {
        var btn = $('shareViaUrlBtn');
        if (!btn) return;
        var hasSvg = !!btn.querySelector('svg');
        var orig = hasSvg ? btn.innerHTML : btn.textContent;
        btn.textContent = message;
        if (btn.disabled !== undefined) btn.disabled = true;
        btn.style.pointerEvents = 'none';
        setTimeout(function() {
          if (hasSvg) btn.innerHTML = orig; else btn.textContent = orig;
          if (btn.disabled !== undefined) btn.disabled = false;
          btn.style.pointerEvents = '';
        }, 2000);
      }

      function restoreFromShareHash() {
        var hash = location.hash;
        if (!hash || hash.length < 2) return;
        var encoded = hash.slice(1);
        var payload;
        try {
          var decoded = decodeURIComponent(escape(atob(encoded)));
          payload = JSON.parse(decoded);
        } catch (e) {
          return;
        }
        if (!payload || typeof payload.fixtures !== 'object') return;
        var ledger = Array.isArray(payload.ledger) ? payload.ledger : [];
        var additionalLabor = Array.isArray(payload.additionalLabor) ? payload.additionalLabor : [];
        var additionalMaterials = Array.isArray(payload.additionalMaterials) ? payload.additionalMaterials : [];

        Object.keys(payload.fixtures).forEach(function(label) {
          var id = fixtureLabelToId[label];
          var el = id ? $(id) : null;
          if (el && el.value !== undefined) {
            var val = payload.fixtures[label];
            el.value = val != null ? String(val) : '';
          }
        });

        setFixtureLedger(ledger);
        renderLedgerList();

        var laborContainer = $('additionalLaborRows');
        if (laborContainer) {
          qsa('.additional-labor-row', laborContainer).forEach(function(row) { row.remove(); });
          var items = additionalLabor.length ? additionalLabor : [{ desc: '', hours: '', crew: '1', rate: '' }];
          items.forEach(function(item) {
            var row = document.createElement('div');
            row.className = 'additional-labor-row';
            row.innerHTML = '<input type="text" class="additional-labor-desc" placeholder="Description (e.g. Demo, Underground, Prep)"> <input type="number" class="additional-labor-hours" min="0" step="0.5" placeholder="Hrs" title="Hours"> <select class="additional-labor-crew" title="Crew size"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select> <input type="number" class="additional-labor-rate" min="0" step="0.01" placeholder="Rate" title="Labor rate $/hr"> <button type="button" class="additional-labor-remove" aria-label="Remove row">Remove</button>';
            laborContainer.appendChild(row);
            var descEl = row.querySelector('.additional-labor-desc');
            var hoursEl = row.querySelector('.additional-labor-hours');
            var crewEl = row.querySelector('.additional-labor-crew');
            var rateEl = row.querySelector('.additional-labor-rate');
            if (descEl) descEl.value = item.desc != null ? String(item.desc) : '';
            if (hoursEl) hoursEl.value = item.hours != null ? String(item.hours) : '';
            if (crewEl) crewEl.value = item.crew != null ? String(item.crew) : '1';
            if (rateEl) rateEl.value = item.rate != null ? String(item.rate) : '';
            qsa('input, select', row).forEach(function(el) {
              el.addEventListener('input', calculateTotals);
              el.addEventListener('change', calculateTotals);
            });
            if (!(String((item.rate || '').trim())) && rateEl) {
              var crew = parseInt(crewEl ? crewEl.value : '1', 10) || 1;
              var rateFromCrew = $('crewRate' + crew);
              var rate = (rateFromCrew && parseFloat(rateFromCrew.value)) || 0;
              rateEl.value = rate;
            }
          });
        }

        var materialContainer = $('additionalMaterialRows');
        if (materialContainer) {
          qsa('.additional-material-row', materialContainer).forEach(function(row) { row.remove(); });
          var matItems = additionalMaterials.length ? additionalMaterials : [{ desc: '', amount: '' }];
          matItems.forEach(function(item) {
            var row = document.createElement('div');
            row.className = 'additional-material-row';
            row.innerHTML = '<input type="text" class="additional-material-desc" placeholder="Description (e.g. Pipe, Fittings)"> <input type="number" class="additional-material-amount" min="0" step="0.01" placeholder="Amount" title="Amount ($)"> <button type="button" class="additional-material-remove" aria-label="Remove row">Remove</button>';
            materialContainer.appendChild(row);
            var descEl = row.querySelector('.additional-material-desc');
            var amountEl = row.querySelector('.additional-material-amount');
            if (descEl) descEl.value = item.desc != null ? String(item.desc) : '';
            if (amountEl) amountEl.value = item.amount != null ? String(item.amount) : '';
            qsa('input', row).forEach(function(el) {
              el.addEventListener('input', calculateTotals);
              el.addEventListener('change', calculateTotals);
            });
          });
        }

        if (payload.customerName != null) { var el = $('customerName'); if (el) el.value = String(payload.customerName); }
        if (payload.customerAddress != null) { var el = $('customerAddress'); if (el) el.value = String(payload.customerAddress); }
        if (payload.jobName != null) { var el = $('jobName'); if (el) el.value = String(payload.jobName); }
        if (payload.jobAddress != null) { var el = $('jobAddress'); if (el) el.value = String(payload.jobAddress); }
        if (payload.bidDate != null) { var el = $('bidDate'); if (el) el.value = String(payload.bidDate); }
        if (payload.bidNumber != null) { var el = $('bidNumber'); if (el) el.value = String(payload.bidNumber); }
        if (payload.planTitle != null) { var el = $('planTitle'); if (el) el.value = String(payload.planTitle); }
        if (payload.planName != null) { var el = $('planName'); if (el) el.value = String(payload.planName); }
        if (payload.planIssueDate != null) { var el = $('planIssueDate'); if (el) el.value = String(payload.planIssueDate); }
        if (payload.crewRate1 != null) { var el = $('crewRate1'); if (el) el.value = String(payload.crewRate1); }
        if (payload.crewRate2 != null) { var el = $('crewRate2'); if (el) el.value = String(payload.crewRate2); }
        if (payload.crewRate3 != null) { var el = $('crewRate3'); if (el) el.value = String(payload.crewRate3); }
        if (payload.materialsMarkupPct != null) { var el = $('materialsMarkupPct'); if (el) el.value = String(payload.materialsMarkupPct); }
        if (payload.fixtureLaborMarkupPct != null) { var el = $('fixtureLaborMarkupPct'); if (el) el.value = String(payload.fixtureLaborMarkupPct); }

        if (Array.isArray(payload.takeoff)) {
          var takeoffContainer = $('takeoffRows');
          if (takeoffContainer) {
            qsa('.takeoff-row', takeoffContainer).forEach(function(row) { row.remove(); });
            var takeoffItems = payload.takeoff.length ? payload.takeoff : [{ desc: '', qty: '' }];
            takeoffItems.forEach(function(item) {
              var row = document.createElement('div');
              row.className = 'takeoff-row';
              row.innerHTML = '<input type="text" placeholder="Item (e.g. Copper pipe 1/2\")" class="takeoff-desc"> <input type="text" placeholder="Qty" class="takeoff-qty"> <button type="button" class="takeoff-remove" aria-label="Remove row">Remove</button>';
              takeoffContainer.appendChild(row);
              var descEl = row.querySelector('.takeoff-desc');
              var qtyEl = row.querySelector('.takeoff-qty');
              if (descEl) descEl.value = item.desc != null ? String(item.desc) : '';
              if (qtyEl) qtyEl.value = item.qty != null ? String(item.qty) : '';
            });
          }
        }

        if (payload.inclusions !== undefined) {
          var incEl = $('inclusions');
          if (incEl) incEl.value = payload.inclusions === 'default' ? INCLUSIONS_DEFAULT : String(payload.inclusions);
        }
        if (payload.scopeNotes !== undefined) {
          var scopeEl = $('scopeNotes');
          if (scopeEl) scopeEl.value = payload.scopeNotes === 'default' ? EXCLUSIONS_AND_SCOPE_DEFAULT : String(payload.scopeNotes);
        }
        var termsEl = $('termsAndWarranty');
        if (termsEl) termsEl.value = TERMS_AND_WARRANTY_DEFAULT;

        calculateTotals();
        updateRoughBid();
      }

      function setupIncrementDecrement() {
        document.body.addEventListener('click', function(e) {
          var btn = e.target;
          if (btn.tagName !== 'BUTTON' || !btn.getAttribute('data-target')) return;
          var id = btn.getAttribute('data-target');
          var input = $(id);
          if (!input || input.type !== 'number') return;
          var step = parseFloat(input.step) || 1;
          var val = parseFloat(input.value) || 0;
          if (btn.getAttribute('aria-label') === 'Increase') input.value = Math.max(0, val + step);
          else input.value = Math.max(0, val - step);
          input.dispatchEvent(new Event('input', { bubbles: true }));
        });
      }

      var TERMS_AND_WARRANTY_DEFAULT = 'All work to be completed in a workmanlike manner in accordance with uniform code and/or specifications; workmanship warranty of one year for new construction projects considering substantial completion date. All material is guaranteed to be as specified; warranty by manufacturer, labor not included. No liability, no warranty on customer provided materials. All agreements contingent upon strikes, accidents or delays beyond our control. This estimate is subject to acceptance within thirty (30) days and is void thereafter at the option of Click Plumbing. Any alteration or deviation from above specifications involving extra cost, including rock excavation and removal or haul-off of spoils or debris will become an extra charge over and above the estimate.';

      var EXCLUSIONS_AND_SCOPE_DEFAULT = 'Concrete cutting, removal, and/or pour back is excluded from this proposal.\nThis proposal excludes all impact fees.\nThis proposal excludes any work not specifically described within.\nThis proposal excludes any electrical, fire protection, fire alarm, drywall, framing, or architectural finishes of any type.';

      var INCLUSIONS_DEFAULT = 'Permits';

      function clearForm() {
        document.getElementById('bidForm').reset();
        setDefaultDate();
        qsa('.takeoff-row').forEach(function(row, i) {
          if (i > 0) row.remove();
        });
        qsa('.takeoff-desc').forEach(function(el) { el.value = ''; });
        qsa('.takeoff-qty').forEach(function(el) { el.value = ''; });
        qsa('.additional-labor-row').forEach(function(row, i) {
          if (i > 0) row.remove();
        });
        qsa('.additional-labor-desc').forEach(function(el) { el.value = ''; });
        qsa('.additional-labor-hours').forEach(function(el) { el.value = ''; });
        qsa('.additional-labor-crew').forEach(function(el) { el.value = '1'; });
        qsa('.additional-labor-rate').forEach(function(el) { el.value = ''; });
        if ($('crewRate1')) $('crewRate1').value = '275';
        if ($('crewRate2')) $('crewRate2').value = '315';
        if ($('crewRate3')) $('crewRate3').value = '350';
        qsa('.additional-material-row').forEach(function(row, i) {
          if (i > 0) row.remove();
        });
        qsa('.additional-material-desc').forEach(function(el) { el.value = ''; });
        qsa('.additional-material-amount').forEach(function(el) { el.value = ''; });
        if ($('termsAndWarranty')) $('termsAndWarranty').value = TERMS_AND_WARRANTY_DEFAULT;
        if ($('scopeNotes')) $('scopeNotes').value = EXCLUSIONS_AND_SCOPE_DEFAULT;
        if ($('inclusions')) $('inclusions').value = INCLUSIONS_DEFAULT;
        requiredIds.forEach(function(id) { var el = $(id); if (el) el.classList.remove('error'); });
        calculateTotals();
        $('preview').classList.remove('visible');
        $('preview').innerHTML = '';
        var genBtn = $('generatePreview');
        if (genBtn) genBtn.classList.remove('view-active');
      }

      function fillWithSampleData() {
        if ($('customerName')) $('customerName').value = 'Sample Customer';
        if ($('customerAddress')) $('customerAddress').value = '456 Oak Ave\nPortland, OR 97202';
        if ($('jobName')) $('jobName').value = 'Main floor bath and kitchen';
        if ($('jobAddress')) $('jobAddress').value = '123 Main St\nPortland, OR 97201';
        if ($('bidDate')) $('bidDate').value = new Date().toISOString().slice(0, 10);
        if ($('bidNumber')) $('bidNumber').value = '2025-SAMPLE-001';
        if ($('planName')) $('planName').value = 'Floor plans A';
        if ($('planIssueDate')) $('planIssueDate').value = '2024-06-15';
        if ($('planTitle')) $('planTitle').value = 'Main and upper';
        if ($('fixtureToilets')) $('fixtureToilets').value = 2;
        if ($('fixtureBathSinks')) $('fixtureBathSinks').value = 2;
        if ($('fixtureKitchenSinks')) $('fixtureKitchenSinks').value = 1;
        if ($('fixtureShowerOnly')) $('fixtureShowerOnly').value = 1;
        if ($('fixturePlanPageName')) $('fixturePlanPageName').value = 'A-101';
        var takeoffRows = qsa('.takeoff-row');
        if (takeoffRows[0]) {
          var desc = takeoffRows[0].querySelector('.takeoff-desc');
          var qty = takeoffRows[0].querySelector('.takeoff-qty');
          if (desc) desc.value = 'Copper pipe 1/2"';
          if (qty) qty.value = '150';
        }
        var laborRows = qsa('.additional-labor-row');
        if (laborRows[0]) {
          var d = laborRows[0].querySelector('.additional-labor-desc');
          var h = laborRows[0].querySelector('.additional-labor-hours');
          var c = laborRows[0].querySelector('.additional-labor-crew');
          var r = laborRows[0].querySelector('.additional-labor-rate');
          if (d) d.value = 'Demo and prep';
          if (h) h.value = 8;
          if (c) c.value = '2';
          if (r) r.value = 315;
        }
        var materialRows = qsa('.additional-material-row');
        if (materialRows[0]) {
          var md = materialRows[0].querySelector('.additional-material-desc');
          var ma = materialRows[0].querySelector('.additional-material-amount');
          if (md) md.value = 'Pipe and fittings';
          if (ma) ma.value = 2500;
        }
        if ($('materialsMarkupPct')) $('materialsMarkupPct').value = 0;
        if ($('laborMarkupPct')) $('laborMarkupPct').value = 0;
        if ($('inclusions')) $('inclusions').value = 'Any change orders requested by the builder agreed to in writing';
        if ($('scopeNotes')) $('scopeNotes').value = EXCLUSIONS_AND_SCOPE_DEFAULT;
        requiredIds.forEach(function(id) {
          var el = $(id);
          if (el) el.classList.remove('error');
        });
        calculateTotals();
      }

      function loadLedgerEntry(entry) {
        var planInput = $('fixturePlanPageName');
        if (planInput) planInput.value = entry.pageName || '';
        var f = entry.fixtures || {};
        Object.keys(f).forEach(function(label) {
          var id = fixtureLabelToId[label];
          if (id) {
            var el = $(id);
            if (el && el.type === 'number') el.value = Math.max(0, parseInt(f[label], 10) || 0);
          }
        });
        calculateTotals();
      }

      function renderLedgerList() {
        var listEl = $('fixtureLedgerList');
        if (!listEl) return;
        var ledger = getFixtureLedger();
        listEl.innerHTML = '';
        if (ledger.length === 0) {
          listEl.innerHTML = '<p class="fixture-ledger-empty">No saved plan pages. Enter a plan page name and fixture counts, then click Save to ledger.</p>';
          return;
        }
        ledger.forEach(function(entry) {
          var total = 0;
          var f = entry.fixtures || {};
          Object.keys(f).forEach(function(k) { total += (parseInt(f[k], 10) || 0); });
          var item = document.createElement('div');
          item.className = 'fixture-ledger-item';
          var nameEl = document.createElement('div');
          nameEl.className = 'fixture-ledger-item-name';
          nameEl.textContent = entry.pageName || 'Unnamed';
          var metaEl = document.createElement('div');
          metaEl.className = 'fixture-ledger-item-meta';
          metaEl.textContent = formatNum(total, 0) + ' fixture(s)';
          var actions = document.createElement('div');
          actions.className = 'fixture-ledger-item-actions';
          var loadBtn = document.createElement('button');
          loadBtn.type = 'button';
          loadBtn.className = 'btn btn-outline';
          loadBtn.textContent = 'Load';
          loadBtn.addEventListener('click', function() { loadLedgerEntry(entry); });
          var delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'btn btn-outline';
          delBtn.textContent = 'Delete';
          delBtn.style.color = 'var(--error)';
          delBtn.style.borderColor = 'var(--error)';
          delBtn.addEventListener('click', function() {
            var next = getFixtureLedger().filter(function(e) { return e.id !== entry.id; });
            setFixtureLedger(next);
            renderLedgerList();
            calculateTotals();
          });
          actions.appendChild(loadBtn);
          actions.appendChild(delBtn);
          item.appendChild(nameEl);
          item.appendChild(metaEl);
          item.appendChild(actions);
          listEl.appendChild(item);
        });
      }

      function saveToLedger() {
        var planInput = $('fixturePlanPageName');
        var pageName = (planInput && planInput.value) ? planInput.value.trim() : '';
        var ledger = getFixtureLedger();
        if (!pageName) pageName = 'Plan page ' + (ledger.length + 1);
        var fixtures = collectCurrentFixtures();
        var entry = {
          id: Date.now().toString(),
          pageName: pageName,
          fixtures: fixtures,
          savedAt: Date.now()
        };
        ledger.push(entry);
        setFixtureLedger(ledger);
        renderLedgerList();
        calculateTotals();
      }

      function clearFixtureCounts() {
        fixtureIds.forEach(function(id) {
          var el = $(id);
          if (el && el.type === 'number') el.value = 0;
        });
        calculateTotals();
      }

      function renderFixturePriceTable() {
        var tbody = $('fixturePriceTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';
        var ids = [
          'fixtureToilets', 'fixtureBathSinks', 'fixtureKitchenSinks', 'fixtureDisposals',
          'fixtureUrinals', 'fixtureTubs', 'fixtureShowerOnly', 'fixtureShowerTub',
          'fixtureLaundrySinks', 'fixtureHoseBibs', 'fixtureWaterFountain', 'fixtureWHGas', 'fixtureWHElectric',
          'fixtureWHTankless', 'fixtureGasDrops'
        ];
        ids.forEach(function(id) {
          var row = FIXTURE_PRICES[id];
          if (!row) return;
          var name = row.label;
          if (row.note) name += ' (' + row.note + ')';
          var tr = document.createElement('tr');
          var tdName = document.createElement('td');
          tdName.textContent = name;
          tr.appendChild(tdName);
          function makeInput(field, step) {
            var input = document.createElement('input');
            input.type = 'number';
            input.min = 0;
            input.step = step || 1;
            input.className = 'fixture-price-input';
            input.setAttribute('data-fixture-id', id);
            input.setAttribute('data-field', field);
            input.value = row[field];
            var td = document.createElement('td');
            td.appendChild(input);
            return td;
          }
          tr.appendChild(makeInput('price', 1));
          tr.appendChild(makeInput('roughIn', 0.5));
          tr.appendChild(makeInput('topOut', 0.5));
          tr.appendChild(makeInput('trim', 0.5));
          tbody.appendChild(tr);
        });
      }

      function syncFixturePriceInput(e) {
        var el = e.target;
        var id = el.getAttribute('data-fixture-id');
        var field = el.getAttribute('data-field');
        if (!id || !field || !FIXTURE_PRICES[id]) return;
        var val = parseFloat(el.value, 10);
        if (isNaN(val)) val = 0;
        FIXTURE_PRICES[id][field] = val;
      }

      function resetFixturePricesToDefault() {
        var modeDefaults = FIXTURE_MODES[currentFixtureMode] || {};
        Object.keys(modeDefaults).forEach(function(id) {
          var def = modeDefaults[id];
          if (!FIXTURE_PRICES[id]) FIXTURE_PRICES[id] = {};
          FIXTURE_PRICES[id].price = def.price;
          FIXTURE_PRICES[id].roughIn = def.roughIn;
          FIXTURE_PRICES[id].topOut = def.topOut;
          FIXTURE_PRICES[id].trim = def.trim;
        });
        renderFixturePriceTable();
        calculateTotals();
      }

      function exportFixturePricesAndTimes() {
        var ids = [
          'fixtureToilets', 'fixtureBathSinks', 'fixtureKitchenSinks', 'fixtureDisposals',
          'fixtureUrinals', 'fixtureTubs', 'fixtureShowerOnly', 'fixtureShowerTub',
          'fixtureLaundrySinks', 'fixtureHoseBibs', 'fixtureWaterFountain', 'fixtureWHGas', 'fixtureWHElectric',
          'fixtureWHTankless', 'fixtureGasDrops'
        ];
        function csvEscape(s) {
          var str = String(s == null ? '' : s);
          return str.indexOf(',') >= 0 || str.indexOf('"') >= 0 ? '"' + str.replace(/"/g, '""') + '"' : str;
        }
        var rows = ['Fixture,Price,Rough in,Top out,Trim'];
        ids.forEach(function(id) {
          var row = FIXTURE_PRICES[id];
          if (!row) return;
          var name = row.label || '';
          if (row.note) name += ' (' + row.note + ')';
          rows.push([
            csvEscape(name),
            row.price != null ? row.price : '',
            row.roughIn != null ? row.roughIn : '',
            row.topOut != null ? row.topOut : '',
            row.trim != null ? row.trim : ''
          ].join(','));
        });
        var csv = rows.join('\r\n');
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'fixture-prices-and-times.csv';
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function hasFixturePriceChangesFromMode(modeName) {
        var base = FIXTURE_MODES[modeName];
        if (!base) return false;
        var ids = Object.keys(base);
        for (var i = 0; i < ids.length; i++) {
          var id = ids[i];
          var baseRow = base[id] || {};
          var currRow = FIXTURE_PRICES[id] || {};
          if (baseRow.price !== currRow.price ||
              baseRow.roughIn !== currRow.roughIn ||
              baseRow.topOut !== currRow.topOut ||
              baseRow.trim !== currRow.trim) {
            return true;
          }
        }
        return false;
      }

      function updateFixtureModeUi() {
        var select = $('fixtureModeSelect');
        if (select) {
          select.value = currentFixtureMode;
        }
        var status = $('fixtureModeStatus');
        var details = $('fixturePriceDetails');
        if (status) {
          if (currentFixtureMode === 'Trace') {
            status.textContent = 'TRACE MODE ACTIVE';
            status.classList.add('fixture-mode-status-trace');
          } else {
            status.textContent = 'Mode: Malachi';
            status.classList.remove('fixture-mode-status-trace');
          }
        }
        if (details) {
          if (currentFixtureMode === 'Trace') {
            details.classList.add('fixture-mode-trace');
          } else {
            details.classList.remove('fixture-mode-trace');
          }
        }
      }

      function setFixtureMode(modeName, opts) {
        opts = opts || {};
        var confirmIfChanged = opts.confirmIfChanged !== false;
        if (!FIXTURE_MODES[modeName]) return false;
        if (modeName === currentFixtureMode) {
          renderFixturePriceTable();
          calculateTotals();
          updateFixtureModeUi();
          return true;
        }
        if (confirmIfChanged && hasFixturePriceChangesFromMode(currentFixtureMode)) {
          var ok = window.confirm('You have custom fixture pricing. Switch to ' + modeName + ' mode and overwrite them with that mode\u2019s defaults?');
          if (!ok) {
            updateFixtureModeUi();
            return false;
          }
        }
        currentFixtureMode = modeName;
        var modeDefaults = FIXTURE_MODES[currentFixtureMode];
        FIXTURE_PRICES = JSON.parse(JSON.stringify(modeDefaults));
        try {
          localStorage.setItem('bidtoolingFixtureMode', currentFixtureMode);
        } catch (e) {
          // ignore
        }
        renderFixturePriceTable();
        calculateTotals();
        updateFixtureModeUi();
        return true;
      }

      $('generatePreview').addEventListener('click', onGeneratePreview);
      $('printBtn').addEventListener('click', onPrint);
      $('exportPdf').addEventListener('click', openExternalSummaryView);
      var letterheadCopyLink = $('letterheadCopyLink');
      if (letterheadCopyLink) {
        letterheadCopyLink.addEventListener('click', function(e) {
          e.preventDefault();
          if (!validateForm()) {
            alert(REQUIRED_FIELDS_MESSAGE);
            return;
          }
          var data = collectFormData();
          var totals = calculateTotals();
          var plainText = buildExternalSummaryPlainText(data, totals);
          var html = buildExternalSummaryHtml(plainText);
          function fallbackCopy() {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              return navigator.clipboard.writeText(plainText);
            }
            var ta = document.createElement('textarea');
            ta.value = plainText;
            ta.setAttribute('readonly', '');
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try {
              return document.execCommand('copy');
            } finally {
              document.body.removeChild(ta);
            }
          }
          function tryCopy() {
            if (navigator.clipboard && navigator.clipboard.write) {
              return navigator.clipboard.write([
                new ClipboardItem({ 'text/plain': new Blob([plainText], { type: 'text/plain' }), 'text/html': new Blob([html], { type: 'text/html' }) })
              ]).then(function() { return true; }).catch(function() { return fallbackCopy(); });
            }
            return Promise.resolve(fallbackCopy());
          }
          var title = getStr('bidNumber') || 'My Customized Document';
          var url = 'https://docs.google.com/document/d/1Xs76a1fAZfj4GGyIQ-wH_x98rtjnfoB7RVt7cMBmPP8/copy?title=' + encodeURIComponent(title);
          tryCopy().then(function() { window.open(url, '_blank', 'noopener,noreferrer'); });
        });
      }
      var externalSummaryCopyBtn = $('externalSummaryCopyBtn');
      if (externalSummaryCopyBtn) {
        externalSummaryCopyBtn.addEventListener('click', function() {
          if (!validateForm()) {
            alert(REQUIRED_FIELDS_MESSAGE);
            return;
          }
          var data = collectFormData();
          var totals = calculateTotals();
          var plainText = buildExternalSummaryPlainText(data, totals);
          var html = buildExternalSummaryHtml(plainText);
          var btn = this;
          var originalText = btn.textContent;
          function fallbackCopy() {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              return navigator.clipboard.writeText(plainText);
            }
            var ta = document.createElement('textarea');
            ta.value = plainText;
            ta.setAttribute('readonly', '');
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try {
              return document.execCommand('copy');
            } finally {
              document.body.removeChild(ta);
            }
          }
          function tryCopy() {
            if (navigator.clipboard && navigator.clipboard.write) {
              return navigator.clipboard.write([
                new ClipboardItem({ 'text/plain': new Blob([plainText], { type: 'text/plain' }), 'text/html': new Blob([html], { type: 'text/html' }) })
              ]).then(function() { return true; }).catch(function() { return fallbackCopy(); });
            }
            return Promise.resolve(fallbackCopy());
          }
          tryCopy().then(function(ok) {
            if (ok) {
              btn.textContent = 'Copied!';
              setTimeout(function() { btn.textContent = originalText; }, 2000);
            } else {
              alert('Copy failed. Please select and copy manually from the View summary.');
            }
          });
        });
      }
      $('externalSummaryDownloadPdf').addEventListener('click', function() {
        exportToPDF();
      });
      $('externalSummaryPrint').addEventListener('click', function() {
        if (!showExternalSummaryBelow()) return;
        document.body.classList.add('print-external-summary');
        setTimeout(function() { window.print(); document.body.classList.remove('print-external-summary'); }, 100);
      });
      $('addTakeoffRow').addEventListener('click', addTakeoffRow);
      var takeoffRowsEl = $('takeoffRows');
      if (takeoffRowsEl) {
        takeoffRowsEl.addEventListener('click', function(e) {
          if (e.target.classList.contains('takeoff-remove')) {
            var row = e.target.closest('.takeoff-row');
            if (row) {
              var desc = row.querySelector('.takeoff-desc');
              var qty = row.querySelector('.takeoff-qty');
              if (desc) desc.value = '';
              if (qty) qty.value = '';
            }
          }
        });
      }
      document.addEventListener('keydown', function(e) {
        if (e.key !== 'Delete' && e.key !== 'Backspace') return;
        var el = document.activeElement;
        if (!el) return;
        if (takeoffRowsEl && takeoffRowsEl.contains(el) && el.nodeName === 'INPUT' && (el.classList.contains('takeoff-desc') || el.classList.contains('takeoff-qty'))) {
          el.value = '';
          e.preventDefault();
          return;
        }
        var laborRows = $('additionalLaborRows');
        if (laborRows && laborRows.contains(el)) {
          if (el.classList.contains('additional-labor-desc') || el.classList.contains('additional-labor-hours') || el.classList.contains('additional-labor-rate')) {
            el.value = '';
            e.preventDefault();
          } else if (el.classList.contains('additional-labor-crew') && el.nodeName === 'SELECT') {
            el.selectedIndex = 0;
            el.dispatchEvent(new Event('change', { bubbles: true }));
            e.preventDefault();
          }
          return;
        }
        var materialRows = $('additionalMaterialRows');
        if (materialRows && materialRows.contains(el) && (el.classList.contains('additional-material-desc') || el.classList.contains('additional-material-amount'))) {
          el.value = '';
          e.preventDefault();
        }
      }, true);
      if ($('fillSample')) $('fillSample').addEventListener('click', fillWithSampleData);
      if ($('shareViaUrlBtn')) $('shareViaUrlBtn').addEventListener('click', shareViaUrl);
      if ($('shareViaEmailBtn')) $('shareViaEmailBtn').addEventListener('click', shareViaEmail);
      if ($('bidDate')) $('bidDate').addEventListener('input', updateBidNumberFromDateAndJob);
      if ($('bidDate')) $('bidDate').addEventListener('change', updateBidNumberFromDateAndJob);
      if ($('jobName')) $('jobName').addEventListener('input', updateBidNumberFromDateAndJob);
      if ($('jobName')) $('jobName').addEventListener('change', updateBidNumberFromDateAndJob);
      if ($('bidNumber')) $('bidNumber').addEventListener('input', function() {
        var el = $('bidNumber');
        userEditedBidNumber = el && (el.value || '').trim() !== '';
      });
      var shareUrlLongModal = $('shareUrlLongModal');
      var shareUrlModalBackdrop = shareUrlLongModal && shareUrlLongModal.querySelector('.share-url-modal-backdrop');
      var shareUrlModalDialog = shareUrlLongModal && shareUrlLongModal.querySelector('.share-url-modal-dialog');
      if (shareUrlModalBackdrop) shareUrlModalBackdrop.addEventListener('click', closeShareUrlLongModal);
      if ($('shareUrlLongModalClose')) $('shareUrlLongModalClose').addEventListener('click', closeShareUrlLongModal);
      if (shareUrlModalDialog) shareUrlModalDialog.addEventListener('click', function(e) { e.stopPropagation(); });
      if ($('addAdditionalLaborRow')) $('addAdditionalLaborRow').addEventListener('click', addAdditionalLaborRow);
      if ($('addAdditionalMaterialRow')) $('addAdditionalMaterialRow').addEventListener('click', addAdditionalMaterialRow);
      var additionalMaterialRowsEl = $('additionalMaterialRows');
      if (additionalMaterialRowsEl) {
        additionalMaterialRowsEl.addEventListener('click', function(e) {
          if (e.target.classList.contains('additional-material-remove')) {
            var row = e.target.closest('.additional-material-row');
            if (row) {
              var desc = row.querySelector('.additional-material-desc');
              var amount = row.querySelector('.additional-material-amount');
              if (desc) desc.value = '';
              if (amount) amount.value = '';
              calculateTotals();
            }
          }
        });
      }
      if ($('openCrewPricing')) {
        $('openCrewPricing').addEventListener('click', function() {
          var details = $('crewPricingDetails');
          if (details) {
            details.open = !details.open;
            this.setAttribute('aria-expanded', details.open ? 'true' : 'false');
            if (details.open) details.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      }
      var crewPricingDetailsEl = $('crewPricingDetails');
      if (crewPricingDetailsEl) {
        crewPricingDetailsEl.addEventListener('toggle', function() {
          var btn = $('openCrewPricing');
          if (btn) btn.setAttribute('aria-expanded', this.open ? 'true' : 'false');
        });
      }
      var additionalLaborRowsEl = $('additionalLaborRows');
      if (additionalLaborRowsEl) {
        additionalLaborRowsEl.addEventListener('click', function(e) {
          if (e.target.classList.contains('additional-labor-remove')) {
            var row = e.target.closest('.additional-labor-row');
            if (row) {
              var desc = row.querySelector('.additional-labor-desc');
              var hours = row.querySelector('.additional-labor-hours');
              var crew = row.querySelector('.additional-labor-crew');
              var rate = row.querySelector('.additional-labor-rate');
              if (desc) desc.value = '';
              if (hours) hours.value = '';
              if (crew) { crew.selectedIndex = 0; crew.dispatchEvent(new Event('change', { bubbles: true })); }
              if (rate) rate.value = '';
              calculateTotals();
            }
          }
        });
        additionalLaborRowsEl.addEventListener('change', function(e) {
          if (e.target.classList.contains('additional-labor-crew')) {
            var row = e.target.closest('.additional-labor-row');
            if (!row) return;
            var crew = parseInt(e.target.value, 10) || 1;
            var rateEl = $('crewRate' + crew);
            var rate = (rateEl && parseFloat(rateEl.value)) || 0;
            var rateInput = row.querySelector('.additional-labor-rate');
            if (rateInput) rateInput.value = rate;
            calculateTotals();
          }
        });
        additionalLaborRowsEl.addEventListener('input', function(e) {
          if (e.target.classList.contains('additional-labor-desc') || e.target.classList.contains('additional-labor-hours')) {
            var row = e.target.closest('.additional-labor-row');
            if (!row) return;
            var rateInput = row.querySelector('.additional-labor-rate');
            if (!rateInput || String(rateInput.value || '').trim() !== '') return;
            var crew = parseInt((row.querySelector('.additional-labor-crew') || {}).value, 10) || 1;
            var rateEl = $('crewRate' + crew);
            var rate = (rateEl && parseFloat(rateEl.value)) || 0;
            rateInput.value = rate;
            calculateTotals();
          }
        });
      }
      $('clearBtn').addEventListener('click', clearForm);
      if ($('clearAllFieldsBtn')) $('clearAllFieldsBtn').addEventListener('click', function() {
        clearForm();
        var extEl = $('externalSummaryPreview');
        if (extEl) { extEl.classList.remove('visible'); extEl.innerHTML = ''; }
        var exportBtn = $('exportPdf');
        if (exportBtn) exportBtn.classList.remove('view-active');
        try { window.history.replaceState(null, '', location.pathname + (location.search || '')); } catch (e) { location.hash = ''; }
      });
      var roughCalculatorBtn = $('roughCalculatorBtn');
      var roughCalculatorSection = $('roughCalculatorSection');
      if (roughCalculatorBtn && roughCalculatorSection) {
        roughCalculatorBtn.addEventListener('click', function() {
          var isHidden = roughCalculatorSection.classList.contains('hidden');
          if (isHidden) {
            roughCalculatorSection.classList.remove('hidden');
            roughCalculatorSection.setAttribute('aria-hidden', 'false');
            roughCalculatorBtn.setAttribute('aria-expanded', 'true');
            roughCalculatorSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            updateRoughBid();
          } else {
            roughCalculatorSection.classList.add('hidden');
            roughCalculatorSection.setAttribute('aria-hidden', 'true');
            roughCalculatorBtn.setAttribute('aria-expanded', 'false');
          }
        });
      }
      if ($('fixtureLaborCostWrap')) {
        $('fixtureLaborCostWrap').addEventListener('click', function() {
          var costEl = $('fixtureLaborCost');
          if (!costEl) return;
          var raw = parseFloat(costEl.getAttribute('data-raw-value')) || 0;
          var fmt = costEl.getAttribute('data-format') || 'short';
          if (fmt === 'short') {
            costEl.setAttribute('data-format', 'long');
            costEl.textContent = raw.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          } else {
            costEl.setAttribute('data-format', 'short');
            costEl.textContent = formatFixtureCostShort(raw);
          }
        });
      }
      if ($('saveToLedger')) $('saveToLedger').addEventListener('click', saveToLedger);
      if ($('exportCoverPage')) $('exportCoverPage').addEventListener('click', exportCoverPage);
      if ($('clearFixtureCounts')) $('clearFixtureCounts').addEventListener('click', clearFixtureCounts);
      if ($('resetFixturePrices')) $('resetFixturePrices').addEventListener('click', resetFixturePricesToDefault);
      if ($('exportFixturePricesBtn')) $('exportFixturePricesBtn').addEventListener('click', exportFixturePricesAndTimes);
      var fixturePriceTable = $('fixturePriceTable');
      if (fixturePriceTable) {
        fixturePriceTable.addEventListener('input', syncFixturePriceInput);
        fixturePriceTable.addEventListener('change', syncFixturePriceInput);
      }

      var fixtureModeSelectEl = $('fixtureModeSelect');
      if (fixtureModeSelectEl) {
        fixtureModeSelectEl.addEventListener('change', function(e) {
          var newMode = e.target.value;
          if (!FIXTURE_MODES[newMode]) {
            updateFixtureModeUi();
            return;
          }
          var ok = setFixtureMode(newMode, { confirmIfChanged: true });
          if (!ok) {
            updateFixtureModeUi();
          }
        });
      }

      qsa('input, select, textarea').forEach(function(el) {
        el.addEventListener('input', calculateTotals);
        el.addEventListener('change', calculateTotals);
      });
      var roughCalcContent = $('roughCalculatorContent');
      if (roughCalcContent) {
        qsa('input', roughCalcContent).forEach(function(el) {
          el.addEventListener('input', updateRoughBid);
          el.addEventListener('change', updateRoughBid);
        });
      }
      var clearRoughCalculatorBtn = $('clearRoughCalculatorBtn');
      if (clearRoughCalculatorBtn) {
        clearRoughCalculatorBtn.addEventListener('click', function() {
          var ids = ['roughLength', 'roughWidth', 'roughSfFromDimensions', 'roughCostPerSqFt', 'roughFixtureCountOverride', 'roughPricePerFixture'];
          ids.forEach(function(id) {
            var el = $(id);
            if (el && el.value !== undefined) el.value = '';
          });
          updateRoughBid();
        });
      }
      setupIncrementDecrement();

      function initializeFixtureMode() {
        var saved = null;
        try {
          saved = localStorage.getItem('bidtoolingFixtureMode');
        } catch (e) {
          saved = null;
        }
        var initialMode = (saved && FIXTURE_MODES[saved]) ? saved : DEFAULT_FIXTURE_MODE;
        setFixtureMode(initialMode, { confirmIfChanged: false });
      }

      document.addEventListener('DOMContentLoaded', function() {
        initializeFixtureMode();
        renderLedgerList();
        restoreFromShareHash();
        if ($('termsAndWarranty') && !$('termsAndWarranty').value.trim()) $('termsAndWarranty').value = TERMS_AND_WARRANTY_DEFAULT;
        if ($('scopeNotes') && !$('scopeNotes').value.trim()) $('scopeNotes').value = EXCLUSIONS_AND_SCOPE_DEFAULT;
        if ($('inclusions') && !$('inclusions').value.trim()) $('inclusions').value = INCLUSIONS_DEFAULT;
      });
    })();
  </script>
</body>
</html>
